{"version":3,"file":"pedigreejs.v3.0.0-rc5.min.js","sources":["../es/pedcache.js","../es/utils.js","../es/zoom.js","../es/pbuttons.js","../es/canrisk_file.js","../es/io.js","../es/twins.js","../es/popup_form.js","../es/widgets.js","../es/labels.js","../es/pedigree.js","../es/extras.js"],"sourcesContent":["/**\n/* © 2023 University of Cambridge\n/* SPDX-FileCopyrightText: 2023 University of Cambridge\n/* SPDX-License-Identifier: GPL-3.0-or-later\n**/\n\n//store a history of pedigree\n\nlet max_limit = 25;\nlet dict_cache = {};\n\n// test if browser storage is supported\nfunction has_browser_storage(opts) {\n\ttry {\n\t\tif(opts.store_type === 'array')\n\t\t\treturn false;\n\n\t\tif(opts.store_type !== 'local' && opts.store_type !== 'session' && opts.store_type !== undefined)\n\t\t\treturn false;\n\n\t\tlet mod = 'test';\n\t\tlocalStorage.setItem(mod, mod);\n\t\tlocalStorage.removeItem(mod);\n\t\treturn true;\n\t} catch(e) {\n\t\treturn false;\n\t}\n}\n\nfunction get_prefix(opts) {\n\treturn \"PEDIGREE_\"+opts.btn_target+\"_\";\n}\n\n// use dict_cache to store cache as an array\nfunction get_arr(opts) {\n\treturn dict_cache[get_prefix(opts)];\n}\n\nfunction get_browser_store(opts, item) {\n\tif(opts.store_type === 'local')\n\t\treturn localStorage.getItem(item);\n\telse\n\t\treturn sessionStorage.getItem(item);\n}\n\nfunction set_browser_store(opts, name, item) {\n\tif(opts.store_type === 'local')\n\t\treturn localStorage.setItem(name, item);\n\telse\n\t\treturn sessionStorage.setItem(name, item);\n}\n\n// clear all storage items\nfunction clear_browser_store(opts) {\n\tif(opts.store_type === 'local')\n\t\treturn localStorage.clear();\n\telse\n\t\treturn sessionStorage.clear();\n}\n\n// remove all storage items with keys that have the pedigree history prefix\nexport function clear_pedigree_data(opts) {\n\tlet prefix = get_prefix(opts);\n\tlet store = (opts.store_type === 'local' ? localStorage : sessionStorage);\n\tlet items = [];\n\tfor(let i = 0; i < store.length; i++){\n\t\tif(store.key(i).indexOf(prefix) === 0)\n\t\t\titems.push(store.key(i));\n\t}\n\tfor(let i = 0; i < items.length; i++)\n\t\tstore.removeItem(items[i]);\n}\n\nexport function get_count(opts) {\n\tlet count;\n\tif (has_browser_storage(opts))\n\t\tcount = get_browser_store(opts, get_prefix(opts)+'COUNT');\n\telse\n\t\tcount = dict_cache[get_prefix(opts)+'COUNT'];\n\tif(count !== null && count !== undefined)\n\t\treturn count;\n\treturn 0;\n}\n\nfunction set_count(opts, count) {\n\tif (has_browser_storage(opts))\n\t\tset_browser_store(opts, get_prefix(opts)+'COUNT', count);\n\telse\n\t\tdict_cache[get_prefix(opts)+'COUNT'] = count;\n}\n\nexport function init_cache(opts) {\n\tif(!opts.dataset)\n\t\treturn;\n\tlet count = get_count(opts);\n\tif (has_browser_storage(opts)) {   // local storage\n\t\tset_browser_store(opts, get_prefix(opts)+count, JSON.stringify(opts.dataset));\n\t} else {   // TODO :: array cache\n\t\tconsole.warn('Local storage not found/supported for this browser!', opts.store_type);\n\t\tmax_limit = 500;\n\t\tif(get_arr(opts) === undefined)\n\t\t\tdict_cache[get_prefix(opts)] = [];\n\t\tget_arr(opts).push(JSON.stringify(opts.dataset));\n\t}\n\tif(count < max_limit)\n\t\tcount++;\n\telse\n\t\tcount = 0;\n\tset_count(opts, count);\n}\n\nexport function nstore(opts) {\n\tif(has_browser_storage(opts)) {\n\t\tfor(let i=max_limit; i>0; i--) {\n\t\t\tif(get_browser_store(opts, get_prefix(opts)+(i-1)) !== null)\n\t\t\t\treturn i;\n\t\t}\n\t} else {\n\t\treturn (get_arr(opts) && get_arr(opts).length > 0 ? get_arr(opts).length : -1);\n\t}\n\treturn -1;\n}\n\nexport function current(opts) {\n\tlet current = get_count(opts)-1;\n\tif(current === -1)\n\t\tcurrent = max_limit;\n\tif(has_browser_storage(opts))\n\t\treturn JSON.parse(get_browser_store(opts, get_prefix(opts)+current));\n\telse if(get_arr(opts))\n\t\treturn JSON.parse(get_arr(opts)[current]);\n}\n\nexport function last(opts) {\n\tif(has_browser_storage(opts)) {\n\t\tfor(let i=max_limit; i>0; i--) {\n\t\t\tlet it = get_browser_store(opts, get_prefix(opts)+(i-1));\n\t\t\tif(it !== null) {\n\t\t\t\tset_count(opts, i);\n\t\t\t\treturn JSON.parse(it);\n\t\t\t}\n\t\t}\n\t} else {\n\t\tlet arr = get_arr(opts);\n\t\tif(arr)\n\t\t\treturn JSON.parse(arr(arr.length-1));\n\t}\n\treturn undefined;\n}\n\nexport function previous(opts, previous) {\n\tif(previous === undefined)\n\t\tprevious = get_count(opts) - 2;\n\n\tif(previous < 0) {\n\t\tlet nst = nstore(opts);\n\t\tif(nst < max_limit)\n\t\t\tprevious = nst - 1;\n\t\telse\n\t\t\tprevious = max_limit - 1;\n\t}\n\tset_count(opts, previous + 1);\n\tif(has_browser_storage(opts))\n\t\treturn JSON.parse(get_browser_store(opts, get_prefix(opts)+previous));\n\telse\n\t\treturn JSON.parse(get_arr(opts)[previous]);\n}\n\nexport function next(opts, next) {\n\tif(next === undefined)\n\t\tnext = get_count(opts);\n\tif(next >= max_limit)\n\t\tnext = 0;\n\n\tset_count(opts, parseInt(next) + 1);\n\tif(has_browser_storage(opts))\n\t\treturn JSON.parse(get_browser_store(opts, get_prefix(opts)+next));\n\telse\n\t\treturn JSON.parse(get_arr(opts)[next]);\n}\n\nexport function clear(opts) {\n\tif(has_browser_storage(opts))\n\t\tclear_browser_store(opts);\n\tdict_cache = {};\n}\n\n// zoom - store translation coords\nexport function setposition(opts, x, y, zoom) {\n\tif(has_browser_storage(opts)) {\n\t\tlet store = (opts.store_type === 'local' ? localStorage : sessionStorage);\n\t\tif(x) {\n\t\t\tset_browser_store(opts, get_prefix(opts)+'_X', x);\n\t\t\tset_browser_store(opts, get_prefix(opts)+'_Y', y);\n\t\t} else {\n\t\t\tstore.removeItem(get_prefix(opts)+'_X');\n\t\t\tstore.removeItem(get_prefix(opts)+'_Y');\n\t\t}\n\n\t\tlet zoomName = get_prefix(opts)+'_ZOOM';\n\t\tif(zoom)\n\t\t\tset_browser_store(opts, zoomName, zoom);\n\t\telse\n\t\t\tstore.removeItem(zoomName);\n\t} else {\n\t\t//TODO\n\t}\n}\n\nexport function getposition(opts) {\n\tif(!has_browser_storage(opts) ||\n\t\t(localStorage.getItem(get_prefix(opts)+'_X') === null &&\n\t\t sessionStorage.getItem(get_prefix(opts)+'_X') === null))\n\t\treturn [null, null];\n\tlet pos = [ parseInt(get_browser_store(opts, get_prefix(opts)+'_X')),\n\t\t\t\tparseInt(get_browser_store(opts, get_prefix(opts)+'_Y')) ];\n\tif(get_browser_store(opts, get_prefix(opts)+'_ZOOM') !== null)\n\t\tpos.push(parseFloat(get_browser_store(opts, get_prefix(opts)+'_ZOOM')));\n\treturn pos;\n}\n","/**\n/* © 2023 University of Cambridge\n/* SPDX-FileCopyrightText: 2023 University of Cambridge\n/* SPDX-License-Identifier: GPL-3.0-or-later\n**/\n\n// Pedigree Tree Utils\nimport * as pedcache from './pedcache.js';\n\n\nexport let roots = {};\n\nexport function isIE() {\n\t let ua = navigator.userAgent;\n\t /* MSIE used to detect old browsers and Trident used to newer ones*/\n\t return ua.indexOf(\"MSIE \") > -1 || ua.indexOf(\"Trident/\") > -1;\n}\n\nexport function isEdge() {\n\t return navigator.userAgent.match(/Edge/g);\n}\n\nexport function create_err(err) {\n\tconsole.error(err);\n\treturn new Error(err);\n}\n\n// validate pedigree data\nexport function validate_pedigree(opts){\n\tif(opts.validate) {\n\t\tif (typeof opts.validate == 'function') {\n\t\t\tif(opts.DEBUG)\n\t\t\t\tconsole.log('CALLING CONFIGURED VALIDATION FUNCTION');\n\t\t\treturn opts.validate.call(this, opts);\n\t\t}\n\n\t\t// check consistency of parents sex\n\t\tlet uniquenames = [];\n\t\tlet famids = [];\n\t\tlet display_name;\n\t\tfor(let p=0; p<opts.dataset.length; p++) {\n\t\t\tif(!p.hidden) {\n\t\t\t\tif(opts.dataset[p].mother || opts.dataset[p].father) {\n\t\t\t\t\tdisplay_name = opts.dataset[p].display_name;\n\t\t\t\t\tif(!display_name)\n\t\t\t\t\t\tdisplay_name = 'unnamed';\n\t\t\t\t\tdisplay_name += ' (IndivID: '+opts.dataset[p].name+')';\n\t\t\t\t\tlet mother = opts.dataset[p].mother;\n\t\t\t\t\tlet father = opts.dataset[p].father;\n\t\t\t\t\tif(!mother || !father) {\n\t\t\t\t\t\tthrow create_err('Missing parent for '+display_name);\n\t\t\t\t\t}\n\n\t\t\t\t\tlet midx = getIdxByName(opts.dataset, mother);\n\t\t\t\t\tlet fidx = getIdxByName(opts.dataset, father);\n\t\t\t\t\tif(midx === -1)\n\t\t\t\t\t\tthrow create_err('The mother (IndivID: '+mother+') of family member '+\n\t\t\t\t\t\t\t\t\t\t display_name+' is missing from the pedigree.');\n\t\t\t\t\tif(fidx === -1)\n\t\t\t\t\t\tthrow create_err('The father (IndivID: '+father+') of family member '+\n\t\t\t\t\t\t\t\t\t\t display_name+' is missing from the pedigree.');\n\t\t\t\t\tif(opts.dataset[midx].sex !== \"F\")\n\t\t\t\t\t\tthrow create_err(\"The mother of family member \"+display_name+\n\t\t\t\t\t\t\t\t\" is not specified as female. All mothers in the pedigree must have sex specified as 'F'.\");\n\t\t\t\t\tif(opts.dataset[fidx].sex !== \"M\")\n\t\t\t\t\t\tthrow create_err(\"The father of family member \"+display_name+\n\t\t\t\t\t\t\t\t\" is not specified as male. All fathers in the pedigree must have sex specified as 'M'.\");\n\t\t\t\t}\n\t\t\t}\n\n\n\t\t\tif(!opts.dataset[p].name)\n\t\t\t\tthrow create_err(display_name+' has no IndivID.');\n\t\t\tif($.inArray(opts.dataset[p].name, uniquenames) > -1)\n\t\t\t\tthrow create_err('IndivID for family member '+display_name+' is not unique.');\n\t\t\tuniquenames.push(opts.dataset[p].name);\n\n\t\t\tif($.inArray(opts.dataset[p].famid, famids) === -1 && opts.dataset[p].famid) {\n\t\t\t\tfamids.push(opts.dataset[p].famid);\n\t\t\t}\n\t\t}\n\n\t\tif(famids.length > 1) {\n\t\t\tthrow create_err('More than one family found: '+famids.join(\", \")+'.');\n\t\t}\n\t\t// warn if there is a break in the pedigree\n\t\tlet uc = unconnected(opts.dataset);\n\t\tif(uc.length > 0)\n\t\t\tconsole.warn(\"individuals unconnected to pedigree \", uc);\n\t}\n}\n\nexport function copy_dataset(dataset) {\n\tif(dataset[0].id) { // sort by id\n\t\tdataset.sort(function(a,b){return (!a.id || !b.id ? 0: (a.id > b.id) ? 1 : ((b.id > a.id) ? -1 : 0));});\n\t}\n\n\tlet disallowed = [\"id\", \"parent_node\"];\n\tlet newdataset = [];\n\tfor(let i=0; i<dataset.length; i++){\n\t\tlet obj = {};\n\t\tfor(let key in dataset[i]) {\n\t\t\tif(disallowed.indexOf(key) === -1)\n\t\t\t\tobj[key] = dataset[i][key];\n\t\t}\n\t\tnewdataset.push(obj);\n\t}\n\treturn newdataset;\n}\n\n// check if the object contains a key with a given prefix\nexport function prefixInObj(prefix, obj) {\n\tlet found = false;\n\tif(obj)\n\t\t$.each(obj, function(k, _n){\n\t\t\tif(k.indexOf(prefix+\"_\") === 0 || k === prefix) {\n\t\t\t\tfound = true;\n\t\t\t\treturn found;\n\t\t\t}\n\t\t});\n\treturn found;\n}\n\n/**\n *  Get formatted time or data & time\n */\nexport function getFormattedDate(time){\n\tlet d = new Date();\n\tif(time)\n\t\treturn ('0' + d.getHours()).slice(-2) + \":\" + ('0' + d.getMinutes()).slice(-2) + \":\" + ('0' + d.getSeconds()).slice(-2);\n\telse\n\t\treturn d.getFullYear() + \"-\" + ('0' + (d.getMonth() + 1)).slice(-2) + \"-\" + ('0' + d.getDate()).slice(-2) + \" \" + ('0' + d.getHours()).slice(-2) + \":\" + ('0' + d.getMinutes()).slice(-2) + \":\" + ('0' + d.getSeconds()).slice(-2);\n }\n\nfunction showDialog(title, msg, onConfirm, opts, dataset) {\n\tconst errModalEl = document.getElementById('errModal');\n\tconst modalTitle = errModalEl.querySelector('.modal-title');\n\tconst modalBodyInput = errModalEl.querySelector('.modal-body');\n\tif(onConfirm) {\n\t\t$('#errModal button.hidden').removeClass(\"hidden\");\n\t\t$('#errModal button:contains(\"OK\")').on( \"click\", function() {\n\t\t\tonConfirm(opts, dataset);\n\t\t\t$('#errModal button:contains(\"OK\")').off('click');\n\t\t});\n\t} else {\n\t\tconst cancelBtn = $('#errModal button:contains(\"CANCEL\")');\n\t\tif(!cancelBtn.hasClass(\"hidden\")) cancelBtn.addClass(\"hidden\");\n\t\t$('#errModal button:contains(\"OK\")').off('click');\n\t}\n\n\tmodalTitle.textContent = title;\n\tmodalBodyInput.textContent = msg;\n\t$(\"#errModal\").modal(\"show\");\n}\n\n/**\n * Show message or confirmation dialog.\n * @param title\t - dialog window title\n * @param msg\t   - message to diasplay\n * @param onConfirm - function to call in a confirmation dialog\n * @param opts\t  - pedigreejs options\n * @param dataset\t- pedigree dataset\n */\nexport function messages(title, msg, onConfirm, opts, dataset) {\n\ttry {\n\t\tif(onConfirm) {\n\t\t\t$('<div id=\"msgDialog\">'+msg+'</div>').dialog({\n\t\t\t\t\tmodal: true,\n\t\t\t\t\ttitle: title,\n\t\t\t\t\twidth: 350,\n\t\t\t\t\tbuttons: {\n\t\t\t\t\t\t\"Yes\": function () {\n\t\t\t\t\t\t\t$(this).dialog('close');\n\t\t\t\t\t\t\tonConfirm(opts, dataset);\n\t\t\t\t\t\t},\n\t\t\t\t\t\t\"No\": function () {\n\t\t\t\t\t\t\t$(this).dialog('close');\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t} else {\n\t\t\t$('<div id=\"msgDialog\">'+msg+'</div>').dialog({\n\t\t\t\ttitle: title,\n\t\t\t\twidth: 350,\n\t\t\t\tbuttons: [{\n\t\t\t\t\ttext: \"OK\",\n\t\t\t\t\tclick: function() { $( this ).dialog( \"close\" );}\n\t\t\t\t}]\n\t\t\t});\n\t\t}\n\t} catch(err) {\n\t\tshowDialog(title, msg, onConfirm, opts, dataset);\n\t}\n}\n\n/**\n * Validate age and yob is consistent with current year. The sum of age and\n * yob should not be greater than or equal to current year. If alive the\n * absolute difference between the sum of age and year of birth and the\n * current year should be <= 1.\n * @param age\t- age in years.\n * @param yob\t- year of birth.\n * @param status - 0 = alive, 1 = dead.\n * @return true if age and yob are consistent with current year otherwise false.\n */\nexport function validate_age_yob(age, yob, status) {\n\tlet year = new Date().getFullYear();\n\tlet sum = parseInt(age) + parseInt(yob);\n\t// check status is an expected string\n\tif (status !== \"1\" && status !== \"0\")\n\t\treturn false\n\n\tif(status === \"1\") {   // deceased\n\t\treturn year >= sum;\n\t}\n\treturn Math.abs(year - sum) <= 1 && year >= sum;\n}\n\nexport function capitaliseFirstLetter(string) {\n\treturn string.charAt(0).toUpperCase() + string.slice(1);\n}\n\n\nexport function makeid(len) {\n\tlet text = \"\";\n\tlet possible = \"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz\";\n\tfor( let i=0; i < len; i++ )\n\t\ttext += possible.charAt(Math.floor(Math.random() * possible.length));\n\treturn text;\n}\n\nexport function buildTree(opts, person, root, partnerLinks, id) {\n\tif (typeof person.children === typeof undefined)\n\t\tperson.children = getChildren(opts.dataset, person);\n\n\tif (typeof partnerLinks === typeof undefined) {\n\t\tpartnerLinks = [];\n\t\tid = 1;\n\t}\n\n\tlet nodes = flatten(root);\n\t//console.log('NAME='+person.name+' NO. CHILDREN='+person.children.length);\n\tlet partners = [];\n\t$.each(person.children, function(_i, child) {\n\t\t$.each(opts.dataset, function(_j, p) {\n\t\t\tif (((child.name === p.mother) || (child.name === p.father)) && child.id === undefined) {\n\t\t\t\tlet m = getNodeByName(nodes, p.mother);\n\t\t\t\tlet f = getNodeByName(nodes, p.father);\n\t\t\t\tm = (m !== undefined? m : getNodeByName(opts.dataset, p.mother));\n\t\t\t\tf = (f !== undefined? f : getNodeByName(opts.dataset, p.father));\n\t\t\t\tif(!contains_parent(partners, m, f))\n\t\t\t\t\tpartners.push({'mother': m, 'father': f});\n\t\t\t}\n\t\t});\n\t});\n\t$.merge(partnerLinks, partners);\n\n\t$.each(partners, function(_i, ptr) {\n\t\tlet mother = ptr.mother;\n\t\tlet father = ptr.father;\n\t\tmother.children = [];\n\t\tlet parent = {\n\t\t\t\tname : makeid(4),\n\t\t\t\thidden : true,\n\t\t\t\tparent : null,\n\t\t\t\tfather : father,\n\t\t\t\tmother : mother,\n\t\t\t\tchildren : getChildren(opts.dataset, mother, father)\n\t\t};\n\n\t\tlet midx = getIdxByName(opts.dataset, mother.name);\n\t\tlet fidx = getIdxByName(opts.dataset, father.name);\n\t\tif(!('id' in father) && !('id' in mother))\n\t\t\tid = setChildrenId(person.children, id);\n\n\t\t// look at grandparents index\n\t\tlet gp = get_grandparents_idx(opts.dataset, midx, fidx);\n\t\tif(gp.fidx < gp.midx) {\n\t\t\tfather.id = id++;\n\t\t\tparent.id = id++;\n\t\t\tmother.id = id++;\n\t\t} else {\n\t\t\tmother.id = id++;\n\t\t\tparent.id = id++;\n\t\t\tfather.id = id++;\n\t\t}\n\t\tid = updateParent(mother, parent, id, nodes, opts);\n\t\tid = updateParent(father, parent, id, nodes, opts);\n\t\tperson.children.push(parent);\n\t});\n\tid = setChildrenId(person.children, id);\n\n\t$.each(person.children, function(_i, p) {\n\t\tid = buildTree(opts, p, root, partnerLinks, id)[1];\n\t});\n\treturn [partnerLinks, id];\n}\n\n\n// update parent node and sort twins\nfunction updateParent(p, parent, id, nodes, opts) {\n\t// add to parent node\n\tif('parent_node' in p)\n\t\tp.parent_node.push(parent);\n\telse\n\t\tp.parent_node = [parent];\n\n\t// check twins lie next to each other\n\tif(p.mztwin || p.dztwins) {\n\t\tlet twins = getTwins(opts.dataset, p);\n\t\tfor(let i=0; i<twins.length; i++) {\n\t\t\tlet twin = getNodeByName(nodes, twins[i].name);\n\t\t\tif(twin)\n\t\t\t\ttwin.id = id++;\n\t\t}\n\t}\n\treturn id;\n}\n\nfunction setChildrenId(children, id) {\n\t// sort twins to lie next to each other\n\tchildren.sort(function(a, b) {\n\t\tif(a.mztwin && b.mztwin && a.mztwin === b.mztwin)\n\t\t\treturn 0;\n\t\telse if(a.dztwin && b.dztwin && a.dztwin === b.dztwin)\n\t\t\treturn 0;\n\t\telse if(a.mztwin || b.mztwin || a.dztwin || b.dztwin)\n\t\t\treturn 1;\n\t\treturn 0;\n\t});\n\n\t$.each(children, function(_i, p) {\n\t\tif(p.id === undefined) p.id = id++;\n\t});\n\treturn id;\n}\n\nexport function isProband(obj) {\n\treturn typeof $(obj).attr('proband') !== typeof undefined && $(obj).attr('proband') !== false;\n}\n\nexport function setProband(dataset, name, is_proband) {\n\t$.each(dataset, function(_i, p) {\n\t\tif (name === p.name)\n\t\t\tp.proband = is_proband;\n\t\telse\n\t\t\tdelete p.proband;\n\t});\n}\n\n//combine arrays ignoring duplicates\nfunction combineArrays(arr1, arr2) {\n\tfor(let i=0; i<arr2.length; i++)\n\t\tif($.inArray( arr2[i], arr1 ) === -1) arr1.push(arr2[i]);\n}\n\nfunction include_children(connected, p, dataset) {\n\tif($.inArray( p.name, connected ) === -1)\n\t\treturn;\n\tcombineArrays(connected, get_partners(dataset, p));\n\tlet children = getAllChildren(dataset, p);\n\t$.each(children, function( _child_idx, child ) {\n\t\tif($.inArray( child.name, connected ) === -1) {\n\t\t\tconnected.push(child.name);\n\t\t\tcombineArrays(connected, get_partners(dataset, child));\n\t\t}\n\t});\n}\n\n//get the partners for a given node\nexport function get_partners(dataset, anode) {\n\tlet ptrs = [];\n\tfor(let i=0; i<dataset.length; i++) {\n\t\tlet bnode = dataset[i];\n\t\tif(anode.name === bnode.mother && $.inArray(bnode.father, ptrs) === -1)\n\t\t\tptrs.push(bnode.father);\n\t\telse if(anode.name === bnode.father && $.inArray(bnode.mother, ptrs) === -1)\n\t\t\tptrs.push(bnode.mother);\n\t}\n\treturn ptrs;\n}\n\n//return a list of individuals that aren't connected to the target\nexport function unconnected(dataset){\n\tlet target = dataset[ getProbandIndex(dataset) ];\n\tif(!target){\n\t\tconsole.warn(\"No target defined\");\n\t\tif(dataset.length === 0) {\n\t\t\tthrow new Error(\"empty pedigree data set\");\n\t\t}\n\t\ttarget = dataset[0];\n\t}\n\tlet connected = [target.name];\n\tlet change = true;\n\tlet ii = 0;\n\twhile(change && ii < 200) {\n\t\tii++;\n\t\tlet nconnect = connected.length;\n\t\t$.each(dataset, function( _idx, p ) {\n\t\t\tif($.inArray( p.name, connected ) !== -1) {\n\t\t\t\t// check if this person or a partner has a parent\n\t\t\t\tlet ptrs = get_partners(dataset, p);\n\t\t\t\tlet has_parent = (p.name === target.name || !p.noparents);\n\t\t\t\tfor(let i=0; i<ptrs.length; i++){\n\t\t\t\t\tif(!getNodeByName(dataset, ptrs[i]).noparents)\n\t\t\t\t\t\thas_parent = true;\n\t\t\t\t}\n\n\t\t\t\tif(has_parent){\n\t\t\t\t\tif(p.mother && $.inArray( p.mother, connected ) === -1)\n\t\t\t\t\t\tconnected.push(p.mother);\n\t\t\t\t\tif(p.father && $.inArray( p.father, connected ) === -1)\n\t\t\t\t\t\tconnected.push(p.father);\n\t\t\t\t}\n\t\t\t} else if( !p.noparents &&\n\t\t\t\t\t  ((p.mother && $.inArray( p.mother, connected ) !== -1) ||\n\t\t\t\t\t   (p.father && $.inArray( p.father, connected ) !== -1))){\n\t\t\t\tconnected.push(p.name);\n\t\t\t}\n\t\t\t// include any children\n\t\t\tinclude_children(connected, p, dataset);\n\t\t});\n\t\tchange = (nconnect !== connected.length);\n\t}\n\tlet names = $.map(dataset, function(val, _i){return val.name;});\n\treturn $.map(names, function(name, _i){return $.inArray(name, connected) === -1 ? name : null;});\n}\n\nexport function getProbandIndex(dataset) {\n\tlet proband;\n\t$.each(dataset, function(i, val) {\n\t\tif (isProband(val)) {\n\t\t\tproband = i;\n\t\t\treturn proband;\n\t\t}\n\t});\n\treturn proband;\n}\n\nexport function getChildren(dataset, mother, father) {\n\tlet children = [];\n\tlet names = [];\n\tif(mother.sex === 'F')\n\t\t$.each(dataset, function(_i, p) {\n\t\t\tif(mother.name === p.mother)\n\t\t\t\tif(!father || father.name === p.father) {\n\t\t\t\t\tif($.inArray(p.name, names) === -1){\n\t\t\t\t\t\tchildren.push(p);\n\t\t\t\t\t\tnames.push(p.name);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t});\n\treturn children;\n}\n\nfunction contains_parent(arr, m, f) {\n\tfor(let i=0; i<arr.length; i++)\n\t\tif(arr[i].mother === m && arr[i].father === f)\n\t\t\treturn true;\n\treturn false;\n}\n\n// get the mono/di-zygotic twin(s)\nexport function getTwins(dataset, person) {\n\tlet sibs = getSiblings(dataset, person);\n\tlet twin_type = (person.mztwin ? \"mztwin\" : \"dztwin\");\n\treturn $.map(sibs, function(p, _i){\n\t\treturn p.name !== person.name && p[twin_type] === person[twin_type] ? p : null;\n\t});\n}\n\n// get the siblings - sex is an optional parameter\n// for only returning brothers or sisters\nexport function getSiblings(dataset, person, sex) {\n\tif(person === undefined || !person.mother || person.noparents)\n\t\treturn [];\n\n\treturn $.map(dataset, function(p, _i){\n\t\treturn  p.name !== person.name && !('noparents' in p) && p.mother &&\n\t\t\t   (p.mother === person.mother && p.father === person.father) &&\n\t\t\t   (!sex || p.sex === sex) ? p : null;\n\t});\n}\n\n// get the siblings + adopted siblings - sex is an optional parameter\n// for only returning brothers or sisters\nexport function getAllSiblings(dataset, person, sex) {\n\treturn $.map(dataset, function(p, _i){\n\t\treturn  p.name !== person.name && !('noparents' in p) && p.mother &&\n\t\t\t   (p.mother === person.mother && p.father === person.father) &&\n\t\t\t   (!sex || p.sex === sex) ? p : null;\n\t});\n}\n\n// get the adopted siblings of a given individual\nexport function getAdoptedSiblings(dataset, person) {\n\treturn $.map(dataset, function(p, _i){\n\t\treturn  p.name !== person.name && 'noparents' in p &&\n\t\t\t   (p.mother === person.mother && p.father === person.father) ? p : null;\n\t});\n}\n\nexport function getAllChildren(dataset, person, sex) {\n\treturn $.map(dataset, function(p, _i){\n\t\treturn !('noparents' in p) &&\n\t\t\t   (p.mother === person.name || p.father === person.name) &&\n\t\t\t   (!sex || p.sex === sex) ? p : null;\n\t});\n}\n\n// get the depth of the given person from the root\nexport function getDepth(dataset, name) {\n\tlet idx = getIdxByName(dataset, name);\n\tlet depth = 1;\n\n\twhile(idx >= 0 && ('mother' in dataset[idx] || dataset[idx].top_level)){\n\t\tidx = getIdxByName(dataset, dataset[idx].mother);\n\t\tdepth++;\n\t}\n\treturn depth;\n}\n\n// given an array of people get an index for a given person\nexport function getIdxByName(arr, name) {\n\tlet idx = -1;\n\t$.each(arr, function(i, p) {\n\t\tif (name === p.name) {\n\t\t\tidx = i;\n\t\t\treturn idx;\n\t\t}\n\t});\n\treturn idx;\n}\n\n// get the nodes at a given depth sorted by their x position\nexport function getNodesAtDepth(fnodes, depth, exclude_names) {\n\treturn $.map(fnodes, function(p, _i){\n\t\treturn p.depth === depth && !p.data.hidden && $.inArray(p.data.name, exclude_names) === -1 ? p : null;\n\t}).sort(function (a,b) {return a.x - b.x;});\n}\n\n// convert the partner names into corresponding tree nodes\nexport function linkNodes(flattenNodes, partners) {\n\tlet links = [];\n\tfor(let i=0; i< partners.length; i++)\n\t\tlinks.push({'mother': getNodeByName(flattenNodes, partners[i].mother.name),\n\t\t\t\t\t'father': getNodeByName(flattenNodes, partners[i].father.name)});\n\treturn links;\n}\n\n// get ancestors of a node\nexport function ancestors(dataset, node) {\n\tlet ancestors = [];\n\tfunction recurse(node) {\n\t\tif(node.data) node = node.data;\n\t\tif('mother' in node && 'father' in node && !('noparents' in node)){\n\t\t\trecurse(getNodeByName(dataset, node.mother));\n\t\t\trecurse(getNodeByName(dataset, node.father));\n\t\t}\n\t\tancestors.push(node);\n\t}\n\trecurse(node);\n\treturn ancestors;\n}\n\n// test if two nodes are consanguinous partners\nexport function consanguity(node1, node2, opts) {\n\tif(node1.depth !== node2.depth) // parents at different depths\n\t\treturn true;\n\tlet ancestors1 = ancestors(opts.dataset, node1);\n\tlet ancestors2 = ancestors(opts.dataset, node2);\n\tlet names1 = $.map(ancestors1, function(ancestor, _i){return ancestor.name;});\n\tlet names2 = $.map(ancestors2, function(ancestor, _i){return ancestor.name;});\n\tlet consanguity = false;\n\t$.each(names1, function( _index, name ) {\n\t\tif($.inArray(name, names2) !== -1){\n\t\t\tconsanguity = true;\n\t\t\treturn false;\n\t\t}\n\t});\n\treturn consanguity;\n}\n\n// return a flattened representation of the tree\nexport function flatten(root) {\n\tlet flat = [];\n\tfunction recurse(node) {\n\t\tif(node.children)\n\t\t\tnode.children.forEach(recurse);\n\t\tflat.push(node);\n\t}\n\trecurse(root);\n\treturn flat;\n}\n\n// Adjust D3 layout positioning.\n// Position hidden parent node centring them between father and mother nodes. Remove kinks\n// from links - e.g. where there is a single child plus a hidden child\nexport function adjust_coords(opts, root, flattenNodes) {\n\tfunction recurse(node) {\n\t\tif (node.children) {\n\t\t\tnode.children.forEach(recurse);\n\n\t\t\tif(node.data.father !== undefined) { \t// hidden nodes\n\t\t\t\tlet father = getNodeByName(flattenNodes, node.data.father.name);\n\t\t\t\tlet mother = getNodeByName(flattenNodes, node.data.mother.name);\n\t\t\t\tlet xmid = (father.x + mother.x) /2;\n\t\t\t\tif(!overlap(opts, root.descendants(), xmid, node.depth, [node.data.name])) {\n\t\t\t\t\tnode.x = xmid;   // centralise parent nodes\n\t\t\t\t\tlet diff = node.x - xmid;\n\t\t\t\t\tif(node.children.length === 2 && (node.children[0].data.hidden || node.children[1].data.hidden)) {\n\t\t\t\t\t\tif(!(node.children[0].data.hidden && node.children[1].data.hidden)) {\n\t\t\t\t\t\t\tlet child1 = (node.children[0].data.hidden ? node.children[1] : node.children[0]);\n\t\t\t\t\t\t\tlet child2 = (node.children[0].data.hidden ? node.children[0] : node.children[1]);\n\t\t\t\t\t\t\tif( ((child1.x < child2.x && xmid < child2.x) || (child1.x > child2.x && xmid > child2.x)) &&\n\t\t\t\t\t\t\t\t!overlap(opts, root.descendants(), xmid, child1.depth, [child1.data.name])){\n\t\t\t\t\t\t\t\tchild1.x = xmid;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t} else if(node.children.length === 1 && !node.children[0].data.hidden) {\n\t\t\t\t\t\tif(!overlap(opts, root.descendants(), xmid, node.children[0].depth, [node.children[0].data.name]))\n\t\t\t\t\t\t\tnode.children[0].x = xmid;\n\t\t\t\t\t} else {\n\t\t\t\t\t\tif(diff !== 0 && !nodesOverlap(opts, node, diff, root)){\n\t\t\t\t\t\t\tif(node.children.length === 1) {\n\t\t\t\t\t\t\t\tnode.children[0].x = xmid;\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\tlet descendants = node.descendants();\n\t\t\t\t\t\t\t\tif(opts.DEBUG)\n\t\t\t\t\t\t\t\t\tconsole.log('ADJUSTING '+node.data.name+' NO. DESCENDANTS '+descendants.length+' diff='+diff);\n\t\t\t\t\t\t\t\tfor(let i=0; i<descendants.length; i++) {\n\t\t\t\t\t\t\t\t\tif(node.data.name !== descendants[i].data.name)\n\t\t\t\t\t\t\t\t\t\tdescendants[i].x -= diff;\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t} else if((node.x < father.x && node.x < mother.x) || (node.x > father.x && node.x > mother.x)){\n\t\t\t\t\t\tnode.x = xmid;   // centralise parent nodes if it doesn't lie between mother and father\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\trecurse(root);\n\trecurse(root);\n}\n\n// test if moving siblings by diff overlaps with other nodes\nfunction nodesOverlap(opts, node, diff, root) {\n\tlet descendants = node.descendants();\n\tlet descendantsNames = $.map(descendants, function(descendant, _i){return descendant.data.name;});\n\tlet nodes = root.descendants();\n\tfor(let i=0; i<descendants.length; i++){\n\t\tlet descendant = descendants[i];\n\t\tif(node.data.name !== descendant.data.name){\n\t\t\tlet xnew = descendant.x - diff;\n\t\t\tif(overlap(opts, nodes, xnew, descendant.depth, descendantsNames))\n\t\t\t\treturn true;\n\t\t}\n\t}\n\treturn false;\n}\n\n// test if x position overlaps a node at the same depth\nexport function overlap(opts, nodes, xnew, depth, exclude_names) {\n\tfor(let n=0; n<nodes.length; n++) {\n\t\tif(depth === nodes[n].depth && $.inArray(nodes[n].data.name, exclude_names) === -1){\n\t\t\tif(Math.abs(xnew - nodes[n].x) < (opts.symbol_size*1.15))\n\t\t\t\treturn true;\n\t\t}\n\t}\n\treturn false;\n}\n\n// given a persons name return the corresponding d3 tree node\nexport function getNodeByName(nodes, name) {\n\tfor (let i = 0; i < nodes.length; i++) {\n\t\tif(nodes[i].data && name === nodes[i].data.name)\n\t\t\treturn nodes[i];\n\t\telse if (name === nodes[i].name)\n\t\t\treturn nodes[i];\n\t}\n}\n\n// given the name of a url param get the value\nexport function urlParam(name){\n\tlet results = new RegExp('[?&]' + name + '=([^&#]*)').exec(window.location.href);\n\tif (results===null)\n\t   return null;\n\telse\n\t   return results[1] || 0;\n}\n\n// get grandparents index\nfunction get_grandparents_idx(dataset, midx, fidx) {\n\tlet gmidx = midx;\n\tlet gfidx = fidx;\n\twhile(  'mother' in dataset[gmidx] && 'mother' in dataset[gfidx] &&\n\t\t  !('noparents' in dataset[gmidx]) && !('noparents' in dataset[gfidx])){\n\t\tgmidx = getIdxByName(dataset, dataset[gmidx].mother);\n\t\tgfidx = getIdxByName(dataset, dataset[gfidx].mother);\n\t}\n\treturn {'midx': gmidx, 'fidx': gfidx};\n}\n\n// check by name if the individual exists\nexport function exists(opts, name){\n\treturn getNodeByName(pedcache.current(opts), name) !== undefined;\n}\n\n// print options and dataset\nexport function print_opts(opts){\n\t$(\"#pedigree_data\").remove();\n\t$(\"body\").append(\"<div id='pedigree_data'></div>\" );\n\tlet key;\n\tfor(let i=0; i<opts.dataset.length; i++) {\n\t\tlet person = \"<div class='row'><strong class='col-md-1 text-right'>\"+opts.dataset[i].name+\"</strong><div class='col-md-11'>\";\n\t\tfor(key in opts.dataset[i]) {\n\t\t\tif(key === 'name') continue;\n\t\t\tif(key === 'parent')\n\t\t\t\tperson += \"<span>\"+key + \":\" + opts.dataset[i][key].name+\"; </span>\";\n\t\t\telse if (key === 'children') {\n\t\t\t\tif (opts.dataset[i][key][0] !== undefined)\n\t\t\t\t\tperson += \"<span>\"+key + \":\" + opts.dataset[i][key][0].name+\"; </span>\";\n\t\t\t} else\n\t\t\t\tperson += \"<span>\"+key + \":\" + opts.dataset[i][key]+\"; </span>\";\n\t\t}\n\t\t$(\"#pedigree_data\").append(person + \"</div></div>\");\n\n\t}\n\t$(\"#pedigree_data\").append(\"<br /><br />\");\n\tfor(key in opts) {\n\t\tif(key === 'dataset') continue;\n\t\t$(\"#pedigree_data\").append(\"<span>\"+key + \":\" + opts[key]+\"; </span>\");\n\t}\n}\n\nexport function is_fullscreen(){\n\treturn (document.fullscreenElement || document.mozFullScreenElement || document.webkitFullscreenElement || document.msFullscreenElement);\n}\n\n\nexport function get_svg_dimensions(opts) {\n\treturn {'width' : (is_fullscreen()? window.innerWidth  : opts.width),\n\t\t\t'height': (is_fullscreen()? window.innerHeight : opts.height)};\n}\n\nexport function get_tree_dimensions(opts) {\n\t// / get score at each depth used to adjust node separation\n\tlet svg_dimensions = get_svg_dimensions(opts);\n\tlet maxscore = 0;\n\tlet generation = {};\n\tfor(let i=0; i<opts.dataset.length; i++) {\n\t\tlet depth = getDepth(opts.dataset, opts.dataset[i].name);\n\t\tlet children = getAllChildren(opts.dataset, opts.dataset[i]);\n\n\t\t// score based on no. of children and if parent defined\n\t\tlet score = 1 + (children.length > 0 ? 0.55+(children.length*0.25) : 0) + (opts.dataset[i].father ? 0.25 : 0);\n\t\tif(depth in generation)\n\t\t\tgeneration[depth] += score;\n\t\telse\n\t\t\tgeneration[depth] = score;\n\n\t\tif(generation[depth] > maxscore)\n\t\t\tmaxscore = generation[depth];\n\t}\n\n\tlet max_depth = Object.keys(generation).length*opts.symbol_size*3.5;\n\tlet tree_width =  (svg_dimensions.width - opts.symbol_size > maxscore*opts.symbol_size*1.65 ?\n\t\t\t\t\t   svg_dimensions.width - opts.symbol_size : maxscore*opts.symbol_size*1.65);\n\tlet tree_height = (svg_dimensions.height - opts.symbol_size > max_depth ?\n\t\t\t\t\t   svg_dimensions.height - opts.symbol_size : max_depth);\n\treturn {'width': tree_width, 'height': tree_height};\n}\n\n","/**\n/* © 2023 University of Cambridge\n/* SPDX-FileCopyrightText: 2023 University of Cambridge\n/* SPDX-License-Identifier: GPL-3.0-or-later\n**/\n\nimport {getposition, setposition} from './pedcache.js';\n\nlet zm;\n\n// initialise zoom and drag\nexport function init_zoom(opts, svg) {\n\t// offsets\n\tlet xi = opts.symbol_size/2;\n\tlet yi = -opts.symbol_size*2.5;\n\n\tzm = d3.zoom()\n\t  .scaleExtent([opts.zoomIn, opts.zoomOut])\n\t  .filter(function(e) {\n\t\t\tif(!opts.zoomSrc || opts.zoomSrc.indexOf('wheel') === -1) {\n\t\t\t\tif(e.type && e.type === 'wheel') return false\n\t\t\t}\n\t\t\t// ignore dblclick & secondary mouse buttons\n\t\t\treturn (e.type !== 'dblclick') && !e.button})\n\t  .on('zoom', function(e) { zooming(e, opts); });\n\tsvg.call(zm);\n\n\t// set initial position & scale\n\tlet xyk = getposition(opts);\t\t// cached position\n\tlet k = (xyk.length === 3 ? xyk[2] : 1);\n\tlet x = (xyk[0] !== null ? xyk[0]/k: (xi*k));\n\tlet y = (xyk[1] !== null ? xyk[1]/k: (yi*k));\n\n\tvar transform = d3.zoomIdentity\n      .scale(k)\n      .translate(x, y);\n    svg.call(zm.transform, transform);\n}\n\n// scale size the pedigree\nexport function btn_zoom(opts, scale) {\n\tlet svg = d3.select(\"#\"+opts.targetDiv).select(\"svg\");\n\tsvg.transition().duration(50).call(zm.scaleBy, scale);\n}\n\nexport function scale_to_fit(opts) {\n\tlet d = get_dimensions(opts);\n\tlet svg = d3.select(\"#\"+opts.targetDiv).select(\"svg\");\n\tlet size = get_svg_size(svg);\n\tlet f = 1;\n\tlet k = (f / Math.max(d.wid/size.w, d.hgt/size.h));\n\n\tif(k < opts.zoomIn) zm.scaleExtent([k, opts.zoomOut]);\n\n\tlet ped = get_pedigree_center(opts);\n\tsvg.call(zm.translateTo, ped.x-(opts.symbol_size), ped.y-(opts.symbol_size));\n\tsetTimeout(function(){svg.transition().duration(700).call(zm.scaleTo, k)}, 400);\n}\n\nfunction zooming(e, opts) {\n\t(opts.DEBUG && console.log(\"zoom\", e.transform));\n\tlet t = e.transform;\n\tlet k = (t.k && t.k !== 1 ? t.k : undefined);\n\tsetposition(opts, t.x, t.y, k);\n\tlet ped = d3.select(\"#\"+opts.targetDiv).select(\".diagram\");\n\tped.attr('transform', 'translate(' + t.x + ',' + t.y + ')' + (k ? ' scale(' + k + ')' : ''));\n}\n\nfunction get_pedigree_center(opts) {\n\tlet b = get_bounds(opts);\n\treturn {x: b.xmin+((b.xmax-b.xmin)/2), y: b.ymin+((b.ymax-b.ymin)/2)};\n}\n\n// find width/height of pedigree graphic\nfunction get_dimensions(opts) {\n\tlet b = get_bounds(opts);\n\treturn {wid: Math.abs(b.xmax-b.xmin), hgt: Math.abs(b.ymax-b.ymin)};\n}\n\n/**\n * Get the min/max boundary of the diagram\n */\nexport function get_bounds(opts) {\n\tlet ped = d3.select(\"#\"+opts.targetDiv).select(\".diagram\");\n\tlet xmin = Number.MAX_VALUE;\n\tlet xmax = -1000000;\n\tlet ymin = Number.MAX_VALUE;\n\tlet ymax = -1000000;\n\tlet sym = opts.symbol_size;\n\tped.selectAll('g').each(function(d, _i) {\n\t\tif(d.x && d.data.name !== 'hidden_root' && !d.data.hidden) {\n\t\t\tlet n = getNodeSize(opts, this, sym);\n\t\t\tif(d.x-sym < xmin) xmin = d.x-sym;\n\t\t\tif(d.x+n.w+sym > xmax) xmax = d.x+n.w+sym;\n\t\t\tif(d.y < ymin) ymin = d.y;\n\t\t\tif(d.y+n.h+sym > ymax) ymax = d.y+n.h+sym;\n\t\t}\n\t});\n\treturn {xmin:xmin, xmax:xmax, ymin:ymin, ymax:ymax};\n}\n\n/**\n * Get the size of an individual's graphical representation\n */\nfunction getNodeSize(opts, g_elm, sym) {\n\tlet node = d3.select(g_elm).node();\n\tlet dg = node.getBBox();\n\tlet w = dg.width;\n\tlet h = dg.height;\n\tif(w === 0 && h === 0) {\t// pedigree not shown yet (family history section not opened)\n\t\ttry {\n\t\t\tw = sym*2;\n\t\t\th = sym*2;\n\t\t\tlet text_elements = d3.select(g_elm).selectAll(\".indi_details\"); // get individuals details\n\t\t\tfor(let i=0; i<text_elements._groups[0].length; i++) {\n\t\t\t\tlet txt = text_elements._groups[0][i].firstChild.nodeValue;\n\t\t\t\tlet txtsize = getTextSize(txt, opts.font_family, opts.font_size);\n\t\n\t\t\t\tw = Math.max(txtsize.w+(sym/2), w);\n\t\t\t\th = Math.max((sym*2)+(i*txtsize.h), h);\n\t\t\t}\n\t\t} catch(err) {\n\t\t\tconsole.error(err);\n\t\t\tw = sym*2;\n\t\t\th = sym*2;\n\t\t}\n\t}\n\treturn {w:w, h:h};\n}\n\n/**\n * Calculate width and height of text\n */\nfunction getTextSize(txt, font, fontSize) {\n\t  let o = $('<div></div>')\n\t            .text(txt)\n\t            .css(\n\t\t\t\t\t{'position': 'absolute',\n\t\t\t\t\t 'float': 'left', 'white-space': 'nowrap', 'visibility': 'hidden',\n\t\t\t\t\t 'font': font || 'Helvetica',\n\t\t\t\t\t 'fontSize': fontSize || '1em'})\n\t            .appendTo($('body'));\n\t  let s = {w: o.width(), h:o.height()};\n\t  o.remove();\n\t  return s;\n}\n\nfunction get_svg_size(svg) {\n\treturn {w: svg.node().clientWidth, h:svg.node().clientHeight};\n}\n","/**\n/* © 2023 University of Cambridge\n/* SPDX-FileCopyrightText: 2023 University of Cambridge\n/* SPDX-License-Identifier: GPL-3.0-or-later\n**/\n\n// undo, redo, reset buttons\nimport * as pedcache from \"./pedcache.js\";\nimport { rebuild, build } from \"./pedigree.js\";\nimport { btn_zoom, scale_to_fit } from \"./zoom.js\";\nimport {\n  copy_dataset,\n  getProbandIndex,\n  is_fullscreen,\n  messages,\n} from \"./utils.js\";\n\nexport function addButtons(options) {\n  let opts = $.extend(\n    {\n      // defaults\n      btn_target: \"pedigree_history\",\n    },\n    options\n  );\n\n  let btns = [\n    { fa: \"fa-file-image\", title: \"download PNG image\" },\n    { fa: \"fa-undo\", title: \"undo\" },\n    { fa: \"fa-redo\", title: \"redo\" },\n    { fa: \"fa-refresh\", title: \"reset\" },\n  ];\n\n  btns.push({ fa: \"fa-crosshairs\", title: \"scale-to-fit\" });\n  if (opts.zoomSrc && opts.zoomSrc.indexOf(\"button\") > -1) {\n    if (opts.zoomOut !== 1)\n      btns.push({ fa: \"fa-minus-circle\", title: \"zoom-out\" });\n    if (opts.zoomIn !== 1)\n      btns.push({ fa: \"fa-plus-circle\", title: \"zoom-in\" });\n  }\n  btns.push({ fa: \"fa-arrows-alt\", title: \"fullscreen\" });\n\n  let lis = \"\";\n  for (let i = 0; i < btns.length; i++) {\n    lis += \"<span>\";\n    lis +=\n      '<i class=\"fa fa-lg ' +\n      btns[i].fa +\n      ' pe-2\" aria-hidden=\"true\" title=\"' +\n      btns[i].title +\n      '\"' +\n      (btns[i].fa === \"fa-arrows-alt\" ? 'id=\"fullscreen\" ' : \"\") +\n      \"></i>\";\n\n    lis += \"</span>\";\n  }\n  $(\"#\" + opts.btn_target).append(lis);\n  addPbuttonEvents(opts);\n}\n\nfunction addPbuttonEvents(opts) {\n  // fullscreen\n  $(document).on(\n    \"webkitfullscreenchange mozfullscreenchange fullscreenchange MSFullscreenChange\",\n    function (_e) {\n      let local_dataset = pedcache.current(opts);\n      if (local_dataset !== undefined && local_dataset !== null) {\n        opts.dataset = local_dataset;\n      }\n      rebuild(opts);\n      setTimeout(function () {\n        scale_to_fit(opts);\n      }, 500);\n    }\n  );\n\n  $(\"#fullscreen\").on(\"click\", function (_e) {\n    // toggle fullscreen\n    if (!is_fullscreen()) {\n      let target = $(\"#\" + opts.targetDiv)[0];\n      if (target.requestFullscreen) {\n        target.requestFullscreen();\n      } else if (document.documentElement.mozRequestFullScreen) {\n        target.mozRequestFullScreen(); // Firefox\n      } else if (document.documentElement.webkitRequestFullscreen) {\n        target.webkitRequestFullscreen(Element.ALLOW_KEYBOARD_INPUT); // Chrome and Safari\n      } else if (document.documentElement.msRequestFullscreen) {\n        target.msRequestFullscreen(); // IE\n      }\n    } else {\n      if (document.exitFullscreen) {\n        document.exitFullscreen();\n      } else if (document.msExitFullscreen) {\n        document.msExitFullscreen();\n      } else if (document.mozCancelFullScreen) {\n        document.mozCancelFullScreen();\n      } else if (document.webkitExitFullscreen) {\n        document.webkitExitFullscreen();\n      }\n    }\n  });\n\n  // press and hold to zoom in/out\n  let timeoutId = 0;\n  function zoomIn() {\n    btn_zoom(opts, 1.05);\n  }\n  function zoomOut() {\n    btn_zoom(opts, 0.95);\n  }\n  $(\".fa-plus-circle, .fa-minus-circle\")\n    .on(\"mousedown\", function () {\n      timeoutId = setInterval(\n        $(this).hasClass(\"fa-plus-circle\") ? zoomIn : zoomOut,\n        50\n      );\n    })\n    .on(\"mouseup mouseleave\", function () {\n      clearInterval(timeoutId);\n    });\n\n  // undo/redo/reset\n  $(\"#\" + opts.btn_target).on(\"click\", function (e) {\n    e.stopPropagation();\n    if ($(e.target).hasClass(\"disabled\")) return false;\n\n    if ($(e.target).hasClass(\"fa-undo\")) {\n      opts.dataset = pedcache.previous(opts);\n      $(\"#\" + opts.targetDiv).empty();\n      build(opts);\n    } else if ($(e.target).hasClass(\"fa-redo\")) {\n      opts.dataset = pedcache.next(opts);\n      $(\"#\" + opts.targetDiv).empty();\n      build(opts);\n    } else if ($(e.target).hasClass(\"fa-refresh\")) {\n      messages(\n        \"Pedigree Reset\",\n        \"This may result in loss of some data. Reset now?\",\n        reset,\n        opts\n      );\n    } else if ($(e.target).hasClass(\"fa-crosshairs\")) {\n      scale_to_fit(opts);\n    } else if ($(e.target).hasClass(\"fa-file-image\")) {\n      return;\n    }\n\n    // trigger fhChange event\n    $(document).trigger(\"fhChange\", [opts]);\n  });\n}\n\n// reset pedigree and clear the history\nfunction reset(opts) {\n  let proband;\n  if (opts.keep_proband_on_reset) {\n    let local_dataset = pedcache.current(opts);\n    let newdataset = copy_dataset(local_dataset);\n    proband = newdataset[getProbandIndex(newdataset)];\n    //let children = pedigree_util.getChildren(newdataset, proband);\n    proband.name = \"ch1\";\n    proband.mother = \"f21\";\n    proband.father = \"m21\";\n    // clear pedigree data but keep proband data and risk factors\n    pedcache.clear_pedigree_data(opts);\n  } else {\n    proband = {\n      name: \"ch1\",\n      sex: \"F\",\n      mother: \"f21\",\n      father: \"m21\",\n      proband: true,\n      status: \"0\",\n      display_name: \"me\",\n    };\n    pedcache.clear(opts); // clear all storage data\n  }\n\n  delete opts.dataset;\n\n  opts.dataset = [\n    {\n      name: \"ch1\",\n      sex: \"F\",\n      mother: \"\",\n      father: \"\",\n      proband: true,\n      status: \"0\",\n      display_name: \"me\",\n    },\n  ];\n\n  //   let selected = $(\"input[name='default_fam']:checked\");\n  //   if (selected.length > 0 && selected.val() === \"extended2\") {\n  //     // secondary relatives\n  //     opts.dataset = [\n  //       {\n  //         name: \"wZA\",\n  //         sex: \"M\",\n  //         top_level: true,\n  //         status: \"0\",\n  //         display_name: \"paternal grandfather\",\n  //       },\n  //       {\n  //         name: \"MAk\",\n  //         sex: \"F\",\n  //         top_level: true,\n  //         status: \"0\",\n  //         display_name: \"paternal grandmother\",\n  //       },\n  //       {\n  //         name: \"zwB\",\n  //         sex: \"M\",\n  //         top_level: true,\n  //         status: \"0\",\n  //         display_name: \"maternal grandfather\",\n  //       },\n  //       {\n  //         name: \"dOH\",\n  //         sex: \"F\",\n  //         top_level: true,\n  //         status: \"0\",\n  //         display_name: \"maternal grandmother\",\n  //       },\n  //       {\n  //         name: \"MKg\",\n  //         sex: \"F\",\n  //         mother: \"MAk\",\n  //         father: \"wZA\",\n  //         status: \"0\",\n  //         display_name: \"paternal aunt\",\n  //       },\n  //       {\n  //         name: \"xsm\",\n  //         sex: \"M\",\n  //         mother: \"MAk\",\n  //         father: \"wZA\",\n  //         status: \"0\",\n  //         display_name: \"paternal uncle\",\n  //       },\n  //       {\n  //         name: \"m21\",\n  //         sex: \"M\",\n  //         mother: \"MAk\",\n  //         father: \"wZA\",\n  //         status: \"0\",\n  //         display_name: \"father\",\n  //       },\n  //       {\n  //         name: \"f21\",\n  //         sex: \"F\",\n  //         mother: \"dOH\",\n  //         father: \"zwB\",\n  //         status: \"0\",\n  //         display_name: \"mother\",\n  //       },\n  //       {\n  //         name: \"aOH\",\n  //         sex: \"F\",\n  //         mother: \"f21\",\n  //         father: \"m21\",\n  //         status: \"0\",\n  //         display_name: \"sister\",\n  //       },\n  //       {\n  //         name: \"Vha\",\n  //         sex: \"M\",\n  //         mother: \"f21\",\n  //         father: \"m21\",\n  //         status: \"0\",\n  //         display_name: \"brother\",\n  //       },\n  //       {\n  //         name: \"Spj\",\n  //         sex: \"M\",\n  //         mother: \"f21\",\n  //         father: \"m21\",\n  //         noparents: true,\n  //         status: \"0\",\n  //         display_name: \"partner\",\n  //       },\n  //       proband,\n  //       {\n  //         name: \"zhk\",\n  //         sex: \"F\",\n  //         mother: \"ch1\",\n  //         father: \"Spj\",\n  //         status: \"0\",\n  //         display_name: \"daughter\",\n  //       },\n  //       {\n  //         name: \"Knx\",\n  //         display_name: \"son\",\n  //         sex: \"M\",\n  //         mother: \"ch1\",\n  //         father: \"Spj\",\n  //         status: \"0\",\n  //       },\n  //       {\n  //         name: \"uuc\",\n  //         display_name: \"maternal aunt\",\n  //         sex: \"F\",\n  //         mother: \"dOH\",\n  //         father: \"zwB\",\n  //         status: \"0\",\n  //       },\n  //       {\n  //         name: \"xIw\",\n  //         display_name: \"maternal uncle\",\n  //         sex: \"M\",\n  //         mother: \"dOH\",\n  //         father: \"zwB\",\n  //         status: \"0\",\n  //       },\n  //     ];\n  //   } else if (selected.length > 0 && selected.val() === \"extended1\") {\n  //     // primary relatives\n  //     opts.dataset = [\n  //       {\n  //         name: \"m21\",\n  //         sex: \"M\",\n  //         mother: null,\n  //         father: null,\n  //         status: \"0\",\n  //         display_name: \"father\",\n  //         noparents: true,\n  //       },\n  //       {\n  //         name: \"f21\",\n  //         sex: \"F\",\n  //         mother: null,\n  //         father: null,\n  //         status: \"0\",\n  //         display_name: \"mother\",\n  //         noparents: true,\n  //       },\n  //       {\n  //         name: \"aOH\",\n  //         sex: \"F\",\n  //         mother: \"f21\",\n  //         father: \"m21\",\n  //         status: \"0\",\n  //         display_name: \"sister\",\n  //       },\n  //       {\n  //         name: \"Vha\",\n  //         sex: \"M\",\n  //         mother: \"f21\",\n  //         father: \"m21\",\n  //         status: \"0\",\n  //         display_name: \"brother\",\n  //       },\n  //       {\n  //         name: \"Spj\",\n  //         sex: \"M\",\n  //         mother: \"f21\",\n  //         father: \"m21\",\n  //         noparents: true,\n  //         status: \"0\",\n  //         display_name: \"partner\",\n  //       },\n  //       proband,\n  //       {\n  //         name: \"zhk\",\n  //         sex: \"F\",\n  //         mother: \"ch1\",\n  //         father: \"Spj\",\n  //         status: \"0\",\n  //         display_name: \"daughter\",\n  //       },\n  //       {\n  //         name: \"Knx\",\n  //         display_name: \"son\",\n  //         sex: \"M\",\n  //         mother: \"ch1\",\n  //         father: \"Spj\",\n  //         status: \"0\",\n  //       },\n  //     ];\n  //   } else {\n  //     opts.dataset = [\n  // { name: \"m21\", display_name: \"father\", sex: \"M\", top_level: true },\n  // { name: \"f21\", display_name: \"mother\", sex: \"F\", top_level: true },\n  // proband,\n  //     ];\n  //   }\n  rebuild(opts);\n}\n\nexport function updateButtons(opts) {\n  let current = pedcache.get_count(opts);\n  let nstore = pedcache.nstore(opts);\n  let id = \"#\" + opts.btn_target;\n  if (nstore <= current) $(id + \" .fa-redo\").addClass(\"disabled\");\n  else $(id + \" .fa-redo\").removeClass(\"disabled\");\n\n  if (current > 1) $(id + \" .fa-undo\").removeClass(\"disabled\");\n  else $(id + \" .fa-undo\").addClass(\"disabled\");\n}\n","/**\n/* © 2023 University of Cambridge\n/* SPDX-FileCopyrightText: 2023 University of Cambridge\n/* SPDX-License-Identifier: GPL-3.0-or-later\n**/\n\nimport * as pedigree_util from './utils.js';\n\n// cancers, genetic & pathology tests\nexport let cancers = {\n\t\t'breast_cancer': 'breast_cancer_diagnosis_age',\n\t\t'breast_cancer2': 'breast_cancer2_diagnosis_age',\n\t\t'ovarian_cancer': 'ovarian_cancer_diagnosis_age',\n\t\t'prostate_cancer': 'prostate_cancer_diagnosis_age',\n\t\t'pancreatic_cancer': 'pancreatic_cancer_diagnosis_age'\n\t};\nexport let genetic_test1 = ['brca1', 'brca2', 'palb2', 'atm', 'chek2', 'rad51d', 'rad51c', 'brip1'];\nexport let genetic_test2 = ['brca1', 'brca2', 'palb2', 'atm', 'chek2', 'bard1', 'rad51d', 'rad51c', 'brip1'];\nexport let genetic_test4 = ['brca1', 'brca2', 'palb2', 'atm', 'chek2', 'bard1', 'rad51d', 'rad51c', 'brip1', 'hoxb13'];\n\nexport let pathology_tests = ['er', 'pr', 'her2', 'ck14', 'ck56'];\n\n// risk factor to storage\nlet RISK_FACTOR_STORE = {};\n\n// get surgical ops and PRS for canrisk header\nexport function get_meta() {\n\tlet meta = get_surgical_ops();\n\tlet prs;\n\ttry {\n\t\tprs = get_prs_values();\n\t\tif(prs.breast_cancer_prs && prs.breast_cancer_prs.alpha !== 0 && prs.breast_cancer_prs.zscore !== 0) {\n\t\t\tmeta += \"\\n##PRS_BC=alpha=\"+prs.breast_cancer_prs.alpha+\",zscore=\"+prs.breast_cancer_prs.zscore;\n\t\t}\n\n\t\tif(prs.ovarian_cancer_prs && prs.ovarian_cancer_prs.alpha !== 0 && prs.ovarian_cancer_prs.zscore !== 0) {\n\t\t\tmeta += \"\\n##PRS_OC=alpha=\"+prs.ovarian_cancer_prs.alpha+\",zscore=\"+prs.ovarian_cancer_prs.zscore;\n\t\t}\n\n\t\tif(prs.prostate_cancer_prs && prs.prostate_cancer_prs.alpha !== 0 && prs.prostate_cancer_prs.zscore !== 0) {\n\t\t\tmeta += \"\\n##PRS_PC=alpha=\"+prs.prostate_cancer_prs.alpha+\",zscore=\"+prs.prostate_cancer_prs.zscore;\n\t\t}\n\t} catch(err) { console.warn(\"PRS\", prs); }\n\treturn meta;\n}\n\n// return a non-anonimised pedigree format\nexport function get_non_anon_pedigree(dataset, meta, version=2, ethnicity=undefined) {\n\treturn get_pedigree(dataset, undefined, meta, false, version, ethnicity);\n}\n\n//check if input has a value\nexport function hasInput(id) {\n\treturn $.trim($('#'+id).val()).length !== 0;\n}\n\n//return true if the object is empty\nlet isEmpty = function(myObj) {\n\tfor(let key in myObj) {\n\t\tif (Object.prototype.hasOwnProperty.call(myObj, key)) {\n\t\t\treturn false;\n\t\t}\n\t}\n\treturn true;\n}\n\n//get breast and ovarian PRS values\nexport function get_prs_values() {\n\tlet prs = {};\n\tif(hasInput(\"breast_prs_a\") && hasInput(\"breast_prs_z\")) {\n\t\tprs['breast_cancer_prs'] = {\n\t\t\t'alpha': parseFloat($('#breast_prs_a').val()),\n\t\t\t'zscore': parseFloat($('#breast_prs_z').val()),\n\t\t\t'percent': parseFloat($('#breast_prs_percent').val())\n\t\t};\n\t}\n\tif(hasInput(\"ovarian_prs_a\") && hasInput(\"ovarian_prs_z\")) {\n\t\tprs['ovarian_cancer_prs'] = {\n\t\t\t'alpha': parseFloat($('#ovarian_prs_a').val()),\n\t\t\t'zscore': parseFloat($('#ovarian_prs_z').val()),\n\t\t\t'percent': parseFloat($('#ovarian_prs_percent').val())\n\t\t};\n\t}\n\tif(hasInput(\"prostate_prs_a\") && hasInput(\"prostate_prs_z\")) {\n\t\tprs['prostate_cancer_prs'] = {\n\t\t\t'alpha': parseFloat($('#prostate_prs_a').val()),\n\t\t\t'zscore': parseFloat($('#prostate_prs_z').val()),\n\t\t\t'percent': parseFloat($('#prostate_prs_percent').val())\n\t\t};\n\t}\n\tconsole.log(prs);\n\treturn (isEmpty(prs) ? 0 : prs);\n}\n\nfunction get_surgical_ops() {\n\tlet meta = \"\";\n\tif(!$('#A6_4_3_check').parent().hasClass(\"off\")) {\n\t\tmeta += \";OVARY2=y\";\n\t}\n\tif(!$('#A6_4_7_check').parent().hasClass(\"off\")) {\n\t\tmeta += \";MAST2=y\";\n\t}\n\treturn meta;\n}\n\n/**\n * Get genetic test genes based on CanRisk version\n */\nfunction getGeneticTest(version) {\n\tversion = parseInt(version);\n\tif(version === 1)\n\t\treturn genetic_test1;\n\telse if(version === 2)\n\t\treturn genetic_test2;\n\telse if(version === 3)\n\t\treturn genetic_test2;\n\treturn genetic_test4;\n}\n\nexport function readCanRisk(boadicea_lines) {\n\tlet lines = boadicea_lines.trim().split('\\n');\n\tlet ped = [];\n\tlet hdr = [];  // collect risk factor header lines\n\tconst regexp = /([0-9])/;\n\tlet version = 3;\n\tlet gt = getGeneticTest(version);\n\tlet ncol = [26, 27, 27, 28];\t// number of columns - v1, v2, v3, v4\n\t// assumes two line header\n\tfor(let i = 0;i < lines.length;i++){\n\t\tlet ln = lines[i].trim();\n\t\tif(ln.indexOf(\"##\") === 0) {\n\t\t\tif(ln.indexOf(\"##CanRisk\") === 0) {\n\t\t\t\tconst match = ln.match(regexp);\n\t\t\t\tversion = parseInt(match[1]);\n\t\t\t\tgt = getGeneticTest(version);\n\t\t\t\tconsole.log(\"CanRisk File Format version \"+version);\n\n\t\t\t\tif(ln.indexOf(\";\") > -1) {   // contains surgical op data\n\t\t\t\t\tlet ops = ln.split(\";\");\n\t\t\t\t\tfor(let j=1; j<ops.length; j++) {\n\t\t\t\t\t\tlet opdata = ops[j].split(\"=\");\n\t\t\t\t\t\tif(opdata.length === 2) {\n\t\t\t\t\t\t\thdr.push(ops[j]);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t\tif(ln.indexOf(\"CanRisk\") === -1 && ln.indexOf(\"##FamID\") !== 0) {\n\t\t\t\thdr.push(ln.replace(\"##\", \"\"));\n\t\t\t}\n\t\t\tcontinue;\n\t\t}\n\n\t\tlet delim = /\\t/;\n\t\tif(ln.indexOf('\\t') < 0) {\n\t\t\tdelim = /\\s+/;\n\t\t\tconsole.log(\"NOT TAB DELIM\");\n\t\t}\n\t\tlet attr = $.map(ln.split(delim), function(val, _i){return val.trim();});\n\n\t\tif(attr.length > 1) {\n\t\t\tif(attr.length !== ncol[version-1]) {\n\t\t\t\tconsole.error(ln, attr);\n\t\t\t\tthrow new Error('Found number of columns '+attr.length+'; expected '+ncol[version-1]+' for CanRisk version '+version);\n\t\t\t}\n\t\t\tlet indi = {\n\t\t\t\t'famid': attr[0],\n\t\t\t\t'display_name': attr[1],\n\t\t\t\t'name':\tattr[3],\n\t\t\t\t'sex': attr[6],\n\t\t\t\t'status': attr[8]\n\t\t\t};\n\t\t\tif(attr[2] === \"1\") indi.proband = true;\n\t\t\tif(attr[4] !== \"0\") indi.father = attr[4];\n\t\t\tif(attr[5] !== \"0\") indi.mother = attr[5];\n\t\t\tif(attr[7] !== \"0\") indi.mztwin = attr[7];\n\t\t\tif(attr[9] !== \"0\") indi.age = attr[9];\n\t\t\tif(attr[10] !== \"0\") indi.yob = attr[10];\n\n\t\t\tlet idx = 11;\n\t\t\t$.each(cancers, function(cancer, diagnosis_age) {\n\t\t\t\t// Age at 1st cancer or 0 = unaffected, AU = unknown age at diagnosis (affected unknown)\n\t\t\t\tif(attr[idx] !== \"0\") {\n\t\t\t\t\tindi[diagnosis_age] = attr[idx];\n\t\t\t\t}\n\t\t\t\tidx++;\n\t\t\t});\n\n\t\t\tif(attr[idx++] !== \"0\") indi.ashkenazi = 1;\n\t\t\t// BRCA1, BRCA2, PALB2, ATM, CHEK2, .... genetic tests\n\t\t\t// genetic test type, 0 = untested, S = mutation search, T = direct gene test\n\t\t\t// genetic test result, 0 = untested, P = positive, N = negative\n\t\t\tfor(let j=0; j<gt.length; j++) {\n\t\t\t\tlet gene_test = attr[idx].split(\":\");\n\t\t\t\tif(gene_test[0] !== '0') {\n\t\t\t\t\tif((gene_test[0] === 'S' || gene_test[0] === 'T') && (gene_test[1] === 'P' || gene_test[1] === 'N'))\n\t\t\t\t\t\tindi[gt[j] + '_gene_test'] = {'type': gene_test[0], 'result': gene_test[1]};\n\t\t\t\t\telse\n\t\t\t\t\t\tconsole.warn('UNRECOGNISED GENE TEST ON LINE '+ (i+1) + \": \" + gene_test[0] + \" \" + gene_test[1]);\n\t\t\t\t} else {\n\t\t\t\t\tif(gene_test[1] === 'P' || gene_test[1] === 'N')\n\t\t\t\t\t\tindi[gt[j] + '_gene_test'] = {'type': gene_test[0], 'result': gene_test[1]};\n\t\t\t\t}\n\t\t\t\tidx++;\n\t\t\t}\n\t\t\t// status, 0 = unspecified, N = negative, P = positive\n\t\t\tlet path_test = attr[idx].split(\":\");\n\t\t\tfor(let j=0; j<path_test.length; j++) {\n\t\t\t\tif(path_test[j] !== '0') {\n\t\t\t\t\tif(path_test[j] === 'N' || path_test[j] === 'P')\n\t\t\t\t\t\tindi[pathology_tests[j] + '_bc_pathology'] = path_test[j];\n\t\t\t\t\telse\n\t\t\t\t\t\tconsole.warn('UNRECOGNISED PATHOLOGY ON LINE '+ (i+1) + \": \" +pathology_tests[j] + \" \" +path_test[j]);\n\t\t\t\t}\n\t\t\t}\n\t\t\tped.unshift(indi);\n\t\t}\n\t}\n\n\t// group mztwins\n\tped.sort(function(a, b) {\n\t\treturn a.mztwin !== undefined ? a.mztwin.localeCompare(b.mztwin) : 0;\n\t});\n\n\treturn [hdr, ped];\n}\n\n/**\n * Get the mammographic density formatted CanRisk data file line\n */\nexport function get_mdensity(mdensity) {\n\tconst regexp = /^(birads|Volpara|Stratus)=/i;\n\tif(regexp.test(mdensity))\n\t\treturn \"\\n##\"+mdensity;\n\t\t\n\tconst birads = /^(1|2|3|4|a|b|c|d)$/i\n\tif(birads.test(mdensity))\n\t\treturn \"\\n##birads=\"+mdensity;\n\n\tconsole.error(\"Unrecognised mammographic density format :: \" + mdensity);\n\treturn \"\"\n}\n\n/**\n * Get CanRisk formated pedigree.\n */\nexport function get_pedigree(dataset, famid, meta, isanon, version=3, ethnicity=undefined) {\n\tlet v = (Number.isInteger(version) ? version+\".0\" : version.toString());\n\tlet msg = \"##CanRisk \" + v;\n\tif(!famid) {\n\t\tfamid = \"XXXX\";\n\t}\n\tif(meta) {\n\t\tmsg += meta;\n\t}\n\tif(typeof isanon === 'undefined') {\n\t\tisanon = true;\n\t}\n\t// array of individuals excluded from the calculation\n\tlet excl = $.map(dataset, function(p, _i){return 'exclude' in p && p.exclude ? p.name : null;});\n\n\t// female risk factors\n\tlet probandIdx  = pedigree_util.getProbandIndex(dataset);\n\tlet sex = 'F';\n\tif(probandIdx) {\n\t\tsex = dataset[probandIdx].sex;\n\t}\n\n\tif(sex !== 'M') {\n\t\tlet menarche    = get_risk_factor('menarche_age');\n\t\tlet parity      = get_risk_factor('parity');\n\t\tlet first_birth = get_risk_factor('age_of_first_live_birth');\n\t\tlet oc_use      = get_risk_factor('oral_contraception');\n\t\tlet mht_use     = get_risk_factor('mht');\n\t\tlet bmi         = get_risk_factor('bmi');\n\t\tlet alcohol     = get_risk_factor('alcohol_intake');\n\t\tlet menopause   = get_risk_factor('age_of_menopause');\n\t\tlet mdensity    = get_risk_factor('mammographic_density');\n\t\tlet hgt         = get_risk_factor('height');\n\t\tlet tl          = get_risk_factor('Age_Tubal_ligation');\n\t\tlet endo        = get_risk_factor('endometriosis');\n\n\t\tif(menarche !== undefined)\n\t\t\tmsg += \"\\n##menarche=\"+menarche;\n\t\tif(parity !== undefined)\n\t\t\tmsg += \"\\n##parity=\"+parity;\n\t\tif(first_birth !== undefined)\n\t\t\tmsg += \"\\n##first_live_birth=\"+first_birth;\n\t\tif(oc_use !== undefined)\n\t\t\tmsg += \"\\n##oc_use=\"+oc_use;\n\t\tif(mht_use !== undefined)\n\t\t\tmsg += \"\\n##mht_use=\"+mht_use;\n\t\tif(bmi !== undefined)\n\t\t\tmsg += \"\\n##BMI=\"+bmi;\n\t\tif(alcohol !== undefined)\n\t\t\tmsg += \"\\n##alcohol=\"+alcohol;\n\t\tif(menopause !== undefined)\n\t\t\tmsg += \"\\n##menopause=\"+menopause;\n\t\tif(mdensity !== undefined)\n\t\t\tmsg += get_mdensity(mdensity);\n\t\tif(hgt !== undefined)\n\t\t\tmsg += \"\\n##height=\"+hgt;\n\t\tif(tl !== undefined)\n\t\t\tif(tl !== \"n\" && tl !== \"N\")\n\t\t\t\tmsg += \"\\n##TL=Y\";\n\t\t\telse\n\t\t\t\tmsg += \"\\n##TL=N\";\n\n\t\tif(endo !== undefined)\n\t\t\tmsg += \"\\n##endo=\"+endo;\n\t}\n\t\n\tif(version > 2 && ethnicity !== undefined) {\n\t\tmsg += \"\\n##ethnicity=\"+ethnicity;\n\t}\n\tmsg += \"\\n##FamID\\tName\\tTarget\\tIndivID\\tFathID\\tMothID\\tSex\\tMZtwin\\tDead\\tAge\\tYob\\tBC1\\tBC2\\tOC\\tPRO\\tPAN\\tAshkn\"\n\n\tlet gt = getGeneticTest(version);\n\tfor(let i=0; i<gt.length; i++) {\n\t\tmsg += \"\\t\"+gt[i].toUpperCase();\n\t}\n\tmsg += \"\\tER:PR:HER2:CK14:CK56\";\n\n\tfor(let i=0; i<dataset.length; i++) {\n\t\tlet p = dataset[i];\n\t\tif($.inArray(p.name, excl) !== -1) {\n\t\t\tconsole.log('EXCLUDE: '+p.name);\n\t\t\tcontinue;\n\t\t}\n\n\t\tmsg += '\\n'+famid+'\\t';\t\t\t\t\t\t\t\t\t\t\t\t// max 13 chars\n\t\tif(isanon)\n\t\t\tmsg += i+'\\t';\t\t\t\t\t\t\t\t\t\t\t\t\t// display_name (ANONIMISE) max 8 chars\n\t\telse\n\t\t\tmsg += (p.display_name ? p.display_name : \"NA\")+'\\t';\n\t\tmsg += ('proband' in p ? '1' : 0)+'\\t';\n\t\tmsg += p.name+'\\t';\t\t\t\t\t\t\t\t\t\t\t\t\t// max 7 chars\n\t\tmsg += ('father' in p && !('noparents' in p) && ($.inArray(p.mother, excl) === -1)? p.father : 0)+'\\t';\t// max 7 chars\n\t\tmsg += ('mother' in p && !('noparents' in p) && ($.inArray(p.mother, excl) === -1)? p.mother : 0)+'\\t';\t// max 7 chars\n\t\tmsg += p.sex+'\\t';\n\t\tmsg += ('mztwin' in p ? p.mztwin : 0)+'\\t'; \t\t\t\t\t\t// MZtwin\n\t\tmsg += ('status' in p ? p.status : 0)+'\\t';\t\t\t\t\t\t\t// current status: 0 = alive, 1 = dead\n\t\tmsg += ('age' in p ? p.age : 0)+'\\t';\t\t\t\t\t\t\t\t// Age at last follow up or 0 = unspecified\n\t\tmsg += ('yob' in p ? p.yob : 0)+'\\t';\t\t\t\t\t\t\t\t// YOB or 0 = unspecified\n\n\t\tlet cmsg = \"\";\n\t\t$.each(cancers, function(cancer, diagnosis_age) {\n\t\t\t// Age at 1st cancer or 0 = unaffected, AU = unknown age at diagnosis (affected unknown)\n\t\t\tif(diagnosis_age in p)\n\t\t\t\tcmsg += (diagnosis_age in p ? p[diagnosis_age] : 'AU')+'\\t';\n\t\t\telse\n\t\t\t\tcmsg += '0\\t';\n\t\t});\n\t\tmsg+=cmsg;\n\n\t\t// Ashkenazi status, 0 = not Ashkenazi, 1 = Ashkenazi\n\t\tmsg += ('ashkenazi' in p ? p.ashkenazi : 0)+'\\t';\n\n\t\tfor(let j=0; j<gt.length; j++) {\n\t\t\tif(gt[j]+'_gene_test' in p &&\n\t\t\t   p[gt[j]+'_gene_test']['type'] !== '-' &&\n\t\t\t   p[gt[j]+'_gene_test']['result'] !== '-') {\n\t\t\t\tmsg += p[gt[j]+'_gene_test']['type'] + ':';\n\t\t\t\tmsg += p[gt[j]+'_gene_test']['result'] + '\\t';\n\t\t\t} else {\n\t\t\t\tmsg += '0:0\\t';\t\t// type, 0=untested, S=mutation search, T=direct gene test\n\t\t\t\t\t\t\t\t\t// result, 0=untested, P=positive, N=negative\n\t\t\t}\n\t\t}\n\n\t\tfor(let j=0; j<pathology_tests.length; j++) {\n\t\t\t// status, 0 = unspecified, N = negative, P = positive\n\t\t\tif(pathology_tests[j]+'_bc_pathology' in p) {\n\t\t\t\tmsg += p[pathology_tests[j]+'_bc_pathology'];\n\t\t\t\tconsole.log('pathology '+p[pathology_tests[j]+'_bc_pathology']+' for '+p.display_name);\n\t\t\t} else {\n\t\t\t\tmsg += '0';\n\t\t\t}\n\t\t\tif(j<(pathology_tests.length-1))\n\t\t\t\tmsg += \":\";\n\t\t}\n\t}\n\tconsole.log(msg, RISK_FACTOR_STORE);\n\treturn msg;\n}\n\nexport function show_risk_factor_store() {\n\tconsole.log(\"RISK_FACTOR_STORE::\");\n\t$.each(RISK_FACTOR_STORE, function(name, val){\n\t\tconsole.log(name + \" : \" + val);\n\t});\n}\n\nexport function save_risk_factor(risk_factor_name, val) {\n\tRISK_FACTOR_STORE[store_name(risk_factor_name)] = val;\n}\n\nexport function get_risk_factor(risk_factor_name) {\n\tlet key = store_name(risk_factor_name);\n\tif(key in RISK_FACTOR_STORE) {\n\t\treturn RISK_FACTOR_STORE[key];\n\t}\n\treturn undefined;\n}\n\n// remove risk factor from storage\nexport function remove_risk_factor(risk_factor_name) {\n\tdelete RISK_FACTOR_STORE[store_name(risk_factor_name)];\n}\n\n// prefix risk factor name with the app/page name\nexport function store_name(risk_factor_name) {\n\treturn window.location.pathname.split('/').filter(function(el){ return !!el; }).pop() +\n\t       '::' + risk_factor_name;\n}\n","/**\n/* © 2023 University of Cambridge\n/* SPDX-FileCopyrightText: 2023 University of Cambridge\n/* SPDX-License-Identifier: GPL-3.0-or-later\n**/\n\n// pedigree I/O\nimport * as utils from \"./utils.js\";\nimport * as pedcache from \"./pedcache.js\";\nimport { rebuild } from \"./pedigree.js\";\nimport {\n  readCanRisk,\n  cancers,\n  genetic_test1,\n  pathology_tests,\n} from \"./canrisk_file.js\";\nimport { get_bounds } from \"./zoom.js\";\n\nexport function addIO(opts) {\n  $(\"#load\").change(function (e) {\n    load(e, opts);\n  });\n\n  $(\"#save\").click(function (_e) {\n    save(opts);\n  });\n\n  $(\"#print\").click(function (_e) {\n    print(get_printable_svg(opts));\n  });\n\n  $(\"#svg_download\").click(function (_e) {\n    svg_download(get_printable_svg(opts));\n  });\n\n  $(\"#png_download, .fa-file-image\").click(function (_e) {\n    let resolution = 1;\n    img_download(opts, resolution, \"image/png\");\n  });\n}\n\n/**\n * Get object from array by the name attribute.\n */\nfunction getByName(arr, name) {\n  return $.grep(arr, function (o) {\n    return o && o.name === name;\n  })[0];\n}\n\n/**\n * Provide font style to svg\n */\nfunction copyStylesInline(destinationNode, sourceNode) {\n  let containerElements = [\"svg\", \"g\"];\n  for (let cd = 0; cd < destinationNode.childNodes.length; cd++) {\n    let child = destinationNode.childNodes[cd];\n    if (containerElements.indexOf(child.tagName) !== -1) {\n      copyStylesInline(child, sourceNode.childNodes[cd]);\n      continue;\n    }\n    try {\n      let style =\n        sourceNode.childNodes[cd].currentStyle ||\n        window.getComputedStyle(sourceNode.childNodes[cd]);\n      if (style === \"undefined\" || style === null) continue;\n\n      for (let st = 0; st < style.length; st++) {\n        if (style[st].indexOf(\"text\") > -1 || style[st].indexOf(\"font\") > -1)\n          child.style.setProperty(style[st], style.getPropertyValue(style[st]));\n      }\n    } catch (err) {\n      continue;\n    }\n  }\n}\n\n/**\n * Export pedigree as image, e.g. PNG\n */\nexport function img_download(opts, resolution, img_type) {\n  return new Promise((resolve, reject) => {\n    let deferred = svg2img($(\"#\" + opts.targetDiv).find(\"svg\"), \"pedigree\", {\n      resolution: resolution,\n      img_type: img_type,\n    });\n\n    $.when.apply($, [deferred]).done(function () {\n      let obj = getByName(arguments, \"pedigree\");\n      \n      // Check if obj.img is a valid blob URL\n      if (obj.img.startsWith('blob:')) {\n        // Create a temporary link to download the image\n        let a = document.createElement(\"a\");\n        a.href = obj.img;  // Blob URL is valid in this context\n        a.download = \"plot.png\";\n        document.body.appendChild(a);\n        a.click();\n        document.body.removeChild(a);\n      } else {\n        // If it's not a blob URL, handle it as an HTTP/HTTPS URL or base64 data URL\n        // Assuming obj.img is a valid image URL or data URL here\n        let a = document.createElement(\"a\");\n        a.href = obj.img;  // Use the valid image URL\n        a.download = \"plot.png\";\n        document.body.appendChild(a);\n        a.click();\n        document.body.removeChild(a);\n      }\n      resolve(\"plot.png\")\n    });\n  });\n}\n\n\n/**\n * Given a SVG document element convert to image (e.g. jpeg, png - default png).\n */\nexport function svg2img(svg, deferred_name, options) {\n  let defaults = { iscanvg: false, resolution: 1, img_type: \"image/png\" };\n  if (!options) options = defaults;\n  $.each(defaults, function (key, value) {\n    if (!(key in options)) {\n      options[key] = value;\n    }\n  });\n\n  let copy = svg.get(0).cloneNode(true);\n  copyStylesInline(copy, svg.get(0));\n  let deferred = $.Deferred();\n  let svgStr = new XMLSerializer().serializeToString(copy);\n\n  let imgsrc =\n    \"data:image/svg+xml;base64,\" +\n    window.btoa(unescape(encodeURIComponent(svgStr))); // convert SVG string to data URL\n  let canvas = document.createElement(\"canvas\");\n  canvas.width = svg.width() * options.resolution;\n  canvas.height = svg.height() * options.resolution;\n  let context = canvas.getContext(\"2d\");\n  // provide a white background\n  context.fillStyle = \"white\";\n  context.fillRect(0, 0, canvas.width, canvas.height);\n\n  let img = document.createElement(\"img\");\n  img.onload = function () {\n    context.drawImage(img, 0, 0, canvas.width, canvas.height);\n    console.log(deferred_name, options.img_type);\n    deferred.resolve({\n      name: deferred_name,\n      resolution: options.resolution,\n      img: canvas.toDataURL(options.img_type, 1),\n      w: canvas.width,\n      h: canvas.height,\n    });\n    context.clearRect(0, 0, canvas.width, canvas.height);\n  };\n  img.src = imgsrc;\n  return deferred.promise();\n}\n\n/** TODO ::: test the following\nexport function svg2imgA(svgJQ, deferred_name, options) {\n\tlet defaults = {iscanvg: false, resolution: 1, img_type: \"image/png\"};\n\tif(!options) options = defaults;\n\t$.each(defaults, function(key, value) {\n\t\tif(!(key in options)) {options[key] = value;}\n\t});\n\n\tlet svg = svgJQ.get(0);\n\tlet deferred = $.Deferred();\n  \tvar copy = svg.cloneNode(true);\n\tcopyStylesInline(copy, svg);\n\tvar canvas = document.createElement(\"canvas\");\n\tcanvas.width = svgJQ.width()*options.resolution;\n\tcanvas.height = svgJQ.height()*options.resolution;\n\tvar context = canvas.getContext(\"2d\");\n\tvar data = (new XMLSerializer()).serializeToString(copy);\n\tvar DOMURL = window.URL || window.webkitURL || window;\n\tvar img = new Image();\n\tvar svgBlob = new Blob([data], {type: \"image/svg+xml;charset=utf-8\"});\n\tvar url = DOMURL.createObjectURL(svgBlob);\n\timg.onload = function () {\n\t\tcontext.drawImage(img, 0, 0, canvas.width, canvas.height);\n\t\tconsole.log(deferred_name, options.img_type);\n\t\tdeferred.resolve(\n\t\t\t{'name': deferred_name,\n\t\t\t'resolution': options.resolution,\n\t\t\t'img':canvas.toDataURL(options.img_type, 1),\n\t\t\t'w':canvas.width,\n\t\t\t'h':canvas.height})\n\t};\n\timg.src = url;\n\treturn deferred.promise();\n}\n */\n\nfunction getMatches(str, myRegexp) {\n  let matches = [];\n  let c = 0;\n  myRegexp.lastIndex = 0;\n  let match = myRegexp.exec(str);\n  while (match) {\n    c++;\n    if (c > 400) {\n      console.error(\"getMatches: counter exceeded 800\");\n      return -1;\n    }\n    matches.push(match);\n    if (myRegexp.lastIndex === match.index) {\n      myRegexp.lastIndex++;\n    }\n    match = myRegexp.exec(str);\n  }\n  return matches;\n}\n\n// find all url's to make unique\nfunction unique_urls(svg_html) {\n  let matches = getMatches(\n    svg_html,\n    /url\\((&quot;|\"|'){0,1}#(.*?)(&quot;|\"|'){0,1}\\)/g\n  );\n  if (matches === -1) return \"ERROR DISPLAYING PEDIGREE\";\n\n  $.each(matches, function (_index, match) {\n    let quote = match[1] ? match[1] : \"\";\n    let val = match[2];\n    let m1 = 'id=\"' + val + '\"';\n    let m2 = \"url\\\\(\" + quote + \"#\" + val + quote + \"\\\\)\";\n\n    let newval = val + utils.makeid(2);\n    svg_html = svg_html.replace(new RegExp(m1, \"g\"), 'id=\"' + newval + '\"');\n    svg_html = svg_html.replace(new RegExp(m2, \"g\"), \"url(#\" + newval + \")\");\n  });\n  return svg_html;\n}\n\n// return a copy pedigree svg\nexport function copy_svg(opts) {\n  let svg_node = get_printable_svg(opts);\n  let d3obj = d3.select(svg_node.get(0));\n\n  // remove unused elements\n  d3obj\n    .selectAll(\n      \".popup_selection, .indi_rect, .addsibling, .addpartner, .addchild, .addparents, .delete, .line_drag_selection\"\n    )\n    .remove();\n  d3obj\n    .selectAll(\"text\")\n    .filter(function () {\n      return d3.select(this).text().length === 0;\n    })\n    .remove();\n  return $(unique_urls(svg_node.html()));\n}\n\n// get printable svg div, adjust size to tree dimensions and scale to fit\nfunction get_printable_svg(opts) {\n  let local_dataset = pedcache.current(opts); // get current dataset\n  if (local_dataset !== undefined && local_dataset !== null) {\n    opts.dataset = local_dataset;\n  }\n\n  let svg_div = $(\"<div></div>\"); // create a new div\n  let svg = $(\"#\" + opts.targetDiv)\n    .find(\"svg\")\n    .clone()\n    .appendTo(svg_div);\n\n  let a4 = { w: 595 - 40, h: 842 - 50 };\n\n  let b = get_bounds(opts);\n  let d = { w: Math.abs(b.xmax - b.xmin), h: Math.abs(b.ymax - b.ymin) };\n  let f = 1;\n  let k = f / Math.max(d.w / a4.w, d.h / a4.h);\n\n  let xi = -(b.xmin - opts.symbol_size) * k;\n  let yi = -(b.ymin - opts.symbol_size) * k;\n\n  svg.attr(\"width\", a4.w);\n  svg.attr(\"height\", d.h * k);\n\n  svg\n    .find(\".diagram\")\n    .attr(\"transform\", \"translate(\" + xi + \", \" + yi + \") scale(\" + k + \")\");\n  return svg_div;\n}\n\n// download the SVG to a file\nexport function svg_download(svg) {\n  let a = document.createElement(\"a\");\n  a.href =\n    \"data:image/svg+xml;base64,\" +\n    btoa(unescape(encodeURIComponent(svg.html())));\n  a.download = \"plot.svg\";\n  a.target = \"_blank\";\n  document.body.appendChild(a);\n  a.click();\n  document.body.removeChild(a);\n}\n\n// open print window for a given element\nexport function print(el, id) {\n  if (el.constructor !== Array) el = [el];\n\n  let width = $(window).width() * 0.9;\n  let height = $(window).height() - 10;\n  let cssFiles = [\n    \"/static/css/canrisk.css\",\n    \"https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css\",\n  ];\n  let printWindow = window.open(\n    \"\",\n    \"PrintMap\",\n    \"width=\" + width + \",height=\" + height\n  );\n  let headContent = \"\";\n  for (let i = 0; i < cssFiles.length; i++)\n    headContent +=\n      '<link href=\"' +\n      cssFiles[i] +\n      '\" rel=\"stylesheet\" type=\"text/css\" media=\"all\">';\n  headContent +=\n    \"<style>body {font-size: \" + $(\"body\").css(\"font-size\") + \";}</style>\";\n\n  let html = \"\";\n  for (let i = 0; i < el.length; i++) {\n    if (i === 0 && id) html += id;\n    html += $(el[i]).html();\n    if (i < el.length - 1) html += '<div class=\"page-break\"> </div>';\n  }\n\n  printWindow.document.write(headContent);\n  printWindow.document.write(html);\n  printWindow.document.close();\n\n  printWindow.focus();\n  setTimeout(function () {\n    printWindow.print();\n    printWindow.close();\n  }, 300);\n}\n\n// // save content to a file\n// export function save_file(opts, content, filename, type) {\n//   console.log(\"helloooo im saveee\");\n//   if (opts.DEBUG) console.log(content);\n//   if (!filename) filename = \"ped.txt\";\n//   if (!type) type = \"text/plain\";\n\n//   let file = new Blob([content], { type: type });\n//   if (window.navigator.msSaveOrOpenBlob)\n//     // IE10+\n//     window.navigator.msSaveOrOpenBlob(file, filename);\n//   else {\n//     // other browsers\n//     let a = document.createElement(\"a\");\n//     let url = URL.createObjectURL(file);\n//     a.href = url;\n//     a.download = filename;\n//     document.body.appendChild(a);\n//     a.click();\n//     setTimeout(function () {\n//       document.body.removeChild(a);\n//       window.URL.revokeObjectURL(url);\n//     }, 0);\n//   }\n// }\n\n// Convert JSON array to CSV format\nfunction jsonToCSV(jsonArray) {\n  const keys = Object.keys(jsonArray[0]);\n  const csvRows = [keys.join(\",\")]; // Header row\n\n  for (const row of jsonArray) {\n    const values = keys.map((key) => {\n      const escaped = (\"\" + row[key]).replace(/\"/g, '\\\\\"');\n      return escaped;\n    });\n    csvRows.push(values.join(\",\"));\n  }\n\n  return csvRows.join(\"\\n\");\n}\n\n// save content to a file\nexport function save_file(opts, content, filename, type) {\n  return new Promise((resolve, reject) => {\n    console.log(\"helloooo im saveee\");\n    if (opts.DEBUG) console.log(content);\n\n    // Default filename and type if not provided\n    if (!filename) filename = \"ped.csv\";\n    if (!type) type = \"text/csv\";\n\n    // Parse content if it's a JSON string\n    if (typeof content === \"string\") {\n      try {\n        content = JSON.parse(content);\n      } catch (e) {\n        console.error(\"Invalid JSON string provided.\");\n        return;\n      }\n    }\n\n    // Convert content to CSV if it's an object\n    if (typeof content === \"object\") {\n      content = jsonToCSV(content);\n    }\n\n    let file = new Blob([content], { type: type });\n    if (window.navigator.msSaveOrOpenBlob)\n      // IE10+\n      window.navigator.msSaveOrOpenBlob(file, filename);\n    else {\n      // other browsers\n      let a = document.createElement(\"a\");\n      let url = URL.createObjectURL(file);\n      a.href = url;\n      a.download = filename;\n      document.body.appendChild(a);\n      a.click();\n      setTimeout(function () {\n        document.body.removeChild(a);\n        window.URL.revokeObjectURL(url);\n      }, 0);\n    }\n\n    resolve(filename)\n  });\n}\n\nasync function save(opts) {\n  try {\n    let content = JSON.stringify(pedcache.current(opts));\n    let fname=await save_file(opts, content);\n\n    // let resolution = 1;\n    // let iname= await img_download(opts, resolution, \"image/png\");\n    let iname=\"enable me later .png (only https or localhost)\"\n    console.log(\"hellooo\");\n    console.log(fname)\n\n\n        // Prepare data for the PHP function\n        const csv = fname; // assuming this is the CSV data you want to insert\n        const img = iname; // change this based on how you're getting the image\n        const userId = opts.userId; // change this based on how you're getting the userId\n    console.log(csv);\n    console.log(img);\n    console.log(userId);\n\n    \n        // Call the PHP function\n        const response = await fetch('http://174.129.60.84/lama/lama%20(1)%203/Lama/db/insert_family.php', {\n          method: 'POST',\n          headers: {\n            'Content-Type': 'application/json',\n          },\n          body: JSON.stringify({ csv, img, \"userId\":123 }), // check the php file, user id is dynamic from session there\n        });\n    \n        // Check the response\n        if (!response.ok) {\n          throw new Error('Network response was not ok');\n        }\n    \n        const result = await response.json(); // assuming the PHP file returns a JSON response\n        console.log('Insert result:', result);\n    \n\n\n  } catch (error) {\n    console.error(\"Error during save process:\", error);\n  }\n}\n\nfunction canrisk_validation(opts) {\n  $.each(opts.dataset, function (_idx, p) {\n    if (!p.hidden && p.sex === \"M\" && !utils.isProband(p)) {\n      if (p[cancers[\"breast_cancer2\"]]) {\n        let msg =\n          \"Male family member (\" +\n          p.display_name +\n          \") with contralateral breast cancer found. \" +\n          \"Please note that as the risk models do not take this into account the second \" +\n          \"breast cancer is ignored.\";\n        console.error(msg);\n        delete p[cancers[\"breast_cancer2\"]];\n        utils.messages(\"Warning\", msg);\n      }\n    }\n  });\n}\n\n/** Read and load pedigree data string */\nexport function load_data(d, opts) {\n  if (opts.DEBUG) console.log(d);\n  let risk_factors;\n  try {\n    if (d.indexOf(\"BOADICEA import pedigree file format 4.0\") === 0) {\n      opts.dataset = readBoadiceaV4(d, 4);\n      canrisk_validation(opts);\n    } else if (d.indexOf(\"BOADICEA import pedigree file format 2.0\") === 0) {\n      opts.dataset = readBoadiceaV4(d, 2);\n      canrisk_validation(opts);\n    } else if (d.indexOf(\"##\") === 0 && d.indexOf(\"CanRisk\") !== -1) {\n      let canrisk_data = readCanRiskFile(d);\n      risk_factors = canrisk_data[0];\n      opts.dataset = canrisk_data[1];\n      canrisk_validation(opts);\n    } else {\n      try {\n        let ped = JSON.parse(d);\n        let to_process = true;\n        for (let i = 0; i < ped.length; i++) {\n          if (ped[i].top_level) {\n            to_process = false;\n          }\n        }\n        opts.dataset = to_process ? process_ped(ped) : ped;\n      } catch (err) {\n        opts.dataset = readLinkage(d);\n      }\n    }\n    utils.validate_pedigree(opts);\n  } catch (err1) {\n    console.error(err1, d);\n    utils.messages(\"File Error\", err1.message ? err1.message : err1);\n    return;\n  }\n  if (opts.DEBUG) console.log(opts.dataset);\n  try {\n    pedcache.setposition(opts); // clear position\n    rebuild(opts);\n    console.log(risk_factors);\n    // load risk factors - fire riskfactorChange event\n    $(document).trigger(\"riskfactorChange\", [opts, risk_factors]);\n    $(document).trigger(\"fhChange\", [opts]); // trigger fhChange event\n\n    try {\n      // update FH section\n      acc_FamHist_ticked(); // eslint-disable-line no-undef\n      acc_FamHist_Leave(); // eslint-disable-line no-undef\n      RESULT.FLAG_FAMILY_MODAL = true; // eslint-disable-line no-undef\n    } catch (err3) {\n      // ignore error\n    }\n  } catch (err2) {\n    utils.messages(\"File Error\", err2.message ? err2.message : err2);\n  }\n}\n\nfunction load(e, opts) {\n  let f = e.target.files[0];\n  if (f) {\n    let reader = new FileReader();\n    reader.onload = function (e) {\n      load_data(e.target.result, opts);\n    };\n    reader.onerror = function (event) {\n      utils.messages(\n        \"File Error\",\n        \"File could not be read! Code \" + event.target.error.code\n      );\n    };\n    reader.readAsText(f);\n  } else {\n    console.error(\"File could not be read!\");\n  }\n  $(\"#load\")[0].value = \"\"; // reset value\n}\n\n//\n// https://www.cog-genomics.org/plink/1.9/formats#ped\n// https://www.cog-genomics.org/plink/1.9/formats#fam\n//\t1. Family ID ('FID')\n//\t2. Within-family ID ('IID'; cannot be '0')\n//\t3. Within-family ID of father ('0' if father isn't in dataset)\n//\t4. Within-family ID of mother ('0' if mother isn't in dataset)\n//\t5. Sex code ('1' = male, '2' = female, '0' = unknown)\n//\t6. Phenotype value ('1' = control, '2' = case, '-9'/'0'/non-numeric = missing data if case/control)\n//  7. Genotypes (column 7 onwards);\n//\t columns 7 & 8 are allele calls for first variant ('0' = no call); colummns 9 & 10 are calls for second variant etc.\nexport function readLinkage(boadicea_lines) {\n  let lines = boadicea_lines.trim().split(\"\\n\");\n  let ped = [];\n  let famid;\n  for (let i = 0; i < lines.length; i++) {\n    let attr = $.map(lines[i].trim().split(/\\s+/), function (val, _i) {\n      return val.trim();\n    });\n    if (attr.length < 5) throw new Error(\"unknown format\");\n    let sex = attr[4] === \"1\" ? \"M\" : attr[4] === \"2\" ? \"F\" : \"U\";\n    let indi = {\n      famid: attr[0],\n      display_name: attr[1],\n      name: attr[1],\n      sex: sex,\n    };\n    if (attr[2] !== \"0\") indi.father = attr[2];\n    if (attr[3] !== \"0\") indi.mother = attr[3];\n\n    if (typeof famid != \"undefined\" && famid !== indi.famid) {\n      console.error(\"multiple family IDs found only using famid = \" + famid);\n      break;\n    }\n    if (attr[5] === \"2\") indi.affected = 2;\n    // add genotype columns\n    if (attr.length > 6) {\n      indi.alleles = \"\";\n      for (let j = 6; j < attr.length; j += 2) {\n        indi.alleles += attr[j] + \"/\" + attr[j + 1] + \";\";\n      }\n    }\n\n    ped.unshift(indi);\n    famid = attr[0];\n  }\n  return process_ped(ped);\n}\n\nexport function readCanRiskFile(boadicea_lines) {\n  let [hdr, ped] = readCanRisk(boadicea_lines);\n  try {\n    return [hdr, process_ped(ped)];\n  } catch (e) {\n    console.error(e);\n    return [hdr, ped];\n  }\n}\n\n// read boadicea format v4 & v2\nexport function readBoadiceaV4(boadicea_lines, version) {\n  let lines = boadicea_lines.trim().split(\"\\n\");\n  let ped = [];\n  // assumes two line header\n  for (let i = 2; i < lines.length; i++) {\n    let attr = $.map(lines[i].trim().split(/\\s+/), function (val, _i) {\n      return val.trim();\n    });\n    if (attr.length > 1) {\n      let indi = {\n        famid: attr[0],\n        display_name: attr[1],\n        name: attr[3],\n        sex: attr[6],\n        status: attr[8],\n      };\n      if (attr[2] === \"1\") indi.proband = true;\n      if (attr[4] !== \"0\") indi.father = attr[4];\n      if (attr[5] !== \"0\") indi.mother = attr[5];\n      if (attr[7] !== \"0\") indi.mztwin = attr[7];\n      if (attr[9] !== \"0\") indi.age = attr[9];\n      if (attr[10] !== \"0\") indi.yob = attr[10];\n\n      let idx = 11;\n      $.each(cancers, function (_cancer, diagnosis_age) {\n        // Age at 1st cancer or 0 = unaffected, AU = unknown age at diagnosis (affected unknown)\n        if (attr[idx] !== \"0\") {\n          indi[diagnosis_age] = attr[idx];\n        }\n        idx++;\n      });\n\n      if (version === 4) {\n        if (attr[idx++] !== \"0\") indi.ashkenazi = 1;\n        // BRCA1, BRCA2, PALB2, ATM, CHEK2 genetic tests\n        // type, 0 = untested, S = mutation search, T = direct gene test\n        // result, 0 = untested, P = positive, N = negative\n        for (let j = 0; j < 5; j++) {\n          idx += 2;\n          if (attr[idx - 2] !== \"0\") {\n            if (\n              (attr[idx - 2] === \"S\" || attr[idx - 2] === \"T\") &&\n              (attr[idx - 1] === \"P\" || attr[idx - 1] === \"N\")\n            )\n              indi[genetic_test1[j] + \"_gene_test\"] = {\n                type: attr[idx - 2],\n                result: attr[idx - 1],\n              };\n            else\n              console.warn(\n                \"UNRECOGNISED GENE TEST ON LINE \" +\n                  (i + 1) +\n                  \": \" +\n                  attr[idx - 2] +\n                  \" \" +\n                  attr[idx - 1]\n              );\n          }\n        }\n      } else if (version === 2) {\n        // genetic test BRCA1, BRCA2\n        // type, 0 = untested, S = mutation search, T = direct gene test\n        // result, 0 = untested, N = no mutation, 1 = BRCA1 positive, 2 = BRCA2 positive, 3 = BRCA1/2 positive\n        idx += 2; // gtest\n        if (attr[idx - 2] !== \"0\") {\n          if (attr[idx - 2] === \"S\" || attr[idx - 2] === \"T\") {\n            if (attr[idx - 1] === \"N\") {\n              indi[\"brca1_gene_test\"] = { type: attr[idx - 2], result: \"N\" };\n              indi[\"brca2_gene_test\"] = { type: attr[idx - 2], result: \"N\" };\n            } else if (attr[idx - 1] === \"1\") {\n              indi[\"brca1_gene_test\"] = { type: attr[idx - 2], result: \"P\" };\n              indi[\"brca2_gene_test\"] = { type: attr[idx - 2], result: \"N\" };\n            } else if (attr[idx - 1] === \"2\") {\n              indi[\"brca1_gene_test\"] = { type: attr[idx - 2], result: \"N\" };\n              indi[\"brca2_gene_test\"] = { type: attr[idx - 2], result: \"P\" };\n            } else if (attr[idx - 1] === \"3\") {\n              indi[\"brca1_gene_test\"] = { type: attr[idx - 2], result: \"P\" };\n              indi[\"brca2_gene_test\"] = { type: attr[idx - 2], result: \"P\" };\n            }\n          } else {\n            console.warn(\n              \"UNRECOGNISED GENE TEST ON LINE \" +\n                (i + 1) +\n                \": \" +\n                attr[idx - 2] +\n                \" \" +\n                attr[idx - 1]\n            );\n          }\n        }\n        if (attr[idx++] !== \"0\") indi.ashkenazi = 1;\n      }\n\n      // status, 0 = unspecified, N = negative, P = positive\n      for (let j = 0; j < pathology_tests.length; j++) {\n        if (attr[idx] !== \"0\") {\n          if (attr[idx] === \"N\" || attr[idx] === \"P\")\n            indi[pathology_tests[j] + \"_bc_pathology\"] = attr[idx];\n          else\n            console.warn(\n              \"UNRECOGNISED PATHOLOGY ON LINE \" +\n                (i + 1) +\n                \": \" +\n                pathology_tests[j] +\n                \" \" +\n                attr[idx]\n            );\n        }\n        idx++;\n      }\n      ped.unshift(indi);\n    }\n  }\n\n  try {\n    return process_ped(ped);\n  } catch (e) {\n    console.error(e);\n    return ped;\n  }\n}\n\nfunction process_ped(ped) {\n  // find the level of individuals in the pedigree\n  for (let j = 0; j < 2; j++) {\n    for (let i = 0; i < ped.length; i++) {\n      getLevel(ped, ped[i].name);\n    }\n  }\n\n  fix_n_balance_levels(ped);\n\n  // find the max level (i.e. top_level)\n  let max_level = 0;\n  for (let i = 0; i < ped.length; i++) {\n    if (ped[i].level && ped[i].level > max_level) max_level = ped[i].level;\n  }\n\n  // identify top_level and other nodes without parents\n  for (let i = 0; i < ped.length; i++) {\n    if (utils.getDepth(ped, ped[i].name) === 1) {\n      if (ped[i].level && ped[i].level === max_level) {\n        ped[i].top_level = true;\n      } else {\n        ped[i].noparents = true;\n\n        // 1. look for partners parents\n        let pidx = getPartnerIdx(ped, ped[i]);\n        if (pidx > -1) {\n          if (ped[pidx].mother) {\n            ped[i].mother = ped[pidx].mother;\n            ped[i].father = ped[pidx].father;\n          }\n        }\n\n        // 2. or adopt parents from level above\n        if (!ped[i].mother) {\n          for (let j = 0; j < ped.length; j++) {\n            if (ped[i].level === ped[j].level - 1) {\n              pidx = getPartnerIdx(ped, ped[j]);\n              if (pidx > -1 && i !== pidx) {\n                ped[i].mother =\n                  ped[j].sex === \"F\" ? ped[j].name : ped[pidx].name;\n                ped[i].father =\n                  ped[j].sex === \"M\" ? ped[j].name : ped[pidx].name;\n                break;\n              }\n            }\n          }\n        }\n      }\n    } else {\n      delete ped[i].top_level;\n    }\n  }\n  return ped;\n}\n\n// get the partners for a given node\nfunction getPartnerIdx(dataset, anode) {\n  for (let i = 0; i < dataset.length; i++) {\n    let bnode = dataset[i];\n    if (anode.name === bnode.mother)\n      return utils.getIdxByName(dataset, bnode.father);\n    else if (anode.name === bnode.father)\n      return utils.getIdxByName(dataset, bnode.mother);\n  }\n  return -1;\n}\n\n// for a given individual assign levels to a parents ancestors\nfunction getLevel(dataset, name) {\n  let idx = utils.getIdxByName(dataset, name);\n  let level = dataset[idx].level ? dataset[idx].level : 0;\n  update_parents_level(idx, level, dataset);\n}\n\n// recursively update parents levels\nfunction update_parents_level(idx, level, dataset) {\n  let parents = [\"mother\", \"father\"];\n  level++;\n  for (let i = 0; i < parents.length; i++) {\n    let pidx = utils.getIdxByName(dataset, dataset[idx][parents[i]]);\n    if (pidx >= 0) {\n      let ma = dataset[utils.getIdxByName(dataset, dataset[idx].mother)];\n      let pa = dataset[utils.getIdxByName(dataset, dataset[idx].father)];\n      if (!dataset[pidx].level || dataset[pidx].level < level) {\n        ma.level = level;\n        pa.level = level;\n      }\n\n      if (ma.level < pa.level) {\n        ma.level = pa.level;\n      } else if (pa.level < ma.level) {\n        pa.level = ma.level;\n      }\n      update_parents_level(pidx, level, dataset);\n    }\n  }\n}\n\n// for a pedigree fix the levels of children nodes to be consistent with parent\nfunction fix_n_balance_levels(ped) {\n  let updated = false;\n  let l = ped.length;\n\n  for (let i = 0; i < l; i++) {\n    let children = utils.getChildren(ped, ped[i]);\n    let prt_lvl = ped[i].level;\n    for (let j = 0; j < children.length; j++) {\n      if (prt_lvl - children[j].level > 1) {\n        children[j].level = prt_lvl - 1;\n        let ptrs = utils.get_partners(ped, children[j]);\n\n        for (let k = 0; k < ptrs.length; k++) {\n          let p = utils.getNodeByName(ped, ptrs[k]);\n          p.level = prt_lvl - 1;\n\n          let m = utils.getNodeByName(ped, p.mother);\n          let f = utils.getNodeByName(ped, p.father);\n          if (m) m.level = prt_lvl;\n          if (f) f.level = prt_lvl;\n        }\n        updated = true;\n      }\n    }\n  }\n  return updated;\n}\n","/**\n/* © 2023 University of Cambridge\n/* SPDX-FileCopyrightText: 2023 University of Cambridge\n/* SPDX-License-Identifier: GPL-3.0-or-later\n**/\n\n\n// set two siblings as twins\nexport function setMzTwin(dataset, d1, d2, twin_type) {\n\tif(!d1[twin_type]) {\n\t\td1[twin_type] = getUniqueTwinID(dataset, twin_type);\n\t\tif(!d1[twin_type])\n\t\t\treturn false;\n\t}\n\td2[twin_type] = d1[twin_type];\n\tif(d1.yob)\n\t\td2.yob = d1.yob;\n\tif(d1.age && (d1.status === \"0\" || !d1.status))\n\t\td2.age = d1.age;\n\treturn true;\n}\n\n// get a new unique twins ID, max of 10 twins in a pedigree\nexport function getUniqueTwinID(dataset, twin_type) {\n\tlet mz = [1, 2, 3, 4, 5, 6, 7, 8, 9, \"A\"];\n\tfor(let i=0; i<dataset.length; i++) {\n\t\tif(dataset[i][twin_type]) {\n\t\t\tlet idx = mz.indexOf(dataset[i][twin_type]);\n\t\t\tif (idx > -1)\n\t\t\t\tmz.splice(idx, 1);\n\t\t}\n\t}\n\tif(mz.length > 0)\n\t\treturn mz[0];\n\treturn undefined;\n}\n\n// sync attributes of twins\nexport function syncTwins(dataset, d1) {\n\tif(!d1.mztwin && !d1.dztwin)\n\t\treturn;\n\tlet twin_type = (d1.mztwin ? \"mztwin\" : \"dztwin\");\n\tfor(let i=0; i<dataset.length; i++) {\n\t\tlet d2 = dataset[i];\n\t\tif(d2[twin_type] && d1[twin_type] === d2[twin_type] && d2.name !== d1.name) {\n\t\t\tif(twin_type === \"mztwin\")\n\t\t\t  d2.sex = d1.sex;\n\t\t\tif(d1.yob)\n\t\t\t\td2.yob = d1.yob;\n\t\t\tif(d1.age && (d1.status === 0 || !d1.status))\n\t\t\t\td2.age = d1.age;\n\t\t}\n\t}\n}\n\n// check integrity twin settings\nexport function checkTwins(dataset) {\n\tlet twin_types = [\"mztwin\", \"dztwin\"];\n\tfor(let i=0; i<dataset.length; i++) {\n\t\tfor(let j=0; j<twin_types.length; j++) {\n\t\t\tlet twin_type = twin_types[j];\n\t\t\tif(dataset[i][twin_type]) {\n\t\t\t\tlet count = 0;\n\t\t\t\tfor(let j=0; j<dataset.length; j++) {\n\t\t\t\t\tif(dataset[j][twin_type] === dataset[i][twin_type])\n\t\t\t\t\t\tcount++;\n\t\t\t\t}\n\t\t\t\tif(count < 2)\n\t\t\t\t\tdelete dataset[i][[twin_type]];\n\t\t\t}\n\t\t}\n\t}\n}","/**\n/* © 2023 University of Cambridge\n/* SPDX-FileCopyrightText: 2023 University of Cambridge\n/* SPDX-License-Identifier: GPL-3.0-or-later\n**/\n\n// pedigree form\nimport {rebuild} from './pedigree.js';\nimport {syncTwins} from './twins.js';\nimport {copy_dataset, getNodeByName} from './utils.js';\nimport {current as pedcache_current} from './pedcache.js';\n\n\n// handle family history change events (undo/redo/delete)\n$(document).on('fhChange', function(e, opts){\n\ttry {\n\t\tlet id = $('#id_name').val();  // get name from hidden field\n\t\tlet node = getNodeByName(pedcache_current(opts), id)\n\t\tif(node === undefined)\n\t\t\t$('form > fieldset').prop(\"disabled\", true);\n\t\telse\n\t\t\t$('form > fieldset').prop('disabled', false);\n\t} catch(err) {\n\t\tconsole.warn(err);\n\t}\n})\n\n// update status field and age label - 0 = alive, 1 = dead\nexport function updateStatus(status) {\n\t$('#age_yob_lock').removeClass('fa-lock fa-unlock-alt');\n\t(status === \"1\" ? $('#age_yob_lock').addClass('fa-unlock-alt') : $('#age_yob_lock').addClass('fa-lock'));\n\t$('#id_age_'+status).removeClass(\"hidden\");\n\t$('#id_age_'+(status === \"1\" ? '0' : '1')).addClass(\"hidden\");\n}\n\nexport function nodeclick(node) {\n\t$('form > fieldset').prop('disabled', false);\n\t// clear values\n\t$('#person_details').find(\"input[type=text], input[type=number]\").val(\"\");\n\t$('#person_details select').val('').prop('selected', true);\n\n\t// assign values to input fields in form\n\tif(node.sex === 'M' || node.sex === 'F')\n\t\t$('input[name=sex][value=\"'+node.sex+'\"]').prop('checked', true);\n\telse\n\t\t$('input[name=sex]').prop('checked', false);\n\tupdate_cancer_by_sex(node);\n\n\tif(!('status' in node))\n\t\tnode.status = 0;\n\t$('input[name=status][value=\"'+node.status+'\"]').prop('checked', true);\n\t// show lock symbol for age and yob synchronisation\n\tupdateStatus(node.status);\n\n\tif('proband' in node) {\n\t\t$('#id_proband').prop('checked', node.proband);\n\t\t$('#id_proband').prop(\"disabled\", true);\n\t} else {\n\t\t$('#id_proband').prop('checked', false);\n\t\t$('#id_proband').prop(\"disabled\", !('yob' in node))\n\t}\n\n\tif('exclude' in node) {\n\t\t$('#id_exclude').prop('checked', node.exclude);\n\t} else {\n\t\t$('#id_exclude').prop('checked', false);\n\t}\n\n/*\t\tif('ashkenazi' in node) {\n\t\t\t$('#id_ashkenazi').prop('checked', (node.proband == 1 ? true: false));\n\t\t} else {\n\t\t\t$('#id_ashkenazi').prop('checked', false);\n\t\t}*/\n\n\t// year of birth\n\tif('yob' in node) {\n\t\t$('#id_yob_0').val(node.yob);\n\t} else {\n\t\t$('#id_yob_0').val('-');\n\t}\n\n\t// clear pathology\n\t$('select[name$=\"_bc_pathology\"]').val('-');\n\t// clear gene tests\n\t$('select[name*=\"_gene_test\"]').val('-');\n\n\t// disable sex radio buttons if the person has a partner\n\t$(\"input[id^='id_sex_']\").prop(\"disabled\", (node.parent_node && node.sex !== 'U' ? true : false));\n\n\t// disable pathology for male relatives (as not used by model)\n\t// and if no breast cancer age of diagnosis\n\t$(\"select[id$='_bc_pathology']\").prop(\"disabled\",\n\t\t\t(node.sex === 'M' || (node.sex === 'F' && !('breast_cancer_diagnosis_age' in node)) ? true : false));\n\n\t// approximate diagnosis age\n\t$('#id_approx').prop('checked', (node.approx_diagnosis_age ? true: false));\n\tupdate_diagnosis_age_widget();\n\n\tfor(let key in node) {\n\t\tif(key !== 'proband' && key !== 'sex') {\n\t\t\tif($('#id_'+key).length) {\t// input value\n\t\t\t\tif(key.indexOf('_gene_test')  !== -1 && node[key] !== null && typeof node[key] === 'object') {\n\t\t\t\t\t$('#id_'+key).val(node[key].type);\n\t\t\t\t\t$('#id_'+key+'_result').val(node[key].result);\n\t\t\t\t} else {\n\t\t\t\t\t$('#id_'+key).val(node[key]);\n\t\t\t\t}\n\t\t\t} else if(key.indexOf('_diagnosis_age') !== -1) {\n\t\t\t\tif($(\"#id_approx\").is(':checked')) {\n\t\t\t\t\t$('#id_'+key+'_1').val(round5(node[key])).prop('selected', true);\n\t\t\t\t} else {\n\t\t\t\t\t$('#id_'+key+'_0').val(node[key]);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\ttry {\n\t\t$('#person_details').find('form').valid();\n\t} catch(err) {\n\t\tconsole.warn('valid() not found');\n\t}\n}\n\nfunction update_ashkn(newdataset) {\n\t// Ashkenazi status, 0 = not Ashkenazi, 1 = Ashkenazi\n\tif($('#orig_ashk').is(':checked')) {\n\t\t$.each(newdataset, function(_i, p) {\n\t\t\tif(p.proband)\n\t\t\t\tp.ashkenazi = 1;\n\t\t});\n\t} else {\n\t\t$.each(newdataset, function(_i, p) {\n\t\t\tdelete p.ashkenazi;\n\t\t});\n\t}\n}\n\n// Save Ashkenazi status\nexport function save_ashkn(opts) {\n\tlet dataset = pedcache_current(opts);\n\tlet newdataset = copy_dataset(dataset);\n\tupdate_ashkn(newdataset);\n\topts.dataset = newdataset;\n\trebuild(opts);\n}\n\nexport function save(opts) {\n\tlet dataset = pedcache_current(opts);\n\tlet name = $('#id_name').val();\n\tlet newdataset = copy_dataset(dataset);\n\tlet person = getNodeByName(newdataset, name);\n\tif(!person) {\n\t\tconsole.warn('person not found when saving details');\n\t\treturn;\n\t}\n\t$(\"#\"+opts.targetDiv).empty();\n\n\t// individual's personal and clinical details\n\tlet yob = $('#id_yob_0').val();\n\tif(yob && yob !== '') {\n\t\tperson.yob = yob;\n\t} else {\n\t\tdelete person.yob;\n\t}\n\n\t// current status: 0 = alive, 1 = dead\n\tlet status = $('#id_status').find(\"input[type='radio']:checked\");\n\tif(status.length > 0){\n\t\tperson.status = status.val();\n\t}\n\n\t// booleans switches\n\tlet switches = [\"miscarriage\", \"adopted_in\", \"adopted_out\", \"termination\", \"stillbirth\"];\n\tfor(let iswitch=0; iswitch<switches.length; iswitch++){\n\t\tlet attr = switches[iswitch];\n\t\tlet s = $('#id_'+attr);\n\t\tif(s.length > 0){\n\t\t\tconsole.log(s.is(\":checked\"));\n\t\t\tif(s.is(\":checked\"))\n\t\t\t\tperson[attr] = true;\n\t\t\telse\n\t\t\t\tdelete person[attr];\n\t\t}\n\t}\n\n\t// current sex\n\tlet sex = $('#id_sex').find(\"input[type='radio']:checked\");\n\tif(sex.length > 0){\n\t\tperson.sex = sex.val();\n\t\tupdate_cancer_by_sex(person);\n\t}\n\n\t// Ashkenazi status, 0 = not Ashkenazi, 1 = Ashkenazi\n\tupdate_ashkn(newdataset);\n\n\tif($('#id_approx').is(':checked')) // approximate diagnosis age\n\t\tperson.approx_diagnosis_age = true;\n\telse\n\t\tdelete person.approx_diagnosis_age;\n\n\t$(\"#person_details select[name*='_diagnosis_age']:visible, #person_details input[type=text]:visible, #person_details input[type=number]:visible\").each(function() {\n\t\tlet name = (this.name.indexOf(\"_diagnosis_age\")>-1 ? this.name.substring(0, this.name.length-2): this.name);\n\n\t\tif($(this).val()) {\n\t\t\tlet val = $(this).val();\n\t\t\tif(name.indexOf(\"_diagnosis_age\") > -1 && $(\"#id_approx\").is(':checked'))\n\t\t\t\tval = round5(val);\n\t\t\tperson[name] = val;\n\t\t} else {\n\t\t\tdelete person[name];\n\t\t}\n\t});\n\n\t// cancer checkboxes\n\t$('#person_details input[type=\"checkbox\"][name$=\"cancer\"],input[type=\"checkbox\"][name$=\"cancer2\"]').each(function() {\n\t\tif(this.checked)\n\t\t\tperson[$(this).attr('name')] = true;\n\t\telse\n\t\t\tdelete person[$(this).attr('name')];\n\t});\n\n\t// pathology tests\n\t$('#person_details select[name$=\"_bc_pathology\"]').each(function() {\n\t\tif($(this).val() !== '-') {\n\t\t\tperson[$(this).attr('name')] = $(this).val();\n\t\t} else {\n\t\t\tdelete person[$(this).attr('name')];\n\t\t}\n\t});\n\n\t// genetic tests\n\t$('#person_details select[name$=\"_gene_test\"]').each(function() {\n\t\tif($(this).val() !== '-') {\n\t\t\tlet tres = $('select[name=\"'+$(this).attr('name')+'_result\"]');\n\t\t\tperson[$(this).attr('name')] = {'type': $(this).val(), 'result': $(tres).val()};\n\t\t} else {\n\t\t\tdelete person[$(this).attr('name')];\n\t\t}\n\t});\n\n\t// record HOXB13 genetic test\n\tlet hoxb13_result = $('#person_details select[name=\"hoxb13_gene_test_result\"]').val();\n\tif(hoxb13_result !== undefined && hoxb13_result !== '-') {\n\t\tperson[\"hoxb13_gene_test\"] = {'type': 'T', 'result': hoxb13_result};\t// assume direct test\n\t} else {\n\t\tdelete person[\"hoxb13_gene_test\"];\n\t}\n\n\ttry {\n\t\t$('#person_details').find('form').valid();\n\t} catch(err) {\n\t\tconsole.warn('valid() not found');\n\t}\n\n\tsyncTwins(newdataset, person);\n\topts.dataset = newdataset;\n\trebuild(opts);\n}\n\nexport function update_diagnosis_age_widget() {\n\tif($(\"#id_approx\").is(':checked')) {\n\t\t$(\"[id$='_diagnosis_age_0']\").each(function( _i ) {\n\t\t\tif($(this).val() !== '') {\n\t\t\t\tlet name = this.name.substring(0, this.name.length-2);\n\t\t\t\t$(\"#id_\"+name+\"_1\").val(round5($(this).val())).prop('selected', true);\n\t\t\t}\n\t\t});\n\n\t\t$(\"[id$='_diagnosis_age_0']\").hide();\n\t\t$(\"[id$='_diagnosis_age_1']\").show();\n\t} else {\n\t\t$(\"[id$='_diagnosis_age_1']\").each(function( _i ) {\n\t\t\tif($(this).val() !== '') {\n\t\t\t\tlet name = this.name.substring(0, this.name.length-2);\n\t\t\t\t$(\"#id_\"+name+\"_0\").val($(this).val());\n\t\t\t}\n\t\t});\n\n\t\t$(\"[id$='_diagnosis_age_0']\").show();\n\t\t$(\"[id$='_diagnosis_age_1']\").hide();\n\t}\n}\n\n// males should not have ovarian cancer and females should not have prostate cancer\nfunction update_cancer_by_sex(node) {\n\t$('#cancer .row').show();\n\tif(node.sex === 'M') {\n\t\tdelete node.ovarian_cancer_diagnosis_age;\n\t\t$(\"[id^='id_ovarian_cancer_diagnosis_age']\").closest('.row').hide();\n\t\t$(\"[id^='id_breast_cancer2_diagnosis_age']\").prop('disabled', true);\n\t} else if(node.sex === 'F') {\n\t\tdelete node.prostate_cancer_diagnosis_age;\n\t\t$(\"[id^='id_prostate_cancer_diagnosis_age']\").closest('.row').hide();\n\t\t$(\"[id^='id_breast_cancer2_diagnosis_age']\").prop('disabled', false);\n\t}\n}\n\n// round to 5, 15, 25, 35 ....\nfunction round5(x1) {\n\tlet x2 = (Math.round((x1-1) / 10) * 10);\n\treturn (x1 < x2 ? x2 - 5 : x2 + 5);\n}\n\n","/**\n/* © 2023 University of Cambridge\n/* SPDX-FileCopyrightText: 2023 University of Cambridge\n/* SPDX-License-Identifier: GPL-3.0-or-later\n**/\n\n// pedigree widgets\nimport { rebuild } from \"./pedigree.js\";\nimport * as utils from \"./utils.js\";\nimport { save } from \"./popup_form.js\";\nimport { current as pedcache_current } from \"./pedcache.js\";\nimport { getUniqueTwinID, setMzTwin, checkTwins } from \"./twins.js\";\n\nlet dragging;\nlet last_mouseover;\n//\n// Add widgets to nodes and bind events\nexport function addWidgets(opts, node) {\n  // popup gender selection box\n  let font_size = parseInt($(\"body\").css(\"font-size\"));\n  let popup_selection = d3.select(\".diagram\");\n  popup_selection\n    .append(\"rect\")\n    .attr(\"class\", \"popup_selection\")\n    .attr(\"rx\", 6)\n    .attr(\"ry\", 6)\n    .attr(\"transform\", \"translate(-1000,-100)\")\n    .style(\"opacity\", 0)\n    .attr(\"width\", font_size * 7.9)\n    .attr(\"height\", font_size * 2)\n    .style(\"stroke\", \"darkgrey\")\n    .attr(\"fill\", \"white\");\n\n  let square = popup_selection\n    .append(\"text\") // male\n    .attr(\"font-family\", \"FontAwesome\")\n    .style(\"opacity\", 0)\n    .style(\"font-size\", \"1.1em\")\n    .attr(\"class\", \"popup_selection fa-square persontype\")\n    .attr(\"transform\", \"translate(-1000,-100)\")\n    .attr(\"x\", font_size / 3)\n    .attr(\"y\", font_size * 1.5)\n    .text(\"\\uf096 \");\n  let square_title = square.append(\"svg:title\").text(\"add male\");\n\n  let circle = popup_selection\n    .append(\"text\") // female\n    .attr(\"font-family\", \"FontAwesome\")\n    .style(\"opacity\", 0)\n    .style(\"font-size\", \"1.1em\")\n    .attr(\"class\", \"popup_selection fa-circle persontype\")\n    .attr(\"transform\", \"translate(-1000,-100)\")\n    .attr(\"x\", font_size * 1.71)\n    .attr(\"y\", font_size * 1.5)\n    .text(\"\\uf10c \");\n  let circle_title = circle.append(\"svg:title\").text(\"add female\");\n\n  let unspecified = popup_selection\n    .append(\"text\") // unspecified\n    .attr(\"font-family\", \"FontAwesome\")\n    .style(\"opacity\", 0)\n    .style(\"font-size\", \"1.1em\")\n    .attr(\"transform\", \"translate(-1000,-100)\")\n    .attr(\"x\", font_size * 0.065)\n    .attr(\"y\", -font_size * 0.065)\n    .attr(\n      \"class\",\n      \"popup_selection fa-unspecified popup_selection_rotate45 persontype\"\n    )\n    .text(\"\\uf096 \");\n  unspecified.append(\"svg:title\").text(\"add unspecified\");\n\n  let dztwin = popup_selection\n    .append(\"text\") // dizygotic twins\n    .attr(\"font-family\", \"FontAwesome\")\n    .style(\"opacity\", 0)\n    .style(\"font-size\", \"1.6em\")\n    .attr(\"transform\", \"translate(-1000,-100)\")\n    .attr(\"class\", \"popup_selection fa-angle-up persontype dztwin\")\n    .attr(\"x\", font_size * 4.62)\n    .attr(\"y\", font_size * 1.5)\n    .text(\"\\uf106 \");\n  dztwin.append(\"svg:title\").text(\"add dizygotic/fraternal twins\");\n\n  let mztwin = popup_selection\n    .append(\"text\") // monozygotic twins\n    .attr(\"font-family\", \"FontAwesome\")\n    .style(\"opacity\", 0)\n    .style(\"font-size\", \"1.6em\")\n    .attr(\"transform\", \"translate(-1000,-100)\")\n    .attr(\"class\", \"popup_selection fa-caret-up persontype mztwin\")\n    .attr(\"x\", font_size * 6.4)\n    .attr(\"y\", font_size * 1.5)\n    .text(\"\\uf0d8 \");\n  mztwin.append(\"svg:title\").text(\"add monozygotic/identical twins\");\n\n  let add_person = {};\n  // click the person type selection\n  d3.selectAll(\".persontype\")\n    .on(\"click\", function () {\n      let newdataset = utils.copy_dataset(pedcache_current(opts));\n      let mztwin = d3.select(this).classed(\"mztwin\");\n      let dztwin = d3.select(this).classed(\"dztwin\");\n      let twin_type;\n      let sex;\n      if (mztwin || dztwin) {\n        sex = add_person.node.datum().data.sex;\n        twin_type = mztwin ? \"mztwin\" : \"dztwin\";\n      } else {\n        sex = d3.select(this).classed(\"fa-square\")\n          ? \"M\"\n          : d3.select(this).classed(\"fa-circle\")\n          ? \"F\"\n          : \"U\";\n      }\n\n      if (add_person.type === \"addsibling\")\n        addsibling(\n          newdataset,\n          add_person.node.datum().data,\n          sex,\n          false,\n          twin_type\n        );\n      else if (add_person.type === \"addchild\")\n        addchild(\n          newdataset,\n          add_person.node.datum().data,\n          twin_type ? \"U\" : sex,\n          twin_type ? 2 : 1,\n          twin_type\n        );\n      else return;\n      opts.dataset = newdataset;\n      rebuild(opts);\n      d3.selectAll(\".popup_selection\").style(\"opacity\", 0);\n      add_person = {};\n    })\n    .on(\"mouseover\", function () {\n      if (add_person.node) add_person.node.select(\"rect\").style(\"opacity\", 0.2);\n      d3.selectAll(\".popup_selection\").style(\"opacity\", 1);\n      // add tooltips to font awesome widgets\n      if (add_person.type === \"addsibling\") {\n        if (d3.select(this).classed(\"fa-square\"))\n          square_title.text(\"add brother\");\n        else circle_title.text(\"add sister\");\n      } else if (add_person.type === \"addchild\") {\n        if (d3.select(this).classed(\"fa-square\")) square_title.text(\"add son\");\n        else circle_title.text(\"add daughter\");\n      }\n    });\n\n  // handle mouse out of popup selection\n  d3.selectAll(\".popup_selection\").on(\"mouseout\", function () {\n    // hide rect and popup selection\n    if (\n      add_person.node !== undefined &&\n      highlight.indexOf(add_person.node.datum()) === -1\n    )\n      add_person.node.select(\"rect\").style(\"opacity\", 0);\n    d3.selectAll(\".popup_selection\").style(\"opacity\", 0);\n  });\n\n  // drag line between nodes to create partners\n  drag_handle(opts);\n\n  // rectangle used to highlight on mouse over\n  node\n    .filter(function (d) {\n      return d.data.hidden && !opts.DEBUG ? false : true;\n    })\n    .append(\"rect\")\n    .attr(\"class\", \"indi_rect\")\n    .attr(\"rx\", 6)\n    .attr(\"ry\", 6)\n    .attr(\"x\", function (_d) {\n      return -0.75 * opts.symbol_size;\n    })\n    .attr(\"y\", function (_d) {\n      return -opts.symbol_size;\n    })\n    .attr(\"width\", 1.5 * opts.symbol_size + \"px\")\n    .attr(\"height\", 2 * opts.symbol_size + \"px\")\n    .style(\"stroke\", \"black\")\n    .style(\"stroke-width\", 0.7)\n    .style(\"opacity\", 0)\n    .attr(\"fill\", \"lightgrey\");\n\n  // widgets\n  let fx = function (_d) {\n    return off - 0.75 * opts.symbol_size;\n  };\n  let fy = opts.symbol_size - 2;\n  let off = 0;\n  let widgets = {\n    addchild: { text: \"\\uf063\", title: \"add child\", fx: fx, fy: fy },\n    addsibling: { text: \"\\uf234\", title: \"add sibling\", fx: fx, fy: fy },\n    addpartner: { text: \"\\uf0c1\", title: \"add partner\", fx: fx, fy: fy },\n    addparents: {\n      text: \"\\uf062\",\n      title: \"add parents\",\n      fx: -0.75 * opts.symbol_size,\n      fy: -opts.symbol_size + 11,\n    },\n    delete: {\n      text: \"X\",\n      title: \"delete\",\n      fx: opts.symbol_size / 2 - 1,\n      fy: -opts.symbol_size + 12,\n      styles: {\n        \"font-weight\": \"bold\",\n        fill: \"darkred\",\n        \"font-family\": \"monospace\",\n      },\n    },\n  };\n\n  if (opts.edit) {\n    widgets.settings = {\n      text: \"\\uf013\",\n      title: \"settings\",\n      fx: -font_size / 2 + 2,\n      fy: -opts.symbol_size + 11,\n    };\n  }\n\n  for (let key in widgets) {\n    let widget = node\n      .filter(function (d) {\n        return (\n          (d.data.hidden && !opts.DEBUG ? false : true) &&\n          !(\n            (d.data.mother === undefined || d.data.noparents) &&\n            key === \"addsibling\"\n          ) &&\n          !(\n            d.data.parent_node !== undefined &&\n            d.data.parent_node.length > 1 &&\n            key === \"addpartner\"\n          ) &&\n          !(d.data.parent_node === undefined && key === \"addchild\") &&\n          !(\n            d.data.noparents === undefined &&\n            d.data.top_level === undefined &&\n            key === \"addparents\"\n          )\n        );\n      })\n      .append(\"text\")\n      .attr(\"class\", key)\n      .style(\"opacity\", 0)\n      .attr(\"font-family\", \"FontAwesome\")\n      .attr(\"xx\", function (d) {\n        return d.x;\n      })\n      .attr(\"yy\", function (d) {\n        return d.y;\n      })\n      .attr(\"x\", widgets[key].fx)\n      .attr(\"y\", widgets[key].fy)\n      .attr(\"font-size\", \"0.85em\")\n      .text(widgets[key].text);\n\n    if (\"styles\" in widgets[key])\n      for (let style in widgets[key].styles) {\n        widget.attr(style, widgets[key].styles[style]);\n      }\n\n    widget.append(\"svg:title\").text(widgets[key].title);\n    off += 17;\n  }\n\n  // add sibling or child\n  d3.selectAll(\".addsibling, .addchild\").on(\"mouseover\", function () {\n    let type = d3.select(this).attr(\"class\");\n    d3.selectAll(\".popup_selection\").style(\"opacity\", 1);\n    add_person = { node: d3.select(this.parentNode), type: type };\n\n    //let translate = getTranslation(d3.select('.diagram').attr(\"transform\"));\n    let x =\n      parseInt(d3.select(this).attr(\"xx\")) +\n      parseInt(d3.select(this).attr(\"x\"));\n    let y =\n      parseInt(d3.select(this).attr(\"yy\")) +\n      parseInt(d3.select(this).attr(\"y\"));\n    d3.selectAll(\".popup_selection\").attr(\n      \"transform\",\n      \"translate(\" + x + \",\" + (y + 2) + \")\"\n    );\n    d3.selectAll(\".popup_selection_rotate45\").attr(\n      \"transform\",\n      \"translate(\" +\n        (x + 3 * font_size) +\n        \",\" +\n        (y + font_size * 1.2) +\n        \") rotate(45)\"\n    );\n  });\n\n  // handle widget clicks\n  d3.selectAll(\".addchild, .addpartner, .addparents, .delete, .settings\").on(\n    \"click\",\n    function (e) {\n      e.stopPropagation();\n      let opt = d3.select(this).attr(\"class\");\n      let d = d3.select(this.parentNode).datum();\n      if (opts.DEBUG) {\n        console.log(opt);\n      }\n\n      let newdataset;\n      if (opt === \"settings\") {\n        if (typeof opts.edit === \"function\") {\n          opts.edit(opts, d);\n        } else {\n          openEditDialog(opts, d);\n        }\n      } else if (opt === \"delete\") {\n        newdataset = utils.copy_dataset(pedcache_current(opts));\n        delete_node_dataset(newdataset, d.data, opts, onDone);\n      } else if (opt === \"addparents\") {\n        newdataset = utils.copy_dataset(pedcache_current(opts));\n        opts.dataset = newdataset;\n        addparents(opts, newdataset, d.data.name);\n        rebuild(opts);\n      } else if (opt === \"addpartner\") {\n        newdataset = utils.copy_dataset(pedcache_current(opts));\n        addpartner(opts, newdataset, d.data.name);\n        opts.dataset = newdataset;\n        rebuild(opts);\n      }\n      // trigger fhChange event\n      $(document).trigger(\"fhChange\", [opts]);\n    }\n  );\n\n  // other mouse events\n  let highlight = [];\n\n  node\n    .filter(function (d) {\n      return !d.data.hidden;\n    })\n    .on(\"click\", function (e, d) {\n      if (e.ctrlKey) {\n        if (highlight.indexOf(d) === -1) highlight.push(d);\n        else highlight.splice(highlight.indexOf(d), 1);\n      } else highlight = [d];\n\n      if (\"nodeclick\" in opts) {\n        opts.nodeclick(d.data);\n        d3.selectAll(\".indi_rect\").style(\"opacity\", 0);\n        d3.selectAll(\".indi_rect\")\n          .filter(function (d) {\n            return highlight.indexOf(d) !== -1;\n          })\n          .style(\"opacity\", 0.5);\n      }\n    })\n    .on(\"mouseover\", function (e, d) {\n      e.stopPropagation();\n      last_mouseover = d;\n      if (dragging) {\n        if (\n          dragging.data.name !== last_mouseover.data.name &&\n          dragging.data.sex !== last_mouseover.data.sex\n        ) {\n          d3.select(this).select(\"rect\").style(\"opacity\", 0.2);\n        }\n        return;\n      }\n      d3.select(this).select(\"rect\").style(\"opacity\", 0.2);\n      d3.select(this)\n        .selectAll(\n          \".addchild, .addsibling, .addpartner, .addparents, .delete, .settings\"\n        )\n        .style(\"opacity\", 1);\n      d3.select(this).selectAll(\".indi_details\").style(\"opacity\", 0);\n\n      setLineDragPosition(\n        opts.symbol_size - 10,\n        0,\n        opts.symbol_size - 2,\n        0,\n        d.x + \",\" + (d.y + 2)\n      );\n    })\n    .on(\"mouseout\", function (d) {\n      if (dragging) return;\n\n      d3.select(this)\n        .selectAll(\n          \".addchild, .addsibling, .addpartner, .addparents, .delete, .settings\"\n        )\n        .style(\"opacity\", 0);\n      if (highlight.indexOf(d) === -1)\n        d3.select(this).select(\"rect\").style(\"opacity\", 0);\n      d3.select(this).selectAll(\".indi_details\").style(\"opacity\", 1);\n      // hide popup if it looks like the mouse is moving north\n      let xcoord = d3.pointer(d)[0];\n      let ycoord = d3.pointer(d)[1];\n      if (ycoord < 0.8 * opts.symbol_size)\n        d3.selectAll(\".popup_selection\").style(\"opacity\", 0);\n      if (!dragging) {\n        // hide popup if it looks like the mouse is moving north, south or west\n        if (\n          Math.abs(ycoord) > 0.25 * opts.symbol_size ||\n          Math.abs(ycoord) < -0.25 * opts.symbol_size ||\n          xcoord < 0.2 * opts.symbol_size\n        ) {\n          setLineDragPosition(0, 0, 0, 0);\n        }\n      }\n    });\n}\n\nfunction onDone(opts, dataset) {\n  // assign new dataset and rebuild pedigree\n  opts.dataset = dataset;\n  rebuild(opts);\n}\n\n// drag line between nodes to create partners\nfunction drag_handle(opts) {\n  let line_drag_selection = d3.select(\".diagram\");\n  let dline = line_drag_selection\n    .append(\"line\")\n    .attr(\"class\", \"line_drag_selection\")\n    .attr(\"stroke-width\", 6)\n    .style(\"stroke-dasharray\", \"2, 1\")\n    .attr(\"stroke\", \"black\")\n    .call(\n      d3.drag().on(\"start\", dragstart).on(\"drag\", drag).on(\"end\", dragstop)\n    );\n  dline.append(\"svg:title\").text(\"drag to create consanguineous partners\");\n\n  setLineDragPosition(0, 0, 0, 0);\n\n  function dragstart() {\n    dragging = last_mouseover;\n    d3.selectAll(\".line_drag_selection\").attr(\"stroke\", \"darkred\");\n  }\n\n  function dragstop(_d) {\n    if (\n      last_mouseover &&\n      dragging.data.name !== last_mouseover.data.name &&\n      dragging.data.sex !== last_mouseover.data.sex\n    ) {\n      // make partners\n      let child = {\n        name: utils.makeid(4),\n        sex: \"U\",\n        mother:\n          dragging.data.sex === \"F\"\n            ? dragging.data.name\n            : last_mouseover.data.name,\n        father:\n          dragging.data.sex === \"F\"\n            ? last_mouseover.data.name\n            : dragging.data.name,\n      };\n      let newdataset = utils.copy_dataset(opts.dataset);\n      opts.dataset = newdataset;\n\n      let idx = utils.getIdxByName(opts.dataset, dragging.data.name) + 1;\n      opts.dataset.splice(idx, 0, child);\n      rebuild(opts);\n    }\n    setLineDragPosition(0, 0, 0, 0);\n    d3.selectAll(\".line_drag_selection\").attr(\"stroke\", \"black\");\n    dragging = undefined;\n    return;\n  }\n\n  function drag(e) {\n    e.sourceEvent.stopPropagation();\n    let dx = e.dx;\n    let dy = e.dy;\n    let xnew = parseFloat(d3.select(this).attr(\"x2\")) + dx;\n    let ynew = parseFloat(d3.select(this).attr(\"y2\")) + dy;\n    setLineDragPosition(opts.symbol_size - 10, 0, xnew, ynew);\n  }\n}\n\n/**\n * Set the position and start and end of consanguineous widget.\n */\nfunction setLineDragPosition(x1, y1, x2, y2, translate) {\n  if (translate) {\n    d3.selectAll(\".line_drag_selection\").attr(\n      \"transform\",\n      \"translate(\" + translate + \")\"\n    );\n  }\n  d3.selectAll(\".line_drag_selection\")\n    .attr(\"x1\", x1)\n    .attr(\"y1\", y1)\n    .attr(\"x2\", x2)\n    .attr(\"y2\", y2);\n}\n\nfunction capitaliseFirstLetter(string) {\n  return string.charAt(0).toUpperCase() + string.slice(1);\n}\n\n// if opt.edit is set true (rather than given a function) this is called to edit node attributes\nfunction openEditDialog(opts, d) {\n  $(\"#node_properties\").dialog({\n    autoOpen: false,\n    title: d.data.display_name,\n    width: $(window).width() > 400 ? 450 : $(window).width() - 30,\n  });\n\n  let table = \"<table id='person_details' class='table'>\";\n\n  table +=\n    \"<tr><td style='text-align:right'>Unique ID</td><td><input class='form-control' type='text' id='id_name' name='name' value=\" +\n    (d.data.name ? d.data.name : \"\") +\n    \"></td></tr>\";\n  table +=\n    \"<tr><td style='text-align:right'>Name</td><td><input class='form-control' type='text' id='id_display_name' name='display_name' value=\" +\n    (d.data.display_name ? d.data.display_name : \"\") +\n    \"></td></tr>\";\n\n  table +=\n    \"<tr><td style='text-align:right'>Age</td><td><input class='form-control' type='number' id='id_age' min='0' max='120' name='age' style='width:7em' value=\" +\n    (d.data.age ? d.data.age : \"\") +\n    \"></td></tr>\";\n\n  table +=\n    \"<tr><td style='text-align:right'>Year Of Birth</td><td><input class='form-control' type='number' id='id_yob' min='1900' max='2050' name='yob' style='width:7em' value=\" +\n    (d.data.yob ? d.data.yob : \"\") +\n    \"></td></tr>\";\n\n  table +=\n    '<tr><td colspan=\"2\" id=\"id_sex\">' +\n    '<label class=\"radio-inline\"><input type=\"radio\" name=\"sex\" value=\"M\" ' +\n    (d.data.sex === \"M\" ? \"checked\" : \"\") +\n    \">Male</label>\" +\n    '<label class=\"radio-inline\"><input type=\"radio\" name=\"sex\" value=\"F\" ' +\n    (d.data.sex === \"F\" ? \"checked\" : \"\") +\n    \">Female</label>\" +\n    '<label class=\"radio-inline\"><input type=\"radio\" name=\"sex\" value=\"U\">Unknown</label>' +\n    \"</td></tr>\";\n\n  // alive status = 0; dead status = 1\n  table +=\n    '<tr><td colspan=\"2\" id=\"id_status\">' +\n    '<label class=\"checkbox-inline\"><input type=\"radio\" name=\"status\" value=\"0\" ' +\n    (parseInt(d.data.status) === 0 ? \"checked\" : \"\") +\n    \">&thinsp;Alive</label>\" +\n    '<label class=\"checkbox-inline\"><input type=\"radio\" name=\"status\" value=\"1\" ' +\n    (parseInt(d.data.status) === 1 ? \"checked\" : \"\") +\n    \">&thinsp;Deceased</label>\" +\n    \"</td></tr>\";\n  $(\"#id_status input[value='\" + d.data.status + \"']\").prop(\"checked\", true);\n\n  // switches\n  let switches = [\n    \"adopted_in\",\n    \"adopted_out\",\n    \"miscarriage\",\n    \"stillbirth\",\n    \"termination\",\n  ];\n\n  //\n  let exclude = [\n    \"children\",\n    \"name\",\n    \"parent_node\",\n    \"top_level\",\n    \"id\",\n    \"noparents\",\n    \"level\",\n    \"age\",\n    \"sex\",\n    \"status\",\n    \"display_name\",\n    \"mother\",\n    \"father\",\n    \"yob\",\n    \"mztwin\",\n    \"dztwin\",\n  ];\n  $.merge(exclude, switches);\n  table += '<tr><td colspan=\"2\"><strong>Age of Diagnosis:</strong></td></tr>';\n  $.each(opts.diseases, function (k, v) {\n    exclude.push(v.type + \"_diagnosis_age\");\n\n    let disease_colour =\n      '&thinsp;<span style=\"padding-left:5px;background:' +\n      opts.diseases[k].colour +\n      '\"></span>';\n    let diagnosis_age = d.data[v.type + \"_diagnosis_age\"];\n\n    table +=\n      \"<tr><td style='text-align:right'>\" +\n      capitaliseFirstLetter(v.type.replace(\"_\", \" \")) +\n      disease_colour +\n      \"&nbsp;</td><td>\" +\n      \"<input class='form-control' id='id_\" +\n      v.type +\n      \"_diagnosis_age_0' max='110' min='0' name='\" +\n      v.type +\n      \"_diagnosis_age_0' style='width:5em' type='number' value='\" +\n      (diagnosis_age !== undefined ? diagnosis_age : \"\") +\n      \"'></td></tr>\";\n  });\n\n  table += '<tr><td colspan=\"2\" style=\"line-height:1px;\"></td></tr>';\n  $.each(d.data, function (k, v) {\n    if ($.inArray(k, exclude) === -1) {\n      let kk = capitaliseFirstLetter(k);\n      if (v === true || v === false) {\n        table +=\n          \"<tr><td style='text-align:right'>\" +\n          kk +\n          \"&nbsp;</td><td><input type='checkbox' id='id_\" +\n          k +\n          \"' name='\" +\n          k +\n          \"' value=\" +\n          v +\n          \" \" +\n          (v ? \"checked\" : \"\") +\n          \"></td></tr>\";\n      } else if (k.length > 0) {\n        table +=\n          \"<tr><td style='text-align:right'>\" +\n          kk +\n          \"&nbsp;</td><td><input type='text' id='id_\" +\n          k +\n          \"' name='\" +\n          k +\n          \"' value=\" +\n          v +\n          \"></td></tr>\";\n      }\n    }\n  });\n  table += \"</table>\";\n\n  $(\"#node_properties\").html(table);\n  $(\"#node_properties\").dialog(\"open\");\n\n  $(\n    \"#node_properties input[type=radio], #node_properties input[type=checkbox], #node_properties input[type=text], #node_properties input[type=number]\"\n  ).change(function () {\n    save(opts);\n  });\n  return;\n}\n\n// add children to a given node\nexport function addchild(dataset, node, sex, nchild, twin_type) {\n  if (twin_type && $.inArray(twin_type, [\"mztwin\", \"dztwin\"]) === -1)\n    return new Error(\"INVALID TWIN TYPE SET: \" + twin_type);\n\n  if (typeof nchild === typeof undefined) nchild = 1;\n  let children = utils.getAllChildren(dataset, node);\n  let ptr_name, idx;\n  if (children.length === 0) {\n    let partner = addsibling(\n      dataset,\n      node,\n      node.sex === \"F\" ? \"M\" : \"F\",\n      node.sex === \"F\"\n    );\n    partner.noparents = true;\n    ptr_name = partner.name;\n    idx = utils.getIdxByName(dataset, node.name) + 1;\n  } else {\n    let c = children[0];\n    ptr_name = c.father === node.name ? c.mother : c.father;\n    idx = utils.getIdxByName(dataset, c.name);\n  }\n\n  let twin_id;\n  if (twin_type) twin_id = getUniqueTwinID(dataset, twin_type);\n  let newchildren = [];\n  for (let i = 0; i < nchild; i++) {\n    let child = {\n      name: utils.makeid(4),\n      sex: sex,\n      mother: node.sex === \"F\" ? node.name : ptr_name,\n      father: node.sex === \"F\" ? ptr_name : node.name,\n    };\n    dataset.splice(idx, 0, child);\n\n    if (twin_type) child[twin_type] = twin_id;\n    newchildren.push(child);\n  }\n  return newchildren;\n}\n\n//\nexport function addsibling(dataset, node, sex, add_lhs, twin_type) {\n  if (twin_type && $.inArray(twin_type, [\"mztwin\", \"dztwin\"]) === -1)\n    return new Error(\"INVALID TWIN TYPE SET: \" + twin_type);\n\n  let newbie = { name: utils.makeid(4), sex: sex };\n  if (node.top_level) {\n    newbie.top_level = true;\n  } else {\n    newbie.mother = node.mother;\n    newbie.father = node.father;\n  }\n  let idx = utils.getIdxByName(dataset, node.name);\n\n  if (twin_type) {\n    setMzTwin(dataset, dataset[idx], newbie, twin_type);\n  }\n\n  if (add_lhs) {\n    // add to LHS\n    if (idx > 0) idx--;\n  } else idx++;\n  dataset.splice(idx, 0, newbie);\n  return newbie;\n}\n\n// add parents to the 'node'\nexport function addparents(opts, dataset, name) {\n  let mother, father;\n  let root = utils.roots[opts.targetDiv];\n  let flat_tree = utils.flatten(root);\n  let tree_node = utils.getNodeByName(flat_tree, name);\n  let node = tree_node.data;\n  let depth = tree_node.depth; // depth of the node in relation to the root (depth = 1 is a top_level node)\n\n  let pid = -101;\n  let ptr_name;\n  let children = utils.getAllChildren(dataset, node);\n  if (children.length > 0) {\n    ptr_name =\n      children[0].mother === node.name\n        ? children[0].father\n        : children[0].mother;\n    pid = utils.getNodeByName(flat_tree, ptr_name).data.id;\n  }\n\n  let i;\n  if (depth === 1) {\n    mother = { name: utils.makeid(4), sex: \"F\", top_level: true };\n    father = { name: utils.makeid(4), sex: \"M\", top_level: true };\n    dataset.splice(0, 0, mother);\n    dataset.splice(0, 0, father);\n\n    for (i = 0; i < dataset.length; i++) {\n      if (\n        (dataset[i].top_level ||\n          utils.getDepth(dataset, dataset[i].name) === 2) &&\n        dataset[i].name !== mother.name &&\n        dataset[i].name !== father.name\n      ) {\n        delete dataset[i].top_level;\n        dataset[i].noparents = true;\n        dataset[i].mother = mother.name;\n        dataset[i].father = father.name;\n      }\n    }\n  } else {\n    let node_mother = utils.getNodeByName(flat_tree, tree_node.data.mother);\n    let node_father = utils.getNodeByName(flat_tree, tree_node.data.father);\n    let node_sibs = utils.getAllSiblings(dataset, node);\n\n    // lhs & rhs id's for siblings of this node\n    let rid = 10000;\n    let lid = tree_node.data.id;\n    for (i = 0; i < node_sibs.length; i++) {\n      let sid = utils.getNodeByName(flat_tree, node_sibs[i].name).data.id;\n      if (sid < rid && sid > tree_node.data.id) rid = sid;\n      if (sid < lid) lid = sid;\n    }\n    let add_lhs = lid >= tree_node.data.id || (pid === lid && rid < 10000);\n    if (opts.DEBUG)\n      console.log(\n        \"lid=\" +\n          lid +\n          \" rid=\" +\n          rid +\n          \" nid=\" +\n          tree_node.data.id +\n          \" ADD_LHS=\" +\n          add_lhs\n      );\n    let midx;\n    if (\n      (!add_lhs && node_father.data.id > node_mother.data.id) ||\n      (add_lhs && node_father.data.id < node_mother.data.id)\n    )\n      midx = utils.getIdxByName(dataset, node.father);\n    else midx = utils.getIdxByName(dataset, node.mother);\n\n    let parent = dataset[midx];\n    father = addsibling(dataset, parent, \"M\", add_lhs);\n    mother = addsibling(dataset, parent, \"F\", add_lhs);\n\n    let faidx = utils.getIdxByName(dataset, father.name);\n    let moidx = utils.getIdxByName(dataset, mother.name);\n    if (faidx > moidx) {\n      // switch to ensure father on lhs of mother\n      let tmpfa = dataset[faidx];\n      dataset[faidx] = dataset[moidx];\n      dataset[moidx] = tmpfa;\n    }\n\n    let orphans = utils.getAdoptedSiblings(dataset, node);\n    let nid = tree_node.data.id;\n    for (i = 0; i < orphans.length; i++) {\n      let oid = utils.getNodeByName(flat_tree, orphans[i].name).data.id;\n      if (opts.DEBUG)\n        console.log(\n          \"ORPHAN=\" +\n            i +\n            \" \" +\n            orphans[i].name +\n            \" \" +\n            (nid < oid && oid < rid) +\n            \" nid=\" +\n            nid +\n            \" oid=\" +\n            oid +\n            \" rid=\" +\n            rid\n        );\n      if ((add_lhs || nid < oid) && oid < rid) {\n        let oidx = utils.getIdxByName(dataset, orphans[i].name);\n        dataset[oidx].mother = mother.name;\n        dataset[oidx].father = father.name;\n      }\n    }\n  }\n\n  if (depth === 2) {\n    mother.top_level = true;\n    father.top_level = true;\n  } else if (depth > 2) {\n    mother.noparents = true;\n    father.noparents = true;\n  }\n  let idx = utils.getIdxByName(dataset, node.name);\n  dataset[idx].mother = mother.name;\n  dataset[idx].father = father.name;\n  delete dataset[idx].noparents;\n\n  if (\"parent_node\" in node) {\n    let ptr_node = dataset[utils.getIdxByName(dataset, ptr_name)];\n    if (\"noparents\" in ptr_node) {\n      ptr_node.mother = mother.name;\n      ptr_node.father = father.name;\n    }\n  }\n}\n\n// add partner\nexport function addpartner(opts, dataset, name) {\n  let root = utils.roots[opts.targetDiv];\n  let flat_tree = utils.flatten(root);\n  let tree_node = utils.getNodeByName(flat_tree, name);\n\n  let partner = addsibling(\n    dataset,\n    tree_node.data,\n    tree_node.data.sex === \"F\" ? \"M\" : \"F\",\n    tree_node.data.sex === \"F\"\n  );\n  partner.noparents = true;\n\n  let child = { name: utils.makeid(4), sex: \"M\" };\n  child.mother =\n    tree_node.data.sex === \"F\" ? tree_node.data.name : partner.name;\n  child.father =\n    tree_node.data.sex === \"F\" ? partner.name : tree_node.data.name;\n\n  let idx = utils.getIdxByName(dataset, tree_node.data.name) + 2;\n  dataset.splice(idx, 0, child);\n}\n\n// get adjacent nodes at the same depth\nfunction adjacent_nodes(root, node, excludes) {\n  let dnodes = utils.getNodesAtDepth(utils.flatten(root), node.depth, excludes);\n  let lhs_node, rhs_node;\n  for (let i = 0; i < dnodes.length; i++) {\n    if (dnodes[i].x < node.x) lhs_node = dnodes[i];\n    if (!rhs_node && dnodes[i].x > node.x) rhs_node = dnodes[i];\n  }\n  return [lhs_node, rhs_node];\n}\n\n// delete a node and descendants\nexport function delete_node_dataset(dataset, node, opts, onDone) {\n  let root = utils.roots[opts.targetDiv];\n  let fnodes = utils.flatten(root);\n  let deletes = [];\n  let i, j;\n\n  // get d3 data node\n  if (node.id === undefined) {\n    let d3node = utils.getNodeByName(fnodes, node.name);\n    if (d3node !== undefined) node = d3node.data;\n  }\n\n  if (node.parent_node) {\n    for (i = 0; i < node.parent_node.length; i++) {\n      let parent = node.parent_node[i];\n      let ps = [\n        utils.getNodeByName(dataset, parent.mother.name),\n        utils.getNodeByName(dataset, parent.father.name),\n      ];\n      // delete parents\n      for (j = 0; j < ps.length; j++) {\n        if (\n          ps[j].name === node.name ||\n          ps[j].noparents !== undefined ||\n          ps[j].top_level\n        ) {\n          dataset.splice(utils.getIdxByName(dataset, ps[j].name), 1);\n          deletes.push(ps[j]);\n        }\n      }\n\n      let children = parent.children;\n      let children_names = $.map(children, function (p, _i) {\n        return p.name;\n      });\n      for (j = 0; j < children.length; j++) {\n        let child = utils.getNodeByName(dataset, children[j].name);\n        if (child) {\n          child.noparents = true;\n          let ptrs = utils.get_partners(dataset, child);\n          let ptr;\n          if (ptrs.length > 0) ptr = utils.getNodeByName(dataset, ptrs[0]);\n          if (ptr && ptr.mother !== child.mother) {\n            child.mother = ptr.mother;\n            child.father = ptr.father;\n          } else if (ptr) {\n            let child_node = utils.getNodeByName(fnodes, child.name);\n            let adj = adjacent_nodes(root, child_node, children_names);\n            child.mother = adj[0]\n              ? adj[0].data.mother\n              : adj[1]\n              ? adj[1].data.mother\n              : null;\n            child.father = adj[0]\n              ? adj[0].data.father\n              : adj[1]\n              ? adj[1].data.father\n              : null;\n          } else {\n            dataset.splice(utils.getIdxByName(dataset, child.name), 1);\n          }\n        }\n      }\n    }\n  } else {\n    dataset.splice(utils.getIdxByName(dataset, node.name), 1);\n  }\n\n  // delete ancestors\n  console.log(deletes);\n  for (i = 0; i < deletes.length; i++) {\n    let del = deletes[i];\n    let sibs = utils.getAllSiblings(dataset, del);\n    console.log(\"DEL\", del.name, sibs);\n    if (sibs.length < 1) {\n      console.log(\"del sibs\", del.name, sibs);\n      let data_node = utils.getNodeByName(fnodes, del.name);\n      let ancestors = data_node.ancestors();\n      for (j = 0; j < ancestors.length; j++) {\n        console.log(ancestors[i]);\n        if (ancestors[j].data.mother) {\n          console.log(\n            \"DELETE \",\n            ancestors[j].data.mother,\n            ancestors[j].data.father\n          );\n          dataset.splice(\n            utils.getIdxByName(dataset, ancestors[j].data.mother.name),\n            1\n          );\n          dataset.splice(\n            utils.getIdxByName(dataset, ancestors[j].data.father.name),\n            1\n          );\n        }\n      }\n    }\n  }\n  // check integrity of mztwins settings\n  checkTwins(dataset);\n\n  let uc;\n  try {\n    // validate new pedigree dataset\n    let newopts = $.extend({}, opts);\n    newopts.dataset = utils.copy_dataset(dataset);\n    utils.validate_pedigree(newopts);\n    // check if pedigree is split\n    uc = utils.unconnected(dataset);\n  } catch (err) {\n    utils.messages(\n      \"Warning\",\n      \"Deletion of this pedigree member is disallowed.\"\n    );\n    throw err;\n  }\n  if (uc.length > 0) {\n    // check & warn only if this is a new split\n    if (utils.unconnected(opts.dataset).length === 0) {\n      console.error(\"individuals unconnected to pedigree \", uc);\n      utils.messages(\n        \"Warning\",\n        \"Deleting this will split the pedigree. Continue?\",\n        onDone,\n        opts,\n        dataset\n      );\n      return;\n    }\n  }\n\n  if (onDone) {\n    onDone(opts, dataset);\n  }\n  return dataset;\n}\n","/**\n/* © 2023 University of Cambridge\n/* SPDX-FileCopyrightText: 2023 University of Cambridge\n/* SPDX-License-Identifier: GPL-3.0-or-later\n**/\n\nimport {prefixInObj} from './utils.js';\n\nexport function addLabels(opts, node) {\n\t// names of individuals\n\taddLabel(opts, node, -(0.4 * opts.symbol_size), -(0.1 * opts.symbol_size),\n\t\t\tfunction(d) {\n\t\t\t\tif(opts.DEBUG)\n\t\t\t\t\treturn ('display_name' in d.data ? d.data.display_name : d.data.name) + '  ' + d.data.id;\n\t\t\t\treturn 'display_name' in d.data ? d.data.display_name : '';}, undefined, ['display_name']);\n\n\tlet font_size = parseInt(getPx(opts)) + 4;\n\t// display age/yob label first\n\tfor(let ilab=0; ilab<opts.labels.length; ilab++) {\n\t\tlet label = opts.labels[ilab];\n\t\tlet arr = (Array.isArray(label) ? label : [label]);\n\t\tif(arr.indexOf('age') > -1 || arr.indexOf('yob') > -1) {\n\t\t\taddLabel(opts, node, -opts.symbol_size,\n\t\t\t\tfunction(d) { return ypos(d, arr, font_size); },\n\t\t\t\tfunction(d) { return get_text(d, arr); }, 'indi_details', arr);\n\t\t}\n\t}\n\n\t// individuals disease details\n\tfor(let i=0;i<opts.diseases.length; i++) {\n\t\tlet disease = opts.diseases[i].type;\n\t\taddLabel(opts, node, -opts.symbol_size,\n\t\t\t\tfunction(d) { return ypos(d, [disease], font_size); },\n\t\t\t\tfunction(d) {\n\t\t\t\t\tlet dis = disease.replace('_', ' ').replace('cancer', 'ca.');\n\t\t\t\t\treturn disease+'_diagnosis_age' in d.data ? dis +\": \"+ d.data[disease+'_diagnosis_age'] : '';\n\t\t\t\t}, 'indi_details', [disease]);\n\t}\n\n\t// display other labels defined in opts.labels e.g. alleles/genotype data\n\tfor(let ilab=0; ilab<opts.labels.length; ilab++) {\n\t\tlet label = opts.labels[ilab];\n\t\tlet arr = (Array.isArray(label) ? label : [label]);\n\t\tif(arr.indexOf('age') === -1 && arr.indexOf('yob') === -1) {\n\t\t\taddLabel(opts, node, -opts.symbol_size,\n\t\t\t\tfunction(d) { return ypos(d, arr, font_size); },\n\t\t\t\tfunction(d) { return get_text(d, arr); }, 'indi_details', arr);\n\t\t}\n\t}\n}\n\nfunction get_text(d, arr) {\n\tlet txt = \"\";\n\tfor(let l=0; l<arr.length; l++) {\n\t\tlet this_label = arr[l];\n\t\tif(d.data[this_label]) {\n\t\t\tif(this_label === 'alleles') {\n\t\t\t\tlet vars = d.data.alleles.split(';');\n\t\t\t\tfor(let ivar = 0;ivar < vars.length;ivar++) {\n\t\t\t\t\tif(vars[ivar] !== \"\") txt += vars[ivar] + ';';\n\t\t\t\t}\n\t\t\t} else if(this_label === 'age') {\n\t\t\t\ttxt += d.data[this_label] +'y ';\n\t\t\t} else if(this_label === 'stillbirth') {\n\t\t\t\ttxt += \"SB\";\n\t\t\t} else if(this_label.match(\"_gene_test$\") && 'result' in d.data[this_label]) {\n\t\t\t\tlet r = d.data[this_label]['result'].toUpperCase();\n\t\t\t\t//let t = d.data[this_label]['type'];\n\t\t\t\tif(r !== \"-\") {\n\t\t\t\t\ttxt += this_label.replace('_gene_test', '').toUpperCase()\n\t\t\t\t\ttxt += (r === 'P' ? '+ ' : (r === 'N' ? '- ' : ' '));\n\t\t\t\t}\n\t\t\t} else if(this_label.match(\"_bc_pathology$\")) {\n\t\t\t\tlet r = d.data[this_label].toUpperCase();\n\t\t\t\ttxt += this_label.replace('_bc_pathology', '').toUpperCase()\n\t\t\t\ttxt += (r === 'P' ? '+ ' : (r === 'N' ? '- ' : ' '));\n\t\t\t} else {\n\t\t\t  txt += d.data[this_label];\n\t\t\t}\n\t\t}\n\t}\n\tif(txt !== \"\") return txt;\n}\n\nfunction ypos(d, arr, font_size) {\n\tif(!node_has_label(d, arr)) return;\n\td.y_offset = (!d.y_offset ? font_size*2.35 : d.y_offset+font_size);\n\treturn d.y_offset;\n}\n\nfunction node_has_label(d, labels) {\n\tfor(let l=0; l<labels.length; l++) {\n\t\tif(prefixInObj(labels[l], d.data)) return true;\n\t}\n\treturn false;\n}\n\n// add label to node\nfunction addLabel(opts, node, fx, fy, ftext, class_label, labels) {\n\tnode.filter(function (d) {\n\t\treturn !d.data.hidden && (!labels || node_has_label(d, labels));\n\t}).append(\"text\")\n\t.attr(\"class\", (class_label ? class_label + ' ped_label' : 'ped_label'))\n\t.attr(\"x\", fx)\n\t.attr(\"y\", fy)\n\t.attr(\"font-family\", opts.font_family)\n\t.attr(\"font-size\", opts.font_size)\n\t.attr(\"font-weight\", opts.font_weight)\n\t.text(ftext);\n}\n\n// get height in pixels\nfunction getPx(opts){\n\tlet emVal = opts.font_size;\n\tif (emVal === parseInt(emVal, 10)) // test if integer\n\t\treturn emVal;\n\n\tif(emVal.indexOf(\"px\") > -1)\n\t\treturn emVal.replace('px', '');\n\telse if(emVal.indexOf(\"em\") === -1)\n\t\treturn emVal;\n\temVal = parseFloat(emVal.replace('em', ''));\n\treturn (parseFloat(getComputedStyle($('#'+opts.targetDiv).get(0)).fontSize)*emVal)-1.0;\n}\n","/**\n/* © 2023 University of Cambridge\n/* SPDX-FileCopyrightText: 2023 University of Cambridge\n/* SPDX-License-Identifier: GPL-3.0-or-later\n**/\n\n// Pedigree Tree Builder\nimport  * as utils from './utils.js';\nimport * as pbuttons from './pbuttons.js';\nimport * as pedcache from './pedcache.js';\nimport * as io from './io.js';\nimport {addWidgets} from './widgets.js';\nimport {init_zoom} from './zoom.js';\nimport {addLabels} from './labels.js';\n\n\nexport function build(options) {\n\tlet opts = $.extend({ // defaults\n\t\ttargetDiv: 'pedigree_edit',\n\t\tdataset: [ {\"name\": \"m21\", \"display_name\": \"father\", \"sex\": \"M\", \"top_level\": true},\n\t\t\t\t   {\"name\": \"f21\", \"display_name\": \"mother\", \"sex\": \"F\", \"top_level\": true},\n\t\t\t\t   {\"name\": \"ch1\", \"display_name\": \"me\", \"sex\": \"F\", \"mother\": \"f21\", \"father\": \"m21\", \"proband\": true}],\n\t\twidth: 600,\n\t\theight: 400,\n\t\tsymbol_size: 35,\n\t\tzoomSrc: ['wheel', 'button'],\n\t\tzoomIn: 1.0,\n\t\tzoomOut: 1.0,\n\t\tdiseases: [\t{'type': 'breast_cancer', 'colour': '#F68F35'},\n\t\t\t\t\t{'type': 'breast_cancer2', 'colour': 'pink'},\n\t\t\t\t\t{'type': 'ovarian_cancer', 'colour': '#306430'},\n\t\t\t\t\t{'type': 'pancreatic_cancer', 'colour': '#4289BA'},\n\t\t\t\t\t{'type': 'prostate_cancer', 'colour': '#D5494A'}],\n\t\tlabels: ['stillbirth', ['age', 'yob'], 'alleles',\n\t\t\t\t\t\t\t   ['brca1_gene_test', 'brca2_gene_test', 'palb2_gene_test', 'chek2_gene_test', 'atm_gene_test'],\n\t\t\t\t\t\t\t   ['rad51d_gene_test', 'rad51c_gene_test', 'brip1_gene_test', 'hoxb13_gene_test'],\n\t\t\t\t\t\t\t   ['er_bc_pathology', 'pr_bc_pathology', 'her2_bc_pathology', 'ck14_bc_pathology', 'ck56_bc_pathology']],\n\t\tkeep_proband_on_reset: false,\n\t\tfont_size: '.75em',\n\t\tfont_family: 'Helvetica',\n\t\tfont_weight: 700,\n\t\tbackground: \"#FAFAFA\",\n\t\tnode_background: '#fdfdfd',\n\t\tvalidate: true,\n\t\tDEBUG: false}, options );\n\n\tif ( $( \"#fullscreen\" ).length === 0 ) {\n\t\t// add undo, redo, fullscreen buttons and event listeners once\n\t\tpbuttons.addButtons(opts, rebuild, build);\n\t\tio.addIO(opts);\n\t}\n\n\tif(pedcache.nstore(opts) === -1)\n\t\tpedcache.init_cache(opts);\n\n\tpbuttons.updateButtons(opts);\n\n\t// validate pedigree data\n\tutils.validate_pedigree(opts);\n\t// group top level nodes by partners\n\topts.dataset = group_top_level(opts.dataset);\n\n\tif(opts.DEBUG)\n\t\tutils.print_opts(opts);\n\tlet svg_dimensions = utils.get_svg_dimensions(opts);\n\tlet svg = d3.select(\"#\"+opts.targetDiv)\n\t\t\t\t .append(\"svg:svg\")\n\t\t\t\t .attr(\"width\", svg_dimensions.width)\n\t\t\t\t .attr(\"height\", svg_dimensions.height);\n\n\tsvg.append(\"rect\")\n\t\t.attr(\"width\", \"100%\")\n\t\t.attr(\"height\", \"100%\")\n\t\t.attr(\"rx\", 6)\n\t\t.attr(\"ry\", 6)\n\t\t.style(\"stroke\", \"darkgrey\")\n\t\t.style(\"fill\", opts.background) // or none\n\t\t.style(\"stroke-width\", 1);\n\n\tlet ped = svg.append(\"g\")\n\t\t\t .attr(\"class\", \"diagram\");\n\n\tlet top_level = $.map(opts.dataset, function(val, _i){return 'top_level' in val && val.top_level ? val : null;});\n\tlet hidden_root = {\n\t\tname : 'hidden_root',\n\t\tid : 0,\n\t\thidden : true,\n\t\tchildren : top_level\n\t};\n\n\tlet partners = utils.buildTree(opts, hidden_root, hidden_root)[0];\n\tlet root = d3.hierarchy(hidden_root);\n\tutils.roots[opts.targetDiv] = root;\n\n\t// / get score at each depth used to adjust node separation\n\tlet tree_dimensions = utils.get_tree_dimensions(opts);\n\tif(opts.DEBUG)\n\t\tconsole.log('opts.width='+svg_dimensions.width+' width='+tree_dimensions.width+\n\t\t\t\t\t' opts.height='+svg_dimensions.height+' height='+tree_dimensions.height);\n\n\tlet treemap = d3.tree().separation(function(a, b) {\n\t\treturn a.parent === b.parent || a.data.hidden || b.data.hidden ? 1.2 : 2.2;\n\t}).size([tree_dimensions.width, tree_dimensions.height]);\n\n\tlet nodes = treemap(root.sort(function(a, b) { return a.data.id - b.data.id; }));\n\tlet flattenNodes = nodes.descendants();\n\n\t// check the number of visible nodes equals the size of the pedigree dataset\n\tlet vis_nodes = $.map(opts.dataset, function(p, _i){return p.hidden ? null : p;});\n\tif(vis_nodes.length !== opts.dataset.length) {\n\t\tthrow utils.create_err('NUMBER OF VISIBLE NODES DIFFERENT TO NUMBER IN THE DATASET');\n\t}\n\n\tutils.adjust_coords(opts, nodes, flattenNodes);\n\n\tlet ptrLinkNodes = utils.linkNodes(flattenNodes, partners);\n\tcheck_ptr_links(opts, ptrLinkNodes);   // check for crossing of partner lines\n\n\tlet node = ped.selectAll(\".node\")\n\t\t\t\t  .data(nodes.descendants())\n\t\t\t\t  .enter()\n\t\t\t\t  .append(\"g\")\n\t\t\t\t\t.attr(\"transform\", function(d, _i) {\n\t\t\t\t\t\treturn \"translate(\" + d.x + \",\" + d.y + \")\";\n\t\t\t\t\t});\n\n\t// provide a border to the node\n\tnode.filter(function (d) {return !d.data.hidden;})\n\t\t.append(\"path\")\n\t\t.attr(\"shape-rendering\", \"geometricPrecision\")\n\t\t.attr(\"transform\", function(d) {return !has_gender(d.data.sex) && !(d.data.miscarriage || d.data.termination) ? \"rotate(45)\" : \"\";})\n\t\t.attr(\"d\", d3.symbol().size(function(_d) { return (opts.symbol_size * opts.symbol_size) + 2;})\n\t\t\t\t.type(function(d) {\n\t\t\t\t\tif(d.data.miscarriage || d.data.termination)\n\t\t\t\t\t\treturn d3.symbolTriangle;\n\t\t\t\t\treturn d.data.sex === \"F\" ? d3.symbolCircle : d3.symbolSquare;}))\n\t\t.style(\"stroke\", function (d) {\n\t\t\treturn d.data.age && d.data.yob && !d.data.exclude ? \"#303030\" : \"grey\";\n\t\t})\n\t\t.style(\"stroke-width\", function (d) {\n\t\t\treturn d.data.age && d.data.yob && !d.data.exclude ? \".3em\" : \".1em\";\n\t\t})\n\t\t.style(\"stroke-dasharray\", function (d) {return !d.data.exclude ? null : (\"3, 3\");})\n\t\t.style(\"fill\", \"none\");\n\n\t// set a clippath\n\tnode.filter(function (d) {return !(d.data.hidden && !opts.DEBUG);})\n\t\t.append(\"clipPath\")\n\t\t.attr(\"id\", function (d) {return d.data.name;}).append(\"path\")\n\t\t.attr(\"class\", \"node\")\n\t\t.attr(\"transform\", function(d) {return !has_gender(d.data.sex) && !(d.data.miscarriage || d.data.termination) ? \"rotate(45)\" : \"\";})\n\t\t.attr(\"d\", d3.symbol().size(function(d) {\n\t\t\t\tif (d.data.hidden)\n\t\t\t\t\treturn opts.symbol_size * opts.symbol_size / 5;\n\t\t\t\treturn opts.symbol_size * opts.symbol_size;\n\t\t\t})\n\t\t\t.type(function(d) {\n\t\t\t\tif(d.data.miscarriage || d.data.termination)\n\t\t\t\t\treturn d3.symbolTriangle;\n\t\t\t\treturn d.data.sex === \"F\" ? d3.symbolCircle :d3.symbolSquare;}));\n\n\t// pie plots for disease colours\n\tlet pienode = node.filter(function (d) {return !(d.data.hidden && !opts.DEBUG);}).selectAll(\"pienode\")\n\t   .data(function(d) {\t \t\t// set the disease data for the pie plot\n\t\t   let ncancers = 0;\n\t\t   let cancers = $.map(opts.diseases, function(_val, i){\n\t\t\t   if(utils.prefixInObj(opts.diseases[i].type, d.data)) {ncancers++; return 1;} else return 0;\n\t\t   });\n\t\t   if(ncancers === 0) cancers = [1];\n\t\t   return [$.map(cancers, function(val, _i){\n\t\t\t   return {'cancer': val, 'ncancers': ncancers, 'id': d.data.name,\n\t\t\t\t\t\t'sex': d.data.sex, 'proband': d.data.proband, 'hidden': d.data.hidden,\n\t\t\t\t\t\t'affected': d.data.affected,\n\t\t\t\t\t\t'exclude': d.data.exclude};})];\n\t   })\n\t   .enter()\n\t\t.append(\"g\");\n\n\tpienode.selectAll(\"path\")\n\t\t.data(d3.pie().value(function(d) {return d.cancer;}))\n\t\t.enter().append(\"path\")\n\t\t\t.attr(\"clip-path\", function(d) {return \"url(#\"+d.data.id+\")\";}) // clip the rectangle\n\t\t\t.attr(\"class\", \"pienode\")\n\t\t\t.attr(\"d\", d3.arc().innerRadius(0).outerRadius(opts.symbol_size))\n\t\t\t.style(\"fill\", function(d, i) {\n\t\t\t\tif(d.data.exclude)\n\t\t\t\t\treturn 'lightgrey';\n\t\t\t\tif(d.data.ncancers === 0) {\n\t\t\t\t\tif(d.data.affected)\n\t\t\t\t\t\treturn 'darkgrey';\n\t\t\t\t\treturn opts.node_background;\n\t\t\t\t}\n\t\t\t\treturn opts.diseases[i].colour;\n\t\t\t});\n\n\t// adopted in/out brackets\n\tnode.filter(function (d) {return !d.data.hidden && (d.data.adopted_in || d.data.adopted_out);})\n\t\t.append(\"path\")\n\t\t.attr(\"d\", function(_d) {\n\t\t\tlet dx = -(opts.symbol_size * 0.66);\n\t\t\tlet dy = -(opts.symbol_size * 0.64);\n\t\t\tlet indent = opts.symbol_size/4;\n\t\t\treturn get_bracket(dx, dy, indent, opts)+get_bracket(-dx, dy, -indent, opts);\n\t\t\t})\n\t\t.style(\"stroke\", function (d) {\n\t\t\treturn d.data.age && d.data.yob && !d.data.exclude ? \"#303030\" : \"grey\";\n\t\t})\n\t\t.style(\"stroke-width\", function (_d) {\n\t\t\treturn \".1em\";\n\t\t})\n\t\t.style(\"stroke-dasharray\", function (d) {return !d.data.exclude ? null : (\"3, 3\");})\n\t\t.style(\"fill\", \"none\");\n\n\n\t// alive status = 0; dead status = 1\n\tnode.filter(function (d) {return d.data.status === \"1\" || d.data.status === 1;})\n\t\t.append('line')\n\t\t\t.style(\"stroke\", \"black\")\n\t\t\t.attr(\"x1\", function(_d, _i) {return -0.6*opts.symbol_size;})\n\t\t\t.attr(\"y1\", function(_d, _i) {return 0.6*opts.symbol_size;})\n\t\t\t.attr(\"x2\", function(_d, _i) {return 0.6*opts.symbol_size;})\n\t\t\t.attr(\"y2\", function(_d, _i) {return -0.6*opts.symbol_size;});\n\n/*\n * let warn = node.filter(function (d) { return (!d.data.age || !d.data.yob) && !d.data.hidden; }).append(\"text\") .attr('font-family', 'FontAwesome')\n * .attr(\"x\", \".25em\") .attr(\"y\", -(0.4 * opts.symbol_size), -(0.2 * opts.symbol_size)) .html(\"\\uf071\"); warn.append(\"svg:title\").text(\"incomplete\");\n */\n\t// add display names and labels defined by opts.labels\n\taddLabels(opts, node);\n\n\t//\n\taddWidgets(opts, node);\n\n\t// links between partners\n\tlet clash_depth = {};\n\n\t// get path looping over node(s)\n\tlet draw_path = function(clash, dx, dy1, dy2, parent_node, cshift) {\n\t\tlet extend = function(i, l) {\n\t\t\tif(i+1 < l)   // && Math.abs(clash[i] - clash[i+1]) < (opts.symbol_size*1.25)\n\t\t\t\treturn extend(++i);\n\t\t\treturn i;\n\t\t};\n\t\tlet path = \"\";\n\t\tfor(let j=0; j<clash.length; j++) {\n\t\t\tlet k = extend(j, clash.length);\n\t\t\tlet dx1 = clash[j] - dx - cshift;\n\t\t\tlet dx2 = clash[k] + dx + cshift;\n\t\t\tif(parent_node.x > dx1 && parent_node.x < dx2)\n\t\t\t\tparent_node.y = dy2;\n\n\t\t\tpath += \"L\" + dx1 + \",\" +  (dy1 - cshift) +\n\t\t\t\t\t\"L\" + dx1 + \",\" +  (dy2 - cshift) +\n\t\t\t\t\t\"L\" + dx2 + \",\" +  (dy2 - cshift) +\n\t\t\t\t\t\"L\" + dx2 + \",\" +  (dy1 - cshift);\n\t\t\tj = k;\n\t\t}\n\t\treturn path;\n\t}\n\n\n\tpartners = ped.selectAll(\".partner\")\n\t\t.data(ptrLinkNodes)\n\t\t.enter()\n\t\t\t.insert(\"path\", \"g\")\n\t\t\t.attr(\"fill\", \"none\")\n\t\t\t.attr(\"stroke\", \"#000\")\n\t\t\t.attr(\"shape-rendering\", \"auto\")\n\t\t\t.attr('d', function(d, _i) {\n\t\t\t\tlet node1 = utils.getNodeByName(flattenNodes, d.mother.data.name);\n\t\t\t\tlet node2 = utils.getNodeByName(flattenNodes, d.father.data.name);\n\t\t\t\tlet consanguity = utils.consanguity(node1, node2, opts);\n\t\t\t\tlet divorced = (d.mother.data.divorced &&  d.mother.data.divorced === d.father.data.name);\n\n\t\t\t\tlet x1 = (d.mother.x < d.father.x ? d.mother.x : d.father.x);\n\t\t\t\tlet x2 = (d.mother.x < d.father.x ? d.father.x : d.mother.x);\n\t\t\t\tlet dy1 = d.mother.y;\n\t\t\t\tlet dy2, dx, parent_node;\n\n\t\t\t\t// identify clashes with other nodes at the same depth\n\t\t\t\tlet clash = check_ptr_link_clashes(opts, d);\n\t\t\t\tlet path = \"\";\n\t\t\t\tif(clash) {\n\t\t\t\t\tif(d.mother.depth in clash_depth)\n\t\t\t\t\t\tclash_depth[d.mother.depth] += 4;\n\t\t\t\t\telse\n\t\t\t\t\t\tclash_depth[d.mother.depth] = 4;\n\n\t\t\t\t\tdy1 -= clash_depth[d.mother.depth];\n\t\t\t\t\tdx = clash_depth[d.mother.depth] + (opts.symbol_size/2) + 2;\n\n\t\t\t\t\tlet parent_nodes = d.mother.data.parent_node;\n\t\t\t\t\tlet parent_node_name = parent_nodes[0];\n\t\t\t\t\tfor(let ii=0; ii<parent_nodes.length; ii++) {\n\t\t\t\t\t\tif(parent_nodes[ii].father.name === d.father.data.name &&\n\t\t\t\t\t\t   parent_nodes[ii].mother.name === d.mother.data.name)\n\t\t\t\t\t\t\tparent_node_name = parent_nodes[ii].name;\n\t\t\t\t\t}\n\t\t\t\t\tparent_node = utils.getNodeByName(flattenNodes, parent_node_name);\n\t\t\t\t\tparent_node.y = dy1; // adjust hgt of parent node\n\t\t\t\t\tclash.sort(function (a,b) {return a - b;});\n\n\t\t\t\t\tdy2 = (dy1-(opts.symbol_size/2)-3);\n\t\t\t\t\tpath = draw_path(clash, dx, dy1, dy2, parent_node, 0);\n\t\t\t\t}\n\n\t\t\t\tlet divorce_path = \"\";\n\t\t\t\tif(divorced && !clash)\n\t\t\t\t\tdivorce_path = \"M\" + (x1+((x2-x1)*.66)+6) + \",\" + (dy1-6) +\n\t\t\t\t\t\t\t\t   \"L\"+  (x1+((x2-x1)*.66)-6) + \",\" + (dy1+6) +\n\t\t\t\t\t\t\t\t   \"M\" + (x1+((x2-x1)*.66)+10) + \",\" + (dy1-6) +\n\t\t\t\t\t\t\t\t   \"L\"+  (x1+((x2-x1)*.66)-2)  + \",\" + (dy1+6);\n\t\t\t\tif(consanguity) {  // consanguinous, draw double line between partners\n\t\t\t\t\tdy1 = (d.mother.x < d.father.x ? d.mother.y : d.father.y);\n\t\t\t\t\tdy2 = (d.mother.x < d.father.x ? d.father.y : d.mother.y);\n\n\t\t\t\t\tlet cshift = 3;\n\t\t\t\t\tif(Math.abs(dy1-dy2) > 0.1) {\t  // DIFFERENT LEVEL\n\t\t\t\t\t\treturn\t\"M\" + x1 + \",\" + dy1 + \"L\" + x2 + \",\" + dy2 +\n\t\t\t\t\t\t\t\t\"M\" + x1 + \",\" + (dy1 - cshift) + \"L\" + x2 + \",\" + (dy2 - cshift);\n\t\t\t\t\t} else {\t\t\t\t\t\t   // SAME LEVEL\n\t\t\t\t\t\tlet path2 = (clash ? draw_path(clash, dx, dy1, dy2, parent_node, cshift) : \"\");\n\t\t\t\t\t\treturn\t\"M\" + x1 + \",\" + dy1 + path + \"L\" + x2 + \",\" + dy1 +\n\t\t\t\t\t\t\t\t\"M\" + x1 + \",\" + (dy1 - cshift) + path2 + \"L\" + x2 + \",\" + (dy1 - cshift) + divorce_path;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\treturn\t\"M\" + x1 + \",\" + dy1 + path + \"L\" + x2 + \",\" + dy1 + divorce_path;\n\t\t\t});\n\n\t// links to children\n\tped.selectAll(\".link\")\n\t\t.data(root.links(nodes.descendants()))\n\t\t.enter()\n\t\t\t.filter(function (d) {\n\t\t\t\t// filter unless debug is set\n\t\t\t\treturn (opts.DEBUG ||\n\t\t\t\t\t\t(d.target.data.noparents === undefined && d.source.parent !== null && !d.target.data.hidden));\n\t\t\t})\n\t\t\t.insert(\"path\", \"g\")\n\t\t\t.attr(\"fill\", \"none\")\n\t\t\t.attr(\"stroke-width\", function(d, _i) {\n\t\t\t\tif(d.target.data.noparents !== undefined || d.source.parent === null || d.target.data.hidden)\n\t\t\t\t\treturn 1;\n\t\t\t\treturn (opts.DEBUG ? 2 : 1);\n\t\t\t})\n\t\t\t.attr(\"stroke\", function(d, _i) {\n\t\t\t\tif(d.target.data.noparents !== undefined || d.source.parent === null || d.target.data.hidden)\n\t\t\t\t\treturn 'pink';\n\t\t\t\treturn \"#000\";\n\t\t\t})\n\t\t\t.attr(\"stroke-dasharray\", function(d, _i) {\n\t\t\t\tif(!d.target.data.adopted_in) return null;\n\t\t\t\tlet dash_len = Math.abs(d.source.y-((d.source.y + d.target.y) / 2));\n\t\t\t\tlet dash_array = [dash_len, 0, Math.abs(d.source.x-d.target.x), 0];\n\t\t\t\tlet twins = utils.getTwins(opts.dataset, d.target.data);\n\t\t\t\tif(twins.length >= 1) dash_len = dash_len * 3;\n\t\t\t\tfor(let usedlen = 0; usedlen < dash_len; usedlen += 10)\n\t\t\t\t\t$.merge(dash_array, [5, 5]);\n\t\t\t\treturn dash_array;\n\t\t\t})\n\t\t\t.attr(\"shape-rendering\", function(d, _i) {\n\t\t\t\tif(d.target.data.mztwin || d.target.data.dztwin)\n\t\t\t\t\treturn \"geometricPrecision\";\n\t\t\t\treturn \"auto\";\n\t\t\t})\n\t\t\t.attr(\"d\", function(d, _i) {\n\t\t\t\tif(d.target.data.mztwin || d.target.data.dztwin) {\n\t\t\t\t\t// get twin position\n\t\t\t\t\tlet twins = utils.getTwins(opts.dataset, d.target.data);\n\t\t\t\t\tif(twins.length >= 1) {\n\t\t\t\t\t\tlet twinx = 0;\n\t\t\t\t\t\tlet xmin = d.target.x;\n\t\t\t\t\t\t//let xmax = d.target.x;\n\t\t\t\t\t\tfor(let t=0; t<twins.length; t++) {\n\t\t\t\t\t\t\tlet thisx = utils.getNodeByName(flattenNodes, twins[t].name).x;\n\t\t\t\t\t\t\tif(xmin > thisx) xmin = thisx;\n\t\t\t\t\t\t\t//if(xmax < thisx) xmax = thisx;\n\t\t\t\t\t\t\ttwinx += thisx;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tlet xmid = ((d.target.x + twinx) / (twins.length+1));\n\t\t\t\t\t\tlet ymid = ((d.source.y + d.target.y) / 2);\n\n\t\t\t\t\t\tlet xhbar = \"\";\n\t\t\t\t\t\tif(xmin === d.target.x && d.target.data.mztwin) {\n\t\t\t\t\t\t\t// horizontal bar for mztwins\n\t\t\t\t\t\t\tlet xx = (xmid + d.target.x)/2;\n\t\t\t\t\t\t\tlet yy = (ymid + (d.target.y-(opts.symbol_size/2)))/2;\n\t\t\t\t\t\t\txhbar = \"M\" + xx + \",\" + yy +\n\t\t\t\t\t\t\t\t\t\"L\" + (xmid + (xmid-xx)) + \" \" + yy;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\treturn \"M\" + (d.source.x) + \",\" + (d.source.y ) +\n\t\t\t\t\t\t\t   \"V\" + ymid +\n\t\t\t\t\t\t\t   \"H\" + xmid +\n\t\t\t\t\t\t\t   \"L\" + (d.target.x) + \" \" + (d.target.y-(opts.symbol_size/2)) +\n\t\t\t\t\t\t\t   xhbar;\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tif(d.source.data.mother) {   // check parents depth to see if they are at the same level in the tree\n\t\t\t\t\tlet ma = utils.getNodeByName(flattenNodes, d.source.data.mother.name);\n\t\t\t\t\tlet pa = utils.getNodeByName(flattenNodes, d.source.data.father.name);\n\n\t\t\t\t\tif(ma.depth !== pa.depth) {\n\t\t\t\t\t\treturn \"M\" + (d.source.x) + \",\" + ((ma.y + pa.y) / 2) +\n\t\t\t\t\t\t\t   \"H\" + (d.target.x) +\n\t\t\t\t\t\t\t   \"V\" + (d.target.y);\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\treturn \"M\" + (d.source.x) + \",\" + (d.source.y ) +\n\t\t\t\t\t   \"V\" + ((d.source.y + d.target.y) / 2) +\n\t\t\t\t\t   \"H\" + (d.target.x) +\n\t\t\t\t\t   \"V\" + (d.target.y);\n\t\t\t});\n\n\t// draw proband arrow\n\tlet probandIdx  = utils.getProbandIndex(opts.dataset);\n\tif(typeof probandIdx !== 'undefined') {\n\t\tlet probandNode = utils.getNodeByName(flattenNodes, opts.dataset[probandIdx].name);\n\t\tlet triid = \"triangle\"+utils.makeid(3);\n\t\tped.append(\"svg:defs\").append(\"svg:marker\")\t// arrow head\n\t\t\t.attr(\"id\", triid)\n\t\t\t.attr(\"refX\", 6)\n\t\t\t.attr(\"refY\", 6)\n\t\t\t.attr(\"markerWidth\", 20)\n\t\t\t.attr(\"markerHeight\", 20)\n\t\t\t.attr(\"orient\", \"auto\")\n\t\t\t.append(\"path\")\n\t\t\t.attr(\"d\", \"M 0 0 12 6 0 12 3 6\")\n\t\t\t.style(\"fill\", \"black\");\n\n\t\tped.append(\"line\")\n\t\t\t.attr(\"x1\", probandNode.x-(opts.symbol_size/0.7))\n\t\t\t.attr(\"y1\", probandNode.y+(opts.symbol_size/1.4))\n\t\t\t.attr(\"x2\", probandNode.x-(opts.symbol_size/1.4))\n\t\t\t.attr(\"y2\", probandNode.y+(opts.symbol_size/4))\n\t\t\t.attr(\"stroke-width\", 1)\n\t\t\t.attr(\"stroke\", \"black\")\n\t\t\t.attr(\"marker-end\", \"url(#\"+triid+\")\");\n\t}\n\n\t// drag and zoom\n\tinit_zoom(opts, svg);\n\treturn opts;\n}\n\nfunction has_gender(sex) {\n\treturn sex === \"M\" || sex === \"F\";\n}\n\n//adopted in/out brackets\nfunction get_bracket(dx, dy, indent, opts) {\n\treturn \t\"M\" + (dx+indent) + \",\" + dy +\n\t\t\t\"L\" + dx + \" \" + dy +\n\t\t\t\"L\" + dx + \" \" + (dy+(opts.symbol_size *  1.28)) +\n\t\t\t\"L\" + dx + \" \" + (dy+(opts.symbol_size *  1.28)) +\n\t\t\t\"L\" + (dx+indent) + \",\" + (dy+(opts.symbol_size *  1.28))\n}\n\n// check for crossing of partner lines\nfunction check_ptr_links(opts, ptrLinkNodes){\n\tfor(let a=0; a<ptrLinkNodes.length; a++) {\n\t\tlet clash = check_ptr_link_clashes(opts, ptrLinkNodes[a]);\n\t\tif(clash)\n\t\t\tconsole.log(\"CLASH :: \"+ptrLinkNodes[a].mother.data.name+\" \"+ptrLinkNodes[a].father.data.name, clash);\n\t}\n}\n\nexport function check_ptr_link_clashes(opts, anode) {\n\tlet root = utils.roots[opts.targetDiv];\n\tlet flattenNodes = utils.flatten(root);\n\tlet mother, father;\n\tif('name' in anode) {\n\t\tanode = utils.getNodeByName(flattenNodes, anode.name);\n\t\tif(!('mother' in anode.data))\n\t\t\treturn null;\n\t\tmother = utils.getNodeByName(flattenNodes, anode.data.mother);\n\t\tfather = utils.getNodeByName(flattenNodes, anode.data.father);\n\t} else {\n\t\tmother = anode.mother;\n\t\tfather = anode.father;\n\t}\n\n\tlet x1 = (mother.x < father.x ? mother.x : father.x);\n\tlet x2 = (mother.x < father.x ? father.x : mother.x);\n\tlet dy = mother.y;\n\n\t// identify clashes with other nodes at the same depth\n\tlet clash = $.map(flattenNodes, function(bnode, _i){\n\t\treturn !bnode.data.hidden &&\n\t\t\t\tbnode.data.name !== mother.data.name &&  bnode.data.name !== father.data.name &&\n\t\t\t\tbnode.y === dy && bnode.x > x1 && bnode.x < x2 ? bnode.x : null;\n\t});\n\treturn clash.length > 0 ? clash : null;\n}\n\n// group top_level nodes by their partners\nfunction group_top_level(dataset) {\n\t// let top_level = $.map(dataset, function(val, i){return 'top_level' in val && val.top_level ? val : null;});\n\t// calculate top_level nodes\n\tfor(let i=0;i<dataset.length;i++) {\n\t\tif(utils.getDepth(dataset, dataset[i].name) === 2)\n\t\t\tdataset[i].top_level = true;\n\t}\n\n\tlet top_level = [];\n\tlet top_level_seen = [];\n\tfor(let i=0;i<dataset.length;i++) {\n\t\tlet node = dataset[i];\n\t\tif('top_level' in node && $.inArray(node.name, top_level_seen) === -1){\n\t\t\ttop_level_seen.push(node.name);\n\t\t\ttop_level.push(node);\n\t\t\tlet ptrs = utils.get_partners(dataset, node);\n\t\t\tfor(let j=0; j<ptrs.length; j++){\n\t\t\t\tif($.inArray(ptrs[j], top_level_seen) === -1) {\n\t\t\t\t\ttop_level_seen.push(ptrs[j]);\n\t\t\t\t\ttop_level.push(utils.getNodeByName(dataset, ptrs[j]));\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\tlet newdataset = $.map(dataset, function(val, _i){return 'top_level' in val && val.top_level ? null : val;});\n\tfor (let i = top_level.length; i > 0; --i)\n\t\tnewdataset.unshift(top_level[i-1]);\n\treturn newdataset;\n}\n\nexport function rebuild(opts) {\n\t$(\"#\"+opts.targetDiv).empty();\n\tpedcache.init_cache(opts);\n\ttry {\n\t\tbuild(opts);\n\t} catch(e) {\n\t\tconsole.error(e);\n\t\tthrow e;\n\t}\n\n\ttry {\n\t\ttemplates.update(opts);\t\t// eslint-disable-line no-undef\n\t} catch(e) {\n\t\t// templates not declared\n\t}\n}\n","/**\n/* Functions used by 3rd party apps\n/*\n/* © 2023 University of Cambridge\n/* SPDX-FileCopyrightText: 2023 University of Cambridge\n/* SPDX-License-Identifier: GPL-3.0-or-later\n**/\n\nimport {copy_dataset, getNodeByName, getProbandIndex} from './utils.js';\nimport {rebuild} from './pedigree.js';\nimport {delete_node_dataset} from './widgets.js';\nimport {addchild} from './widgets.js';\nimport {syncTwins} from './twins.js';\nimport * as pedcache from './pedcache.js';\n\n\n// Set or remove node attributes.\n// If a value is not provided the attribute is removed.\n// 'key' can be a list of keys or a single key.\nexport function node_attr(opts, name, keys, value){\n\tlet newdataset = copy_dataset(pedcache.current(opts));\n\tlet node = getNodeByName(newdataset, name);\n\tif(!node){\n\t\tconsole.warn(\"No person defined\");\n\t\treturn;\n\t}\n\n\tif(!$.isArray(keys)) {\n\t\tkeys = [keys];\n\t}\n\n\tif(value) {\n\t\tfor(let i=0; i<keys.length; i++) {\n\t\t\tlet k = keys[i];\n\t\t\t//console.log('VALUE PROVIDED', k, value, (k in node));\n\t\t\tif(k in node && keys.length === 1) {\n\t\t\t\tif(node[k] === value)\n\t\t\t\t\treturn;\n\t\t\t\ttry {\n\t\t\t\t   if(JSON.stringify(node[k]) === JSON.stringify(value))\n\t\t\t\t\t   return;\n\t\t\t\t} catch(e){\n\t\t\t\t\t// continue regardless of error\n\t\t\t\t}\n\t\t\t}\n\t\t\tnode[k] = value;\n\t\t}\n\t} else {\n\t\tlet found = false;\n\t\tfor(let i=0; i<keys.length; i++) {\n\t\t\tlet k = keys[i];\n\t\t\t//console.log('NO VALUE PROVIDED', k, (k in node));\n\t\t\tif(k in node) {\n\t\t\t\tdelete node[k];\n\t\t\t\tfound = true;\n\t\t\t}\n\t\t}\n\t\tif(!found)\n\t\t\treturn;\n\t}\n\tsyncTwins(newdataset, node);\n\topts.dataset = newdataset;\n\trebuild(opts);\n}\n\n// Set or remove proband attributes.\n// If a value is not provided the attribute is removed from the proband.\n// 'key' can be a list of keys or a single key.\nexport function proband_attr(opts, keys, value){\n\tlet proband = opts.dataset[ getProbandIndex(opts.dataset) ];\n\tnode_attr(opts, proband.name, keys, value);\n}\n\n// add a child to the proband; giveb sex, age, yob and breastfeeding months (optional)\nexport function proband_add_child(opts, sex, age, yob, breastfeeding){\n\tlet newdataset = copy_dataset(pedcache.current(opts));\n\tlet proband = newdataset[ getProbandIndex(newdataset) ];\n\tif(!proband){\n\t\tconsole.warn(\"No proband defined\");\n\t\treturn;\n\t}\n\tlet newchild = addchild(newdataset, proband, sex, 1)[0];\n\tnewchild.age = age;\n\tnewchild.yob = yob;\n\tif(breastfeeding !== undefined)\n\t\tnewchild.breastfeeding = breastfeeding;\n\topts.dataset = newdataset;\n\trebuild(opts);\n\treturn newchild.name;\n}\n\n// delete node using the name\nexport function delete_node_by_name(opts, name){\n\tfunction onDone(opts, dataset) {\n\t\t// assign new dataset and rebuild pedigree\n\t\topts.dataset = dataset;\n\t\trebuild(opts);\n\t}\n\tlet newdataset = copy_dataset(pedcache.current(opts));\n\tlet node = getNodeByName(pedcache.current(opts), name);\n\tif(!node){\n\t\tconsole.warn(\"No node defined\");\n\t\treturn;\n\t}\n\tdelete_node_dataset(newdataset, node, opts, onDone);\n}\n"],"names":["max_limit","dict_cache","has_browser_storage","opts","store_type","undefined","mod","localStorage","setItem","removeItem","e","get_prefix","btn_target","get_arr","get_browser_store","item","getItem","sessionStorage","set_browser_store","name","clear_pedigree_data","prefix","store","items","i","length","key","indexOf","push","get_count","count","set_count","init_cache","dataset","JSON","stringify","console","warn","nstore","current","parse","previous","nst","next","parseInt","clear","clear_browser_store","setposition","x","y","zoom","zoomName","getposition","pos","parseFloat","it","arr","roots","create_err","err","error","Error","validate_pedigree","validate","DEBUG","log","call","this","display_name","uniquenames","famids","p","hidden","mother","father","midx","getIdxByName","fidx","sex","$","inArray","famid","join","uc","unconnected","copy_dataset","id","sort","a","b","disallowed","newdataset","obj","prefixInObj","found","each","k","_n","messages","title","msg","onConfirm","dialog","modal","width","buttons","Yes","No","text","click","errModalEl","document","getElementById","modalTitle","querySelector","modalBodyInput","removeClass","on","off","cancelBtn","hasClass","addClass","textContent","showDialog","makeid","len","possible","charAt","Math","floor","random","buildTree","person","root","partnerLinks","children","getChildren","nodes","flatten","partners","_i","child","_j","m","getNodeByName","f","contains_parent","merge","ptr","parent","setChildrenId","gp","gmidx","gfidx","get_grandparents_idx","updateParent","parent_node","mztwin","dztwins","twins","getTwins","twin","dztwin","isProband","attr","combineArrays","arr1","arr2","include_children","connected","get_partners","getAllChildren","_child_idx","anode","ptrs","bnode","target","getProbandIndex","change","ii","nconnect","_idx","has_parent","noparents","names","map","val","proband","sibs","getSiblings","twin_type","getAllSiblings","getAdoptedSiblings","getDepth","idx","depth","top_level","getNodesAtDepth","fnodes","exclude_names","data","linkNodes","flattenNodes","links","ancestors","node","recurse","consanguity","node1","node2","ancestors1","ancestors2","names1","ancestor","names2","_index","flat","forEach","adjust_coords","xmid","overlap","descendants","diff","child1","child2","descendantsNames","descendant","nodesOverlap","xnew","n","abs","symbol_size","print_opts","remove","append","is_fullscreen","fullscreenElement","mozFullScreenElement","webkitFullscreenElement","msFullscreenElement","get_svg_dimensions","window","innerWidth","height","innerHeight","get_tree_dimensions","svg_dimensions","maxscore","generation","score","max_depth","Object","keys","string","toUpperCase","slice","pedcache","time","d","Date","getHours","getMinutes","getSeconds","getFullYear","getMonth","getDate","navigator","userAgent","match","ua","is_proband","results","RegExp","exec","location","href","age","yob","status","year","sum","zm","init_zoom","svg","xi","yi","d3","scaleExtent","zoomIn","zoomOut","filter","zoomSrc","type","button","transform","t","ped","select","targetDiv","zooming","xyk","zoomIdentity","scale","translate","btn_zoom","transition","duration","scaleBy","scale_to_fit","get_bounds","wid","xmax","xmin","hgt","ymax","ymin","get_dimensions","size","w","clientWidth","h","clientHeight","get_svg_size","max","get_pedigree_center","translateTo","setTimeout","scaleTo","Number","MAX_VALUE","sym","selectAll","g_elm","dg","getBBox","text_elements","_groups","txtsize","getTextSize","firstChild","nodeValue","font_family","font_size","getNodeSize","txt","font","fontSize","o","css","position","float","visibility","appendTo","s","addButtons","options","extend","btns","fa","lis","_e","local_dataset","rebuild","exitFullscreen","msExitFullscreen","mozCancelFullScreen","webkitExitFullscreen","requestFullscreen","documentElement","mozRequestFullScreen","webkitRequestFullscreen","Element","ALLOW_KEYBOARD_INPUT","msRequestFullscreen","timeoutId","setInterval","clearInterval","stopPropagation","empty","build","reset","trigger","addPbuttonEvents","keep_proband_on_reset","cancers","breast_cancer","breast_cancer2","ovarian_cancer","prostate_cancer","pancreatic_cancer","genetic_test1","genetic_test2","genetic_test4","pathology_tests","RISK_FACTOR_STORE","hasInput","trim","isEmpty","myObj","prototype","hasOwnProperty","get_prs_values","prs","alpha","zscore","percent","getGeneticTest","version","readCanRisk","boadicea_lines","lines","split","hdr","regexp","gt","ncol","ln","ops","j","replace","delim","indi","cancer","diagnosis_age","ashkenazi","gene_test","result","path_test","unshift","localeCompare","get_mdensity","mdensity","test","get_pedigree","meta","isanon","arguments","ethnicity","isInteger","toString","excl","exclude","probandIdx","pedigree_util","menarche","get_risk_factor","parity","first_birth","oc_use","mht_use","bmi","alcohol","menopause","tl","endo","cmsg","risk_factor_name","store_name","pathname","el","pop","get_surgical_ops","breast_cancer_prs","ovarian_cancer_prs","prostate_cancer_prs","addIO","files","reader","FileReader","onload","load_data","onerror","event","utils","code","readAsText","value","load","async","content","fname","save_file","iname","csv","img","userId","response","fetch","method","headers","body","ok","json","save","print","get_printable_svg","svg_download","img_download","copyStylesInline","destinationNode","sourceNode","containerElements","cd","childNodes","tagName","style","currentStyle","getComputedStyle","st","setProperty","getPropertyValue","resolution","img_type","Promise","resolve","reject","deferred","svg2img","find","when","apply","done","grep","startsWith","createElement","download","appendChild","removeChild","deferred_name","defaults","iscanvg","copy","get","cloneNode","Deferred","svgStr","XMLSerializer","serializeToString","imgsrc","btoa","unescape","encodeURIComponent","canvas","context","getContext","fillStyle","fillRect","drawImage","toDataURL","clearRect","src","promise","unique_urls","svg_html","matches","str","myRegexp","c","lastIndex","index","getMatches","quote","m1","m2","newval","svg_div","clone","a4","html","constructor","Array","cssFiles","printWindow","open","headContent","write","close","focus","filename","jsonArray","csvRows","row","values","jsonToCSV","file","Blob","msSaveOrOpenBlob","url","URL","createObjectURL","revokeObjectURL","canrisk_validation","risk_factors","readBoadiceaV4","canrisk_data","readCanRiskFile","to_process","process_ped","readLinkage","err1","message","acc_FamHist_ticked","acc_FamHist_Leave","RESULT","FLAG_FAMILY_MODAL","err3","err2","affected","alleles","_cancer","getLevel","updated","l","prt_lvl","level","fix_n_balance_levels","max_level","pidx","getPartnerIdx","update_parents_level","parents","ma","pa","svg_node","d3obj","getUniqueTwinID","mz","splice","syncTwins","d1","d2","updateStatus","update_ashkn","is","pedcache_current","switches","iswitch","update_cancer_by_sex","approx_diagnosis_age","substring","round5","checked","tres","hoxb13_result","valid","update_diagnosis_age_widget","prop","hide","show","ovarian_cancer_diagnosis_age","closest","prostate_cancer_diagnosis_age","x1","x2","round","dragging","last_mouseover","addWidgets","popup_selection","square_title","circle_title","add_person","classed","datum","addsibling","addchild","highlight","dragstart","dragstop","_d","setLineDragPosition","drag","sourceEvent","dx","dy","ynew","drag_handle","fx","fy","widgets","addpartner","addparents","delete","styles","fill","edit","settings","widget","parentNode","opt","autoOpen","table","diseases","v","disease_colour","colour","capitaliseFirstLetter","kk","openEditDialog","delete_node_dataset","onDone","ctrlKey","nodeclick","xcoord","pointer","ycoord","y1","y2","nchild","ptr_name","twin_id","partner","newchildren","add_lhs","newbie","setMzTwin","flat_tree","tree_node","pid","node_mother","node_father","node_sibs","rid","lid","sid","faidx","moidx","tmpfa","orphans","nid","oid","oidx","ptr_node","adjacent_nodes","excludes","lhs_node","rhs_node","dnodes","deletes","d3node","ps","children_names","adj","del","twin_types","checkTwins","newopts","addLabels","addLabel","emVal","getPx","ilab","labels","label","isArray","ypos","get_text","disease","dis","this_label","vars","ivar","r","node_has_label","y_offset","ftext","class_label","font_weight","background","node_background","pbuttons","io","top_level_seen","group_top_level","hidden_root","hierarchy","tree_dimensions","tree","separation","treemap","ptrLinkNodes","clash","check_ptr_link_clashes","check_ptr_links","enter","has_gender","miscarriage","termination","symbol","symbolTriangle","symbolCircle","symbolSquare","pienode","ncancers","_val","pie","arc","innerRadius","outerRadius","adopted_in","adopted_out","indent","get_bracket","clash_depth","draw_path","dy1","dy2","cshift","path","dx1","dx2","insert","divorced","parent_nodes","parent_node_name","divorce_path","source","dash_len","dash_array","usedlen","twinx","thisx","ymid","xhbar","xx","yy","probandNode","triid","templates","update","node_attr","breastfeeding","newchild"],"mappings":"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"}